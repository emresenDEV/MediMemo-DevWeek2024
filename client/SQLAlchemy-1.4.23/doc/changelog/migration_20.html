<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">



<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

        <title>
            
    
    Migrating to SQLAlchemy 2.0
 &mdash;
    SQLAlchemy 1.4 Documentation

        </title>

        
            <!-- begin iterate through site-imported + sphinx environment css_files -->
                <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../_static/default.css" type="text/css" />
                <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
                <link rel="stylesheet" href="../_static/changelog.css" type="text/css" />
                <link rel="stylesheet" href="../_static/sphinx_paramlinks.css" type="text/css" />
            <!-- end iterate through site-imported + sphinx environment css_files -->
        

        

    

    <!-- begin layout.mako headers -->

    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
        <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="SQLAlchemy 1.4 Documentation" href="../index.html" />
        <link rel="up" title="Changes and Migration" href="index.html" />
        <link rel="next" title="1.4 Changelog" href="changelog_14.html" />
        <link rel="prev" title="What’s New in SQLAlchemy 1.4?" href="migration_14.html" />
    <!-- end layout.mako headers -->


    </head>
    <body>
        
















<div id="docs-container">





<div id="docs-top-navigation-container" class="body-background">
<div id="docs-header">
    <div id="docs-version-header">
        Release: <span class="version-num">1.4.23</span>


        | Release Date: August 18, 2021

    </div>

    <h1><a href="../index.html">SQLAlchemy 1.4 Documentation</a></h1>

</div>
</div>

<div id="docs-body-container">

    <div id="fixed-sidebar" class="withsidebar">


        <div id="docs-sidebar-popout">
            <h3><a href="../index.html">SQLAlchemy 1.4 Documentation</a></h3>
            <p id="sidebar-topnav">
                <a href="../contents.html">Contents</a> |
                <a href="../genindex.html">Index</a>
            </p>

            <div id="sidebar-search">
                <form class="search" action="../search.html" method="get">
                  <label>
                  Search terms:
                  <input type="text" placeholder="search..." name="q" size="12" />
                  </label>
                  <input type="hidden" name="check_keywords" value="yes" />
                  <input type="hidden" name="area" value="default" />
                </form>
            </div>

        </div>

        <div id="docs-sidebar">

        <div id="sidebar-banner">
            
        </div>

        <div id="docs-sidebar-inner">

        
        <h3>
            <a href="index.html" title="Changes and Migration">Changes and Migration</a>
        </h3>

        <ul>
<li><span class="link-container"><a class="reference external" href="migration_14.html">What’s New in SQLAlchemy 1.4?</a></span></li>
<li class="selected"><span class="link-container"><strong>Migrating to SQLAlchemy 2.0</strong><a class="paramlink headerlink reference internal" href="#">¶</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#overview">Overview</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#first-prerequisite-step-one-a-working-1-3-application">First Prerequisite, step one - A Working 1.3 Application</a></span></li>
<li><span class="link-container"><a class="reference external" href="#first-prerequisite-step-two-a-working-1-4-application">First Prerequisite, step two - A Working 1.4 Application</a></span></li>
<li><span class="link-container"><a class="reference external" href="#migration-to-2-0-step-one-python-3-only-python-3-6-minimum">Migration to 2.0 Step One - Python 3 only (Python 3.6 minimum)</a></span></li>
<li><span class="link-container"><a class="reference external" href="#migration-to-2-0-step-two-turn-on-removedin20warnings">Migration to 2.0 Step Two - Turn on RemovedIn20Warnings</a></span></li>
<li><span class="link-container"><a class="reference external" href="#migration-to-2-0-step-three-resolve-all-removedin20warnings">Migration to 2.0 Step Three - Resolve all RemovedIn20Warnings</a></span></li>
<li><span class="link-container"><a class="reference external" href="#migration-to-2-0-step-four-use-the-future-flag-on-engine">Migration to 2.0 Step Four - Use the <code class="docutils literal notranslate"><span class="pre">future</span></code> flag on Engine</a></span></li>
<li><span class="link-container"><a class="reference external" href="#migration-to-2-0-step-four-use-the-future-flag-on-session">Migration to 2.0 Step Four - Use the <code class="docutils literal notranslate"><span class="pre">future</span></code> flag on Session</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#migration-core-connection-transaction">2.0 Migration - Core Connection / Transaction</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#library-level-but-not-driver-level-autocommit-removed-from-both-core-and-orm">Library-level (but not driver level) “Autocommit” removed from both Core and ORM</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#driver-level-autocommit-remains-available">Driver-level autocommit remains available</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#implicit-and-connectionless-execution-bound-metadata-removed">“Implicit” and “Connectionless” execution, “bound metadata” removed</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#many-choices-becomes-one-choice">Many Choices becomes One Choice</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#execute-method-more-strict-execution-options-are-more-prominent">execute() method more strict, execution options are more prominent</a></span></li>
<li><span class="link-container"><a class="reference external" href="#result-rows-act-like-named-tuples">Result rows act like named tuples</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#migration-core-usage">2.0 Migration - Core Usage</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#select-no-longer-accepts-varied-constructor-arguments-columns-are-passed-positionally">select() no longer accepts varied constructor arguments, columns are passed positionally</a></span></li>
<li><span class="link-container"><a class="reference external" href="#insert-update-delete-dml-no-longer-accept-keyword-constructor-arguments">insert/update/delete DML no longer accept keyword constructor arguments</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#migration-orm-configuration">2.0 Migration - ORM Configuration</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#declarative-becomes-a-first-class-api">Declarative becomes a first class API</a></span></li>
<li><span class="link-container"><a class="reference external" href="#the-original-mapper-function-now-a-core-element-of-declarative-renamed">The original “mapper()” function now a core element of Declarative, renamed</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#migration-orm-usage">2.0 Migration - ORM Usage</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#orm-query-unified-with-core-select">ORM Query Unified with Core Select</a></span></li>
<li><span class="link-container"><a class="reference external" href="#orm-query-get-method-moves-to-session">ORM Query - get() method moves to Session</a></span></li>
<li><span class="link-container"><a class="reference external" href="#orm-query-joining-loading-on-relationships-uses-attributes-not-strings">ORM Query  - Joining / loading on relationships uses attributes, not strings</a></span></li>
<li><span class="link-container"><a class="reference external" href="#orm-query-chaining-using-lists-of-attributes-rather-than-individual-calls-removed">ORM Query - Chaining using lists of attributes, rather than individual calls, removed</a></span></li>
<li><span class="link-container"><a class="reference external" href="#orm-query-join-aliased-true-from-joinpoint-removed">ORM Query - join(…, aliased=True), from_joinpoint removed</a></span></li>
<li><span class="link-container"><a class="reference external" href="#using-distinct-with-additional-columns-but-only-select-the-entity">Using DISTINCT with additional columns, but only select the entity</a></span></li>
<li><span class="link-container"><a class="reference external" href="#selecting-from-the-query-itself-as-a-subquery-e-g-from-self">Selecting from the query itself as a subquery, e.g. “from_self()”</a></span></li>
<li><span class="link-container"><a class="reference external" href="#selecting-entities-from-alternative-selectables-query-select-entity-from">Selecting entities from alternative selectables; Query.select_entity_from()</a></span></li>
<li><span class="link-container"><a class="reference external" href="#orm-rows-not-uniquified-by-default">ORM Rows not uniquified by default</a></span></li>
<li><span class="link-container"><a class="reference external" href="#autocommit-mode-removed-from-session-autobegin-support-added">Autocommit mode removed from Session; autobegin support added</a></span></li>
<li><span class="link-container"><a class="reference external" href="#session-subtransaction-behavior-removed">Session “subtransaction” behavior removed</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#migration-orm-extension-and-recipe-changes">2.0 Migration - ORM Extension and Recipe Changes</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#dogpile-cache-recipe-and-horizontal-sharding-uses-new-session-api">Dogpile cache recipe and Horizontal Sharding uses new Session API</a></span></li>
<li><span class="link-container"><a class="reference external" href="#baked-query-extension-superseded-by-built-in-caching">Baked Query Extension Superseded by built-in caching</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#asyncio-support">Asyncio Support</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="changelog_14.html">1.4 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_13.html">1.3 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_12.html">1.2 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_11.html">1.1 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_10.html">1.0 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_09.html">0.9 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_08.html">0.8 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_07.html">0.7 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_06.html">0.6 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_05.html">0.5 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_04.html">0.4 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_03.html">0.3 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_02.html">0.2 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="changelog_01.html">0.1 Changelog</a></span></li>
<li><span class="link-container"><a class="reference external" href="migration_13.html">What’s New in SQLAlchemy 1.3?</a></span></li>
<li><span class="link-container"><a class="reference external" href="migration_12.html">What’s New in SQLAlchemy 1.2?</a></span></li>
<li><span class="link-container"><a class="reference external" href="migration_11.html">What’s New in SQLAlchemy 1.1?</a></span></li>
<li><span class="link-container"><a class="reference external" href="migration_10.html">What’s New in SQLAlchemy 1.0?</a></span></li>
<li><span class="link-container"><a class="reference external" href="migration_09.html">What’s New in SQLAlchemy 0.9?</a></span></li>
<li><span class="link-container"><a class="reference external" href="migration_08.html">What’s New in SQLAlchemy 0.8?</a></span></li>
<li><span class="link-container"><a class="reference external" href="migration_07.html">What’s New in SQLAlchemy 0.7?</a></span></li>
<li><span class="link-container"><a class="reference external" href="migration_06.html">What’s New in SQLAlchemy 0.6?</a></span></li>
<li><span class="link-container"><a class="reference external" href="migration_05.html">What’s new in SQLAlchemy 0.5?</a></span></li>
<li><span class="link-container"><a class="reference external" href="migration_04.html">What’s new in SQLAlchemy 0.4?</a></span></li>
</ul>



        </div>

        </div>

    </div>

    

    <div id="docs-body" class="withsidebar changelog-migration_20" >
        
<section id="migrating-to-sqlalchemy-2-0">
<span id="migration-20-toplevel"></span><h1>Migrating to SQLAlchemy 2.0<a class="headerlink" href="#migrating-to-sqlalchemy-2-0" title="Permalink to this headline">¶</a></h1>
<div class="admonition-about-this-document admonition">
<p class="admonition-title">About this document</p>
<p>SQLAlchemy 2.0 presents a major shift for a wide variety of key
SQLAlchemy usage patterns in both the Core and ORM components.   The goal
of this release is to make a slight readjustment in some of the most
fundamental assumptions of SQLAlchemy since its early beginnings, and to
deliver a newly streamlined usage model that is hoped to be significantly
more minimalist and consistent between the Core and ORM components, as well
as more capable.   The move of Python to be Python 3 only as well as the
emergence of gradual typing systems for Python 3 are the initial
inspirations for this shift, as is the changing nature of the Python
community which now includes not just hardcore database programmers but a
vast new community of data scientists and students of many different
disciplines.</p>
<p>SQLAlchemy started with Python 2.3 which had no context managers, no
function decorators, Unicode as a second class feature, and a variety of
other shortcomings that would be unknown today.  The biggest changes in
SQLAlchemy 2.0 are targeting the residual assumptions left over from this
early period in SQLAlchemy’s development as well as the leftover artifacts
resulting from the incremental  introduction of key API features such as
<a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.query.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a>  and Declarative. It also hopes standardize some
newer capabilities that have proven to be very effective.</p>
</div>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The SQLAlchemy 2.0 transition presents itself in the SQLAlchemy 1.4 release as
a series of steps that allow an application of any size or complexity to be
migrated to SQLAlchemy 2.0 using a gradual, iterative process.  Lessons learned
from the Python 2 to Python 3 transition have inspired a system that intends to
as great a degree as possible to not require any “breaking” changes, or any
change that would need to be made universally or not at all.</p>
<p>As a means of both proving the 2.0 architecture as well as allowing a fully
iterative transition environment, the entire scope of 2.0’s new APIs and
features are present and available within the 1.4 series; this includes
major new areas of functionality such as the SQL caching system, the new ORM
statement execution model, new transactional paradigms for both ORM and Core, a
new ORM declarative system that unifies classical and declarative mapping,
support for Python dataclasses, and asyncio support for Core and ORM.</p>
<p>The steps to achieve 2.0 migration are in the following subsections; overall,
the general strategy is that once an application runs on 1.4 with all
warning flags turned on and does not emit any 2.0-deprecation warnings, it is
now cross-compatible with SQLAlchemy 2.0.</p>
<section id="first-prerequisite-step-one-a-working-1-3-application">
<h3>First Prerequisite, step one - A Working 1.3 Application<a class="headerlink" href="#first-prerequisite-step-one-a-working-1-3-application" title="Permalink to this headline">¶</a></h3>
<p>The first step is getting an existing application onto 1.4, in the case of
a typical non trivial application, is to ensure it runs on SQLAlchemy 1.3 with
no deprecation warnings.   Release 1.4 does have a few changes linked to
conditions that warn in previous version, including some warnings that were
introduced in 1.3, in particular some changes to the behavior of the
<a class="reference internal" href="../orm/relationship_api.html#sqlalchemy.orm.relationship.params.viewonly" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.viewonly</span></code></a> and
<a class="reference internal" href="../orm/relationship_api.html#sqlalchemy.orm.relationship.params.sync_backref" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.sync_backref</span></code></a> flags.</p>
<p>For best results, the application should be able to run, or pass all of its
tests, with the latest SQLAlchemy 1.3 release with no SQLAlchemy deprecation
warnings; these are warnings emitted for the <a class="reference internal" href="../core/exceptions.html#sqlalchemy.exc.SADeprecationWarning" title="sqlalchemy.exc.SADeprecationWarning"><code class="xref py py-class docutils literal notranslate"><span class="pre">SADeprecationWarning</span></code></a>
class.</p>
</section>
<section id="first-prerequisite-step-two-a-working-1-4-application">
<h3>First Prerequisite, step two - A Working 1.4 Application<a class="headerlink" href="#first-prerequisite-step-two-a-working-1-4-application" title="Permalink to this headline">¶</a></h3>
<p>Once the application is good to go on SQLAlchemy 1.3, the next step is to get
it running on SQLAlchemy 1.4.  In the vast majority of cases, applications
should run without problems from SQLAlchemy 1.3 to 1.4.   However, it’s always
the case between any 1.x and 1.y release, APIs and behaviors have changed
either subtly or in some cases a little less subtly, and the SQLAlchemy
project always gets a good deal of regression reports for the first few
months.</p>
<p>The 1.x-&gt;1.y release process usually has a few changes around the margins
that are a little bit more dramatic and are based around use cases that are
expected to be very seldom if at all used.   For 1.4, the changes identified
as being in this realm are as follows:</p>
<ul class="simple">
<li><p><a class="reference internal" href="migration_14.html#change-5526"><span class="std std-ref">The URL object is now immutable</span></a> - this impacts code that would be manipulating the
<a class="reference internal" href="../core/engines.html#sqlalchemy.engine.URL" title="sqlalchemy.engine.URL"><code class="xref py py-class docutils literal notranslate"><span class="pre">URL</span></code></a> object and may impact code that makes use of the
<a class="reference internal" href="../core/connections.html#sqlalchemy.engine.CreateEnginePlugin" title="sqlalchemy.engine.CreateEnginePlugin"><code class="xref py py-class docutils literal notranslate"><span class="pre">CreateEnginePlugin</span></code></a> extension point.   This is an uncommon
case but may affect in particular some test suites that are making use of
special database provisioning logic.   A github search for code that uses
the relatively new and little-known <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.CreateEnginePlugin" title="sqlalchemy.engine.CreateEnginePlugin"><code class="xref py py-class docutils literal notranslate"><span class="pre">CreateEnginePlugin</span></code></a>
class found two projects that were unaffected by the change.</p></li>
<li><p><a class="reference internal" href="migration_14.html#change-4617"><span class="std std-ref">A SELECT statement is no longer implicitly considered to be a FROM clause</span></a> - this change may impact code that was somehow relying
upon behavior that was mostly unusable in the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a> construct,
where it would create unnamed subqueries that were usually confusing and
non-working.  These subqueries would be rejected by most databases in any
case as a name is usually required except on SQLite, however it is possible
some applications will need to adjust some queries that are inadvertently
relying upon this.</p></li>
<li><p><a class="reference internal" href="migration_14.html#change-select-join"><span class="std std-ref">select().join() and outerjoin() add JOIN criteria to the current query, rather than creating a subquery</span></a> - somewhat related, the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a> class
featured <code class="docutils literal notranslate"><span class="pre">.join()</span></code> and <code class="docutils literal notranslate"><span class="pre">.outerjoin()</span></code> methods that implicitly created a
subquery and then returned a <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Join" title="sqlalchemy.sql.expression.Join"><code class="xref py py-class docutils literal notranslate"><span class="pre">Join</span></code></a> construct, which again would
be mostly useless and produced lots of confusion.  The decision was made to
move forward with the vastly more useful 2.0-style join-building approach
where these methods now work the same way as the ORM <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query.join" title="sqlalchemy.orm.Query.join"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.join()</span></code></a>
method.</p></li>
<li><p><a class="reference internal" href="migration_14.html#change-deferred-construction"><span class="std std-ref">Many Core and ORM statement objects now perform much of their construction and validation in the compile phase</span></a> - some error messages related to
construction of a <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> or <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a> may not be
emitted until compilation / execution, rather than at construction time.
This might impact some test suites that are testing against failure modes.</p></li>
</ul>
<p>For the full overview of SQLAlchemy 1.4 changes, see the
<a class="reference internal" href="migration_14.html"><span class="doc">What’s New in SQLAlchemy 1.4?</span></a> document.</p>
</section>
<section id="migration-to-2-0-step-one-python-3-only-python-3-6-minimum">
<h3>Migration to 2.0 Step One - Python 3 only (Python 3.6 minimum)<a class="headerlink" href="#migration-to-2-0-step-one-python-3-only-python-3-6-minimum" title="Permalink to this headline">¶</a></h3>
<p>SQLAlchemy 2.0 was first inspired by the fact that Python 2’s EOL was in
2020.   SQLAlchemy is taking a longer period of time than other major
projects to drop Python 2.7 support, since it is not too much in the way
of things for the moment.   However, version 2.0 hopes to start embracing
<span class="target" id="index-0"></span><a class="pep reference external" href="https://www.python.org/dev/peps/pep-0484"><strong>PEP 484</strong></a> and other new features to a great degree, so it is likely
that release 1.4 will be the last Python 2 supporting version, even if
there is a SQLAlchemy 1.5 (which is also unlikely at the moment).</p>
<p>In order to use SQLAlchemy 2.0, the application will need to be runnable on
at least <strong>Python 3.6</strong> as of this writing.  SQLAlchemy 1.4 now supports
Python 3.6 or newer within the Python 3 series; throughout the 1.4 series,
the application can remain running on Python 2.7 or on at least Python 3.6.</p>
</section>
<section id="migration-to-2-0-step-two-turn-on-removedin20warnings">
<span id="migration-20-deprecations-mode"></span><h3>Migration to 2.0 Step Two - Turn on RemovedIn20Warnings<a class="headerlink" href="#migration-to-2-0-step-two-turn-on-removedin20warnings" title="Permalink to this headline">¶</a></h3>
<p>SQLAlchemy 1.4 features a conditional deprecation warning system inspired
by the Python “-3” flag that would indicate legacy patterns in a running
application.   For SQLAlchemy 1.4, the <a class="reference internal" href="../core/exceptions.html#sqlalchemy.exc.RemovedIn20Warning" title="sqlalchemy.exc.RemovedIn20Warning"><code class="xref py py-class docutils literal notranslate"><span class="pre">RemovedIn20Warning</span></code></a>
deprecation class is emitted only when an environment variable
<code class="docutils literal notranslate"><span class="pre">SQLALCHEMY_WARN_20</span></code> is set to either of <code class="docutils literal notranslate"><span class="pre">true</span></code> or <code class="docutils literal notranslate"><span class="pre">1</span></code>.</p>
<p>Given the example program below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">select</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">table</span>


<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;sqlite://&quot;</span><span class="p">)</span>

<span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE TABLE foo (id integer)&quot;</span><span class="p">)</span>
<span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO foo (id) VALUES (1)&quot;</span><span class="p">)</span>


<span class="n">foo</span> <span class="o">=</span> <span class="n">table</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="n">column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">))</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">select</span><span class="p">([</span><span class="n">foo</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">]))</span>

<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span></pre></div>
</div>
<p>The above program uses several patterns that many users will already identify
as “legacy”, namely the use of the <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Engine.execute" title="sqlalchemy.engine.Engine.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Engine.execute()</span></code></a> method
that’s part of the <a class="reference internal" href="../core/connections.html#dbengine-implicit"><span class="std std-ref">connectionless execution</span></a>
system.  When we run the above program against 1.4, it returns a single line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python test3.py
[(1,)]</pre></div>
</div>
<p>To enable “2.0 deprecations mode”, we enable the <code class="docutils literal notranslate"><span class="pre">SQLALCHEMY_WARN_20=1</span></code>
variable, and additionally ensure that a <a class="reference external" href="https://docs.python.org/3/library/warnings.html#the-warnings-filter">warnings filter</a> that will not
suppress any warnings is selected:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SQLALCHEMY_WARN_20</span><span class="o">=</span><span class="mi">1</span> <span class="n">python</span> <span class="o">-</span><span class="n">W</span> <span class="n">always</span><span class="p">::</span><span class="ne">DeprecationWarning</span> <span class="n">test3</span><span class="o">.</span><span class="n">py</span></pre></div>
</div>
<p>Since the reported warning location is not always in the correct place, locating
the offending code may be difficult without the full stacktrace. This can be achieved
by transforming the warnings to exceptions by specifying the <code class="docutils literal notranslate"><span class="pre">error</span></code> warning filter,
using Python option <code class="docutils literal notranslate"><span class="pre">-W</span> <span class="pre">error::DeprecationWarning</span></code>.</p>
<p>With warnings turned on, our program now has a lot to say:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ SQLALCHEMY_WARN_20=1 python2 -W always::DeprecationWarning test3.py
test3.py:9: RemovedIn20Warning: The Engine.execute() function/method is considered legacy as of the 1.x series of SQLAlchemy and will be removed in 2.0. All statement execution in SQLAlchemy 2.0 is performed by the Connection.execute() method of Connection, or in the ORM by the Session.execute() method of Session. (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
  engine.execute(&quot;CREATE TABLE foo (id integer)&quot;)
/home/classic/dev/sqlalchemy/lib/sqlalchemy/engine/base.py:2856: RemovedIn20Warning: Passing a string to Connection.execute() is deprecated and will be removed in version 2.0.  Use the text() construct, or the Connection.exec_driver_sql() method to invoke a driver-level SQL string. (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
  return connection.execute(statement, *multiparams, **params)
/home/classic/dev/sqlalchemy/lib/sqlalchemy/engine/base.py:1639: RemovedIn20Warning: The current statement is being autocommitted using implicit autocommit.Implicit autocommit will be removed in SQLAlchemy 2.0.   Use the .begin() method of Engine or Connection in order to use an explicit transaction for DML and DDL statements. (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
  self._commit_impl(autocommit=True)
test3.py:10: RemovedIn20Warning: The Engine.execute() function/method is considered legacy as of the 1.x series of SQLAlchemy and will be removed in 2.0. All statement execution in SQLAlchemy 2.0 is performed by the Connection.execute() method of Connection, or in the ORM by the Session.execute() method of Session. (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
  engine.execute(&quot;INSERT INTO foo (id) VALUES (1)&quot;)
/home/classic/dev/sqlalchemy/lib/sqlalchemy/engine/base.py:2856: RemovedIn20Warning: Passing a string to Connection.execute() is deprecated and will be removed in version 2.0.  Use the text() construct, or the Connection.exec_driver_sql() method to invoke a driver-level SQL string. (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
  return connection.execute(statement, *multiparams, **params)
/home/classic/dev/sqlalchemy/lib/sqlalchemy/engine/base.py:1639: RemovedIn20Warning: The current statement is being autocommitted using implicit autocommit.Implicit autocommit will be removed in SQLAlchemy 2.0.   Use the .begin() method of Engine or Connection in order to use an explicit transaction for DML and DDL statements. (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
  self._commit_impl(autocommit=True)
/home/classic/dev/sqlalchemy/lib/sqlalchemy/sql/selectable.py:4271: RemovedIn20Warning: The legacy calling style of select() is deprecated and will be removed in SQLAlchemy 2.0.  Please use the new calling style described at select(). (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
  return cls.create_legacy_select(*args, **kw)
test3.py:14: RemovedIn20Warning: The Engine.execute() function/method is considered legacy as of the 1.x series of SQLAlchemy and will be removed in 2.0. All statement execution in SQLAlchemy 2.0 is performed by the Connection.execute() method of Connection, or in the ORM by the Session.execute() method of Session. (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
  result = engine.execute(select([foo.c.id]))
[(1,)]</pre></div>
</div>
<p>With the above guidance, we can migrate our program to use 2.0 styles, and
as a bonus our program is much clearer:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">column</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">select</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">table</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">text</span>


<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;sqlite://&quot;</span><span class="p">)</span>

<span class="c1"># don&#39;t rely on autocommit for DML and DDL</span>
<span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
    <span class="c1"># use connection.execute(), not engine.execute()</span>
    <span class="c1"># use the text() construct to execute textual SQL</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;CREATE TABLE foo (id integer)&quot;</span><span class="p">))</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;INSERT INTO foo (id) VALUES (1)&quot;</span><span class="p">))</span>


<span class="n">foo</span> <span class="o">=</span> <span class="n">table</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="n">column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">))</span>

<span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
    <span class="c1"># use connection.execute(), not engine.execute()</span>
    <span class="c1"># select() now accepts column / table expressions positionally</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">foo</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span></pre></div>
</div>
<p>The goal of “2.0 deprecations mode” is that a program which runs with no
<a class="reference internal" href="../core/exceptions.html#sqlalchemy.exc.RemovedIn20Warning" title="sqlalchemy.exc.RemovedIn20Warning"><code class="xref py py-class docutils literal notranslate"><span class="pre">RemovedIn20Warning</span></code></a> warnings with “2.0 deprecations mode” turned
on is then ready to run in SQLAlchemy 2.0.</p>
</section>
<section id="migration-to-2-0-step-three-resolve-all-removedin20warnings">
<h3>Migration to 2.0 Step Three - Resolve all RemovedIn20Warnings<a class="headerlink" href="#migration-to-2-0-step-three-resolve-all-removedin20warnings" title="Permalink to this headline">¶</a></h3>
<p>Code can be developed iteratively to resolve these warnings.  Within
the SQLAlchemy project itself, the approach taken is as follows:</p>
<ol class="arabic">
<li><p>enable the <code class="docutils literal notranslate"><span class="pre">SQLALCHEMY_WARN_20=1</span></code> environment variable in the test suite,
for SQLAlchemy this is in the tox.ini file</p></li>
<li><p>Within the setup for the test suite, set up a series of warnings filters
that will select for particular subsets of warnings to either raise an
exception, or to be ignored (or logged).   Work with just one subgroup of warnings
at a time.  Below, a warnings filter is configured for an application where
the change to the Core level <code class="docutils literal notranslate"><span class="pre">.execute()</span></code> calls will be needed in order
for all tests to pass, but all other 2.0-style warnings will be suppressed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">exc</span>

<span class="c1"># for warnings related to execute() / scalar(), raise</span>
<span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="p">[</span>
    <span class="sa">r</span><span class="s2">&quot;The (?:Executable|Engine)\.(?:execute|scalar)\(\) function&quot;</span><span class="p">,</span>
    <span class="sa">r</span><span class="s2">&quot;The current statement is being autocommitted using implicit &quot;</span>
    <span class="s2">&quot;autocommit,&quot;</span><span class="p">,</span>
    <span class="sa">r</span><span class="s2">&quot;The connection.execute\(\) method in SQLAlchemy 2.0 will accept &quot;</span>
    <span class="s2">&quot;parameters as a single dictionary or a single sequence of &quot;</span>
    <span class="s2">&quot;dictionaries only.&quot;</span><span class="p">,</span>
    <span class="sa">r</span><span class="s2">&quot;The Connection.connect\(\) function/method is considered legacy&quot;</span><span class="p">,</span>
    <span class="sa">r</span><span class="s2">&quot;.*DefaultGenerator.execute\(\)&quot;</span><span class="p">,</span>
<span class="p">]:</span>
  <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
      <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">exc</span><span class="o">.</span><span class="n">RemovedIn20Warning</span><span class="p">,</span>
  <span class="p">)</span>

<span class="c1"># for all other warnings, just log</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
  <span class="s2">&quot;always&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">exc</span><span class="o">.</span><span class="n">RemovedIn20Warning</span>
<span class="p">)</span></pre></div>
</div>
</li>
<li><p>As each sub-category of warnings are resolved in the application, new
warnings that are caught by the “always” filter can be added to the list
of “errors” to be resolved.</p></li>
<li><p>Once no more warnings are emitted, the filter can be removed.</p></li>
</ol>
</section>
<section id="migration-to-2-0-step-four-use-the-future-flag-on-engine">
<h3>Migration to 2.0 Step Four - Use the <code class="docutils literal notranslate"><span class="pre">future</span></code> flag on Engine<a class="headerlink" href="#migration-to-2-0-step-four-use-the-future-flag-on-engine" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code></a> object features an updated
transaction-level API in version 2.0.  In 1.4, this new API is available
by passing the flag <code class="docutils literal notranslate"><span class="pre">future=True</span></code> to the <a class="reference internal" href="../core/engines.html#sqlalchemy.create_engine" title="sqlalchemy.create_engine"><code class="xref py py-func docutils literal notranslate"><span class="pre">create_engine()</span></code></a>
function.</p>
<p>When the <a class="reference internal" href="../core/engines.html#sqlalchemy.create_engine.params.future" title="sqlalchemy.create_engine"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">create_engine.future</span></code></a> flag is used, the <a class="reference internal" href="../core/future.html#sqlalchemy.future.Engine" title="sqlalchemy.future.Engine"><code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code></a>
and <a class="reference internal" href="../core/future.html#sqlalchemy.future.Connection" title="sqlalchemy.future.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a> objects support the 2.0 API fully and not at all
any legacy features, including the new argument format for <a class="reference internal" href="../core/future.html#sqlalchemy.future.Connection.execute" title="sqlalchemy.future.Connection.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.execute()</span></code></a>,
the removal of “implicit autocommit”, string statements require the
<a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.text" title="sqlalchemy.sql.expression.text"><code class="xref py py-func docutils literal notranslate"><span class="pre">text()</span></code></a> construct unless the <code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.exec_driver_sql()</span></code>
method is used, and connectionless execution from the <a class="reference internal" href="../core/future.html#sqlalchemy.future.Engine" title="sqlalchemy.future.Engine"><code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code></a>
is removed.</p>
<p>If all <a class="reference internal" href="../core/exceptions.html#sqlalchemy.exc.RemovedIn20Warning" title="sqlalchemy.exc.RemovedIn20Warning"><code class="xref py py-class docutils literal notranslate"><span class="pre">RemovedIn20Warning</span></code></a> warnings have been resolved regarding
use of the <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code></a> and <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a>, then the
<a class="reference internal" href="../core/engines.html#sqlalchemy.create_engine.params.future" title="sqlalchemy.create_engine"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">create_engine.future</span></code></a> flag may be enabled and there should be
no errors raised.</p>
<p>The new engine is described at <a class="reference internal" href="../core/future.html#sqlalchemy.future.Engine" title="sqlalchemy.future.Engine"><code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code></a> which delivers a new
<a class="reference internal" href="../core/future.html#sqlalchemy.future.Connection" title="sqlalchemy.future.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a> object.    In addition to the above changes, the,
<a class="reference internal" href="../core/future.html#sqlalchemy.future.Connection" title="sqlalchemy.future.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a> object features
<a class="reference internal" href="../core/future.html#sqlalchemy.future.Connection.commit" title="sqlalchemy.future.Connection.commit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.commit()</span></code></a> and
<a class="reference internal" href="../core/future.html#sqlalchemy.future.Connection.rollback" title="sqlalchemy.future.Connection.rollback"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.rollback()</span></code></a> methods, to support the new
“commit-as-you-go” mode of operation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;postgresql:///&quot;</span><span class="p">)</span>

<span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;insert into table (x) values (:some_x)&quot;</span><span class="p">),</span> <span class="p">{</span><span class="s2">&quot;some_x&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">})</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1"># commit as you go</span></pre></div>
</div>
</section>
<section id="migration-to-2-0-step-four-use-the-future-flag-on-session">
<h3>Migration to 2.0 Step Four - Use the <code class="docutils literal notranslate"><span class="pre">future</span></code> flag on Session<a class="headerlink" href="#migration-to-2-0-step-four-use-the-future-flag-on-session" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> object also features an updated transaction/connection
level API in version 2.0.  This API is available in 1.4 using the
<a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.params.future" title="sqlalchemy.orm.Session"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.future</span></code></a> flag on <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> or on
<a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.sessionmaker" title="sqlalchemy.orm.sessionmaker"><code class="xref py py-class docutils literal notranslate"><span class="pre">sessionmaker</span></code></a>.</p>
<p>The <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> object supports “future” mode in place, and involves
these changes:</p>
<ol class="arabic simple">
<li><p>The <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> no longer supports “bound metadata” when it
resolves the engine to be used for connectivity.   This means that an
<a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code></a> object <strong>must</strong> be passed to the constructor (this
may be either a legacy or future style object).</p></li>
<li><p>The <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.begin.params.subtransactions" title="sqlalchemy.orm.Session.begin"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.begin.subtransactions</span></code></a> flag is no longer
supported.</p></li>
<li><p>The <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.commit" title="sqlalchemy.orm.Session.commit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.commit()</span></code></a> method always emits a COMMIT to the database,
rather than attempting to reconcile “subtransactions”.</p></li>
<li><p>The <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.rollback" title="sqlalchemy.orm.Session.rollback"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.rollback()</span></code></a> method always rolls back the full
stack of transactions at once, rather than attempting to keep
“subtransactions” in place.</p></li>
</ol>
<p>The <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> also supports more flexible creational patterns
in 1.4 which are now closely matched to the patterns used by the
<a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a> object.   Highlights include that the
<a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> may be used as a context manager:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Session</span>
<span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
    <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MyObject</span><span class="p">())</span>
    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></pre></div>
</div>
<p>In addition, the <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.sessionmaker" title="sqlalchemy.orm.sessionmaker"><code class="xref py py-class docutils literal notranslate"><span class="pre">sessionmaker</span></code></a> object supports a
<a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.sessionmaker.begin" title="sqlalchemy.orm.sessionmaker.begin"><code class="xref py py-meth docutils literal notranslate"><span class="pre">sessionmaker.begin()</span></code></a> context manager that will create a
<a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> and begin /commit a transaction in one block:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span>

<span class="n">Session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

<span class="k">with</span> <span class="n">Session</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
    <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MyObject</span><span class="p">())</span></pre></div>
</div>
<p>See the section <a class="reference internal" href="../orm/session_transaction.html#orm-session-vs-engine"><span class="std std-ref">Session-level vs. Engine level transaction control</span></a> for a comparison of
<a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> creational patterns compared to those of
<a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a>.</p>
<p>Once the application passes all tests/ runs with <code class="docutils literal notranslate"><span class="pre">SQLALCHEMY_WARN_20=1</span></code>
and all <code class="docutils literal notranslate"><span class="pre">exc.RemovedIn20Warning</span></code> occurrences set to raise an error,
<strong>the application is ready!</strong>.</p>
<p>The sections that follow will detail the specific changes to make for all
major API modifications.</p>
</section>
</section>
<section id="migration-core-connection-transaction">
<h2>2.0 Migration - Core Connection / Transaction<a class="headerlink" href="#migration-core-connection-transaction" title="Permalink to this headline">¶</a></h2>
<section id="library-level-but-not-driver-level-autocommit-removed-from-both-core-and-orm">
<span id="migration-20-autocommit"></span><h3>Library-level (but not driver level) “Autocommit” removed from both Core and ORM<a class="headerlink" href="#library-level-but-not-driver-level-autocommit-removed-from-both-core-and-orm" title="Permalink to this headline">¶</a></h3>
<p><strong>Synopsis</strong></p>
<p>In SQLAlchemy 1.x, the following statements will automatically commit
the underlying DBAPI transaction, but in SQLAlchemy
2.0 this will not occur:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">conn</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

<span class="c1"># won&#39;t autocommit in 2.0</span>
<span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">some_table</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">foo</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">))</span></pre></div>
</div>
<p>Nor will this autocommit:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">conn</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

<span class="c1"># won&#39;t autocommit in 2.0</span>
<span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;INSERT INTO table (foo) VALUES (&#39;bar&#39;)&quot;</span><span class="p">))</span></pre></div>
</div>
<p>The common workaround for custom DML that requires commit, the “autocommit”
execution option, will be removed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">conn</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

<span class="c1"># won&#39;t autocommit in 2.0</span>
<span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
  <span class="n">text</span><span class="p">(</span><span class="s2">&quot;EXEC my_procedural_thing()&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">execution_options</span><span class="p">(</span><span class="n">autocommit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="p">)</span></pre></div>
</div>
<p><strong>Migration to 2.0</strong></p>
<p>The method that is cross-compatible with <a class="reference internal" href="../glossary.html#term-1.x-style"><span class="xref std std-term">1.x style</span></a> and <a class="reference internal" href="../glossary.html#term-2.0-style"><span class="xref std std-term">2.0
style</span></a> execution is to make use of the <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Connection.begin" title="sqlalchemy.engine.Connection.begin"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.begin()</span></code></a> method,
or the <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Engine.begin" title="sqlalchemy.engine.Engine.begin"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Engine.begin()</span></code></a> context manager:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">some_table</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">foo</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">))</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">some_other_table</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">bat</span><span class="o">=</span><span class="s1">&#39;hoho&#39;</span><span class="p">))</span>

<span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">begin</span><span class="p">():</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">some_table</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">foo</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">))</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">some_other_table</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">bat</span><span class="o">=</span><span class="s1">&#39;hoho&#39;</span><span class="p">))</span>

<span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;EXEC my_procedural_thing()&quot;</span><span class="p">))</span></pre></div>
</div>
<p>When using <a class="reference internal" href="../glossary.html#term-2.0-style"><span class="xref std std-term">2.0 style</span></a> with the <a class="reference internal" href="../core/engines.html#sqlalchemy.create_engine.params.future" title="sqlalchemy.create_engine"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">create_engine.future</span></code></a>
flag, “commit as you go” style may also be used, as the
<a class="reference internal" href="../core/future.html#sqlalchemy.future.Connection" title="sqlalchemy.future.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a> features <strong>autobegin</strong> behavior, which takes place
when a statement is first invoked in the absence of an explicit call to
<a class="reference internal" href="../core/future.html#sqlalchemy.future.Connection.begin" title="sqlalchemy.future.Connection.begin"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.begin()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">some_table</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">foo</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">))</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">some_other_table</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">bat</span><span class="o">=</span><span class="s1">&#39;hoho&#39;</span><span class="p">))</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></pre></div>
</div>
<p>When <a class="reference internal" href="#migration-20-deprecations-mode"><span class="std std-ref">2.0 deprecations mode</span></a> is enabled,
a warning will emit when the deprecated “autocommit” feature takes place,
indicating those places where an explicit transaction should be noted.</p>
<p><strong>Discussion</strong></p>
<p>SQLAlchemy’s first releases were at odds with the spirit of the Python DBAPI
(<span class="target" id="index-1"></span><a class="pep reference external" href="https://www.python.org/dev/peps/pep-0249"><strong>PEP 249</strong></a>) in that it tried to hide <span class="target" id="index-2"></span><a class="pep reference external" href="https://www.python.org/dev/peps/pep-0249"><strong>PEP 249</strong></a>’s emphasis on “implicit begin”
and “explicit commit” of transactions.    Fifteen years later we now see this
was essentially a mistake, as SQLAlchemy’s many patterns that attempt to “hide”
the presence of a transaction make for a more complex API which works
inconsistently and is extremely confusing to especially those users who are new
to relational databases and ACID transactions in general.   SQLAlchemy 2.0 will
do away with all attempts to implicitly commit transactions, and usage patterns
will always require that the user demarcate the “beginning” and the “end” of a
transaction in some way, in the same way as reading or writing to a file in
Python has a “beginning” and an “end”.</p>
<p>In the case of autocommit for a pure textual statement, there is actually a
regular expression that parses every statement in order to detect autocommit!
Not surprisingly, this regex is continuously failing to accommodate for various
kinds of statements and  stored procedures that imply a “write” to the
database, leading to ongoing confusion as some statements produce results in
the database and others don’t.  By preventing the user from being aware of the
transactional concept, we get a lot of bug reports on this one because users
don’t understand that databases always use a transaction, whether or not some
layer is autocommitting it.</p>
<p>SQLAlchemy 2.0 will require that all database actions at every level be
explicit as to how the transaction should be used.    For the vast majority
of Core use cases, it’s the pattern that is already recommended:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">some_table</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">foo</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">))</span></pre></div>
</div>
<p>For “commit as you go, or rollback instead” usage, which resembles how the
<a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> is normally used today, the “future” version of
<a class="reference internal" href="../core/future.html#sqlalchemy.future.Connection" title="sqlalchemy.future.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a>, which is the one that is returned from an
<a class="reference internal" href="../core/future.html#sqlalchemy.future.Engine" title="sqlalchemy.future.Engine"><code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code></a> that was created using the
<a class="reference internal" href="../core/engines.html#sqlalchemy.create_engine.params.future" title="sqlalchemy.create_engine"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">create_engine.future</span></code></a> flag, includes new
<a class="reference internal" href="../core/future.html#sqlalchemy.future.Connection.commit" title="sqlalchemy.future.Connection.commit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.commit()</span></code></a> and <a class="reference internal" href="../core/future.html#sqlalchemy.future.Connection.rollback" title="sqlalchemy.future.Connection.rollback"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.rollback()</span></code></a>
methods, which act upon a transaction that is now begun automatically when
a statement is first invoked:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1.4 / 2.0 code</span>

<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">future</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">some_table</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">foo</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">))</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;some other SQL&quot;</span><span class="p">))</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span></pre></div>
</div>
<p>Above, the <code class="docutils literal notranslate"><span class="pre">engine.connect()</span></code> method will return a <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a> that
features <strong>autobegin</strong>, meaning the <code class="docutils literal notranslate"><span class="pre">begin()</span></code> event is emitted when the
execute method is first used (note however that there is no actual “BEGIN” in
the Python DBAPI).  “autobegin” is a new pattern in SQLAlchemy 1.4 that
is featured both by <a class="reference internal" href="../core/future.html#sqlalchemy.future.Connection" title="sqlalchemy.future.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a> as well as the ORM
<a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> object; autobegin allows that the <a class="reference internal" href="../core/future.html#sqlalchemy.future.Connection.begin" title="sqlalchemy.future.Connection.begin"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.begin()</span></code></a>
method may be called explicitly when the object is first acquired, for schemes
that wish to demarcate the beginning of the transaction, but if the method
is not called, then it occurs implicitly when work is first done on the object.</p>
<p>The removal of “autocommit” is closely related to the removal of
“connectionless” execution discussed at <a class="reference internal" href="#migration-20-implicit-execution"><span class="std std-ref">“Implicit” and “Connectionless” execution, “bound metadata” removed</span></a>.
All of these legacy patterns built up from the fact that Python did not have
context managers or decorators when SQLAlchemy was first created, so there were
no convenient idiomatic patterns for demarcating the use of a resource.</p>
<section id="driver-level-autocommit-remains-available">
<h4>Driver-level autocommit remains available<a class="headerlink" href="#driver-level-autocommit-remains-available" title="Permalink to this headline">¶</a></h4>
<p>True “autocommit” behavior is now widely available with most DBAPI
implementations, and is supported by SQLAlchemy via the
<a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Connection.execution_options.params.isolation_level" title="sqlalchemy.engine.Connection.execution_options"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Connection.execution_options.isolation_level</span></code></a> parameter as
discussed at <a class="reference internal" href="../core/connections.html#dbapi-autocommit"><span class="std std-ref">Setting Transaction Isolation Levels including DBAPI Autocommit</span></a>.  True autocommit is treated as an “isolation level”
so that the structure of application code does not change when autocommit is
used; the <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Connection.begin" title="sqlalchemy.engine.Connection.begin"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.begin()</span></code></a> context manager as well as
methods like <a class="reference internal" href="../core/future.html#sqlalchemy.future.Connection.commit" title="sqlalchemy.future.Connection.commit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.commit()</span></code></a> may still be used, they are
simply no-ops at the database driver level when DBAPI-level autocommit
is turned on.</p>
</section>
</section>
<section id="implicit-and-connectionless-execution-bound-metadata-removed">
<span id="migration-20-implicit-execution"></span><h3>“Implicit” and “Connectionless” execution, “bound metadata” removed<a class="headerlink" href="#implicit-and-connectionless-execution-bound-metadata-removed" title="Permalink to this headline">¶</a></h3>
<p><strong>Synopsis</strong></p>
<p>The ability to associate an <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code></a> with a <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData" title="sqlalchemy.schema.MetaData"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code></a>
object, which then makes available a range of so-called “connectionless”
execution patterns, is removed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">MetaData</span>

<span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>  <span class="c1"># no longer supported</span>

<span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>   <span class="c1"># requires Engine or Connection</span>

<span class="n">metadata</span><span class="o">.</span><span class="n">reflect</span><span class="p">()</span>  <span class="c1"># requires Engine or Connection</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">autoload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># use autoload_with=engine</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">select</span><span class="p">())</span>  <span class="c1"># no longer supported</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>  <span class="c1"># no longer supported</span></pre></div>
</div>
<p><strong>Migration to 2.0</strong></p>
<p>For schema level patterns, explicit use of an <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code></a>
or <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a> is required.   The <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code></a>
may still be used directly as the source of connectivity for a
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData.create_all" title="sqlalchemy.schema.MetaData.create_all"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MetaData.create_all()</span></code></a> operation or autoload operation.
For executing statements, only the <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a> object
has a <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Connection.execute" title="sqlalchemy.engine.Connection.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.execute()</span></code></a> method (in addition to
the ORM-level <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a> method):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">MetaData</span>

<span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>

<span class="c1"># engine level:</span>

<span class="c1"># create tables</span>
<span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

<span class="c1"># reflect all tables</span>
<span class="n">metadata</span><span class="o">.</span><span class="n">reflect</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

<span class="c1"># reflect individual table</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>


<span class="c1"># connection level:</span>


<span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
    <span class="c1"># create tables, requires explicit begin and/or commit:</span>
    <span class="k">with</span> <span class="n">connection</span><span class="o">.</span><span class="n">begin</span><span class="p">():</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>

    <span class="c1"># reflect all tables</span>
    <span class="n">metadata</span><span class="o">.</span><span class="n">reflect</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>

    <span class="c1"># reflect individual table</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">connection</span><span class="p">)</span>

    <span class="c1"># execute SQL statements</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">select</span><span class="p">())</span></pre></div>
</div>
<p><strong>Discussion</strong></p>
<p>The Core documentation has already standardized on the desired pattern here,
so it is likely that most modern applications would not have to change
much in any case, however there are likely many applications that still
rely upon <code class="docutils literal notranslate"><span class="pre">engine.execute()</span></code> calls that will need to be adjusted.</p>
<p>“Connectionless” execution refers to the still fairly popular pattern of
invoking <code class="docutils literal notranslate"><span class="pre">.execute()</span></code> from the <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">some_statement</span><span class="p">)</span></pre></div>
</div>
<p>The above operation implicitly procures a <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a> object,
and runs the <code class="docutils literal notranslate"><span class="pre">.execute()</span></code> method on it.  While this appears to be a simple
convenience feature, it has been shown to give rise to several issues:</p>
<ul class="simple">
<li><p>Programs that feature extended strings of <code class="docutils literal notranslate"><span class="pre">engine.execute()</span></code> calls have
become prevalent, overusing a feature that was intended to be seldom used and
leading to inefficient non-transactional applications.  New users are
confused as to the difference between <code class="docutils literal notranslate"><span class="pre">engine.execute()</span></code> and
<code class="docutils literal notranslate"><span class="pre">connection.execute()</span></code> and the nuance between these two approaches is
often not understood.</p></li>
<li><p>The feature relies upon the “application level autocommit” feature in order
to make sense, which itself is also being removed as it is also
<a class="reference internal" href="#migration-20-autocommit"><span class="std std-ref">inefficient and misleading</span></a>.</p></li>
<li><p>In order to handle result sets, <code class="docutils literal notranslate"><span class="pre">Engine.execute</span></code> returns a result object
with unconsumed cursor results.  This cursor result necessarily still links
to the DBAPI connection which remains in an open transaction, all of which is
released once the result set has fully consumed the rows waiting within the
cursor.   This means that <code class="docutils literal notranslate"><span class="pre">Engine.execute</span></code> does not actually close out the
connection resources that it claims to be managing when the call is complete.
SQLAlchemy’s “autoclose” behavior is well-tuned enough that users don’t
generally report any negative effects from this system, however it remains
an overly implicit and inefficient system left over from SQLAlchemy’s
earliest releases.</p></li>
</ul>
<p>The removal of “connectionless” execution then leads to the removal of
an even more legacy pattern, that of “implicit, connectionless” execution:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">some_statement</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span></pre></div>
</div>
<p>The above pattern has all the issues of “connectionless” execution, plus it
relies upon the “bound metadata” pattern, which SQLAlchemy has tried to
de-emphasize for many years.   This was SQLAlchemy’s very first advertised
usage model in version 0.1, which became obsolete almost immediately when
the <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a> object was introduced and later Python
context managers provided a better pattern for using resources within a
fixed scope.</p>
<p>With implicit execution removed, “bound metadata” itself also no longer has
a purpose within this system.   In modern use “bound metadata” tends to still
be somewhat convenient for working within <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData.create_all" title="sqlalchemy.schema.MetaData.create_all"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MetaData.create_all()</span></code></a>
calls as well as with <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> objects, however having these
functions receive an <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code></a> explicitly provides for clearer
application design.</p>
<section id="many-choices-becomes-one-choice">
<h4>Many Choices becomes One Choice<a class="headerlink" href="#many-choices-becomes-one-choice" title="Permalink to this headline">¶</a></h4>
<p>Overall, the above executional patterns were introduced in SQLAlchemy’s
very first 0.1 release before the <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a> object even existed.
After many years of de-emphasizing these patterns, “implicit, connectionless”
execution and “bound metadata” are no longer as widely used so in 2.0 we seek
to finally reduce the number of choices for how to execute a statement in
Core from “many choices”:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># many choices</span>

<span class="c1"># bound metadata?</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

<span class="c1"># or not?</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>

<span class="c1"># execute from engine?</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>

<span class="c1"># or execute the statement itself (but only if you did</span>
<span class="c1"># &quot;bound metadata&quot; above, which means you can&#39;t get rid of &quot;bound&quot; if any</span>
<span class="c1"># part of your program uses this form)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

<span class="c1"># execute from connection, but it autocommits?</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>

<span class="c1"># execute from connection, but autocommit isn&#39;t working, so use the special</span>
<span class="c1"># option?</span>
<span class="n">conn</span><span class="o">.</span><span class="n">execution_options</span><span class="p">(</span><span class="n">autocommit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>

<span class="c1"># or on the statement ?!</span>
<span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="o">.</span><span class="n">execution_options</span><span class="p">(</span><span class="n">autocommit</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

<span class="c1"># or execute from connection, and we use explicit transaction?</span>
<span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">begin</span><span class="p">():</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span></pre></div>
</div>
<p>to “one choice”, where by “one choice” we mean “explicit connection with
explicit transaction”; there are still a few ways to demarcate
transaction blocks depending on need.  The “one choice” is to procure a
<a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a> and then to explicitly demarcate the transaction,
in the case that the operation is a write operation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># one choice - work with explicit connection, explicit transaction</span>
<span class="c1"># (there remain a few variants on how to demarcate the transaction)</span>

<span class="c1"># &quot;begin once&quot; - one transaction only per checkout</span>
<span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>

<span class="c1"># &quot;commit as you go&quot; - zero or more commits per checkout</span>
<span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="c1"># &quot;commit as you go&quot; but with a transaction block instead of autobegin</span>
<span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">begin</span><span class="p">():</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span></pre></div>
</div>
</section>
</section>
<section id="execute-method-more-strict-execution-options-are-more-prominent">
<h3>execute() method more strict, execution options are more prominent<a class="headerlink" href="#execute-method-more-strict-execution-options-are-more-prominent" title="Permalink to this headline">¶</a></h3>
<p><strong>Synopsis</strong></p>
<p>The argument patterns that may be used with the <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-meth docutils literal notranslate"><span class="pre">sqlalchemy.engine.Connection()</span></code></a>
execute method in SQLAlchemy 2.0 are highly simplified, removing many previously
available argument patterns.  The new API in the 1.4 series is described at
<a class="reference internal" href="../core/future.html#sqlalchemy.future.Connection" title="sqlalchemy.future.Connection"><code class="xref py py-meth docutils literal notranslate"><span class="pre">sqlalchemy.future.Connection()</span></code></a>. The examples below illustrate the patterns that
require modification:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

<span class="c1"># direct string SQL not supported; use text() or exec_driver_sql() method</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select * from table&quot;</span><span class="p">)</span>

<span class="c1"># positional parameters no longer supported, only named</span>
<span class="c1"># unless using exec_driver_sql()</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">insert</span><span class="p">(),</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">))</span>

<span class="c1"># **kwargs no longer accepted, pass a single dictionary</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">insert</span><span class="p">(),</span> <span class="n">x</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># multiple *args no longer accepted, pass a list</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="n">table</span><span class="o">.</span><span class="n">insert</span><span class="p">(),</span>
    <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">}</span>
<span class="p">)</span></pre></div>
</div>
<p><strong>Migration to 2.0</strong></p>
<p>The new <a class="reference internal" href="../core/future.html#sqlalchemy.future.Connection.execute" title="sqlalchemy.future.Connection.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.execute()</span></code></a> method now accepts a subset of the
argument styles that are accepted by the 1.x <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Connection.execute" title="sqlalchemy.engine.Connection.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.execute()</span></code></a>
method, so the following code is cross-compatible between 1.x and 2.0:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">text</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;select * from table&quot;</span><span class="p">))</span>

<span class="c1"># pass a single dictionary for single statement execution</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">insert</span><span class="p">(),</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">})</span>

<span class="c1"># pass a list of dictionaries for executemany</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="n">table</span><span class="o">.</span><span class="n">insert</span><span class="p">(),</span>
    <span class="p">[{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">}]</span>
<span class="p">)</span></pre></div>
</div>
<p><strong>Discussion</strong></p>
<p>The use of <code class="docutils literal notranslate"><span class="pre">*args</span></code> and <code class="docutils literal notranslate"><span class="pre">**kwargs</span></code> has been removed both to remove the
complexity of guessing what kind of arguments were passed to the method, as
well as to make room for other options, namely the
<a class="reference internal" href="../core/future.html#sqlalchemy.future.Connection.execute.params.execution_options" title="sqlalchemy.future.Connection.execute"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Connection.execute.execution_options</span></code></a> dictionary that is now
available to provide options on a per statement basis. The method is also
modified so that its use pattern matches that of the
<a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a> method, which is a much more prominent API in 2.0
style.</p>
<p>The removal of direct string SQL is to resolve an inconsistency between
<a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Connection.execute" title="sqlalchemy.engine.Connection.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.execute()</span></code></a> and <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a>,
where in the former case the string is passed to the driver raw, and in the
latter case it is first converted to a <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.text" title="sqlalchemy.sql.expression.text"><code class="xref py py-func docutils literal notranslate"><span class="pre">text()</span></code></a> construct.  By
allowing only <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.text" title="sqlalchemy.sql.expression.text"><code class="xref py py-func docutils literal notranslate"><span class="pre">text()</span></code></a> this also limits the accepted parameter
format to “named” and not “positional”.  Finally, the string SQL use case
is becoming more subject to scrutiny from a security perspective, and
the <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.text" title="sqlalchemy.sql.expression.text"><code class="xref py py-func docutils literal notranslate"><span class="pre">text()</span></code></a> construct has come to represent an explicit boundary
into the textual SQL realm where attention to untrusted user input must be
given.</p>
</section>
<section id="result-rows-act-like-named-tuples">
<span id="migration-20-result-rows"></span><h3>Result rows act like named tuples<a class="headerlink" href="#result-rows-act-like-named-tuples" title="Permalink to this headline">¶</a></h3>
<p><strong>Synopsis</strong></p>
<p>Version 1.4 introduces an <a class="reference internal" href="migration_14.html#change-result-14-core"><span class="std std-ref">all new Result object</span></a>
that in turn returns <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Row" title="sqlalchemy.engine.Row"><code class="xref py py-class docutils literal notranslate"><span class="pre">Row</span></code></a> objects, which behave like named
tuples when using “future” mode:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">future</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># using future mode</span>

<span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;select x, y from table&quot;</span><span class="p">))</span>

    <span class="n">row</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>  <span class="c1"># suppose the row is (1, 2)</span>

    <span class="s2">&quot;x&quot;</span> <span class="ow">in</span> <span class="n">row</span>   <span class="c1"># evaluates to False, in 1.x / future=False, this would be True</span>

    <span class="mi">1</span> <span class="ow">in</span> <span class="n">row</span>  <span class="c1"># evaluates to True, in 1.x / future=False, this would be False</span></pre></div>
</div>
<p><strong>Migration to 2.0</strong></p>
<p>Application code or test suites that are testing for a particular key
being present in a row would need to test the <code class="docutils literal notranslate"><span class="pre">row.keys()</span></code> collection
instead.  This is however an unusual use case as a result row is typically
used by code that already knows what columns are present within it.</p>
<p><strong>Discussion</strong></p>
<p>Already part of 1.4, the previous <code class="docutils literal notranslate"><span class="pre">KeyedTuple</span></code> class that was used when
selecting rows from the <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> object has been replaced by the
<a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Row" title="sqlalchemy.engine.Row"><code class="xref py py-class docutils literal notranslate"><span class="pre">Row</span></code></a> class, which is the base of the same <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Row" title="sqlalchemy.engine.Row"><code class="xref py py-class docutils literal notranslate"><span class="pre">Row</span></code></a> that comes
back with Core statement results when using the
<a class="reference internal" href="../core/engines.html#sqlalchemy.create_engine.params.future" title="sqlalchemy.create_engine"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">create_engine.future</span></code></a> flag with <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code></a> (when
the <a class="reference internal" href="../core/engines.html#sqlalchemy.create_engine.params.future" title="sqlalchemy.create_engine"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">create_engine.future</span></code></a> flag is not set, Core result sets use
the <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.LegacyRow" title="sqlalchemy.engine.LegacyRow"><code class="xref py py-class docutils literal notranslate"><span class="pre">LegacyRow</span></code></a> subclass, which maintains backwards-compatible
behaviors for the <code class="docutils literal notranslate"><span class="pre">__contains__()</span></code> method; ORM exclusively uses the
<a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Row" title="sqlalchemy.engine.Row"><code class="xref py py-class docutils literal notranslate"><span class="pre">Row</span></code></a> class directly).</p>
<p>This <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Row" title="sqlalchemy.engine.Row"><code class="xref py py-class docutils literal notranslate"><span class="pre">Row</span></code></a> behaves like a named tuple, in that it acts as a sequence
but also supports attribute name access, e.g. <code class="docutils literal notranslate"><span class="pre">row.some_column</span></code>.  However,
it also provides the previous “mapping” behavior via the special attribute
<code class="docutils literal notranslate"><span class="pre">row._mapping</span></code>, which produces a Python mapping such that keyed access
such as <code class="docutils literal notranslate"><span class="pre">row[&quot;some_column&quot;]</span></code> can be used.</p>
<p>In order to receive results as mappings up front, the <code class="docutils literal notranslate"><span class="pre">mappings()</span></code> modifier
on the result can be used:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.future.orm</span> <span class="kn">import</span> <span class="n">Session</span>

<span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">some_engine</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">mappings</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;the user is: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;User&quot;</span><span class="p">])</span></pre></div>
</div>
<p>The <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Row" title="sqlalchemy.engine.Row"><code class="xref py py-class docutils literal notranslate"><span class="pre">Row</span></code></a> class as used by the ORM also supports access via entity
or attribute:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.future</span> <span class="kn">import</span> <span class="n">select</span>

<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">)</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span><span class="o">.</span><span class="n">mappings</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;the user is: </span><span class="si">%s</span><span class="s2">  the address is: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">row</span><span class="p">[</span><span class="n">User</span><span class="p">],</span>
        <span class="n">row</span><span class="p">[</span><span class="n">Address</span><span class="p">]</span>
    <span class="p">))</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="migration_14.html#change-4710-core"><span class="std std-ref">RowProxy is no longer a “proxy”; is now called Row and behaves like an enhanced named tuple</span></a></p>
</div>
</section>
</section>
<section id="migration-core-usage">
<h2>2.0 Migration - Core Usage<a class="headerlink" href="#migration-core-usage" title="Permalink to this headline">¶</a></h2>
<section id="select-no-longer-accepts-varied-constructor-arguments-columns-are-passed-positionally">
<span id="migration-20-5284"></span><h3>select() no longer accepts varied constructor arguments, columns are passed positionally<a class="headerlink" href="#select-no-longer-accepts-varied-constructor-arguments-columns-are-passed-positionally" title="Permalink to this headline">¶</a></h3>
<p><strong>synopsis</strong></p>
<p>The <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> construct as well as the related method <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.FromClause.select" title="sqlalchemy.sql.expression.FromClause.select"><code class="xref py py-meth docutils literal notranslate"><span class="pre">FromClause.select()</span></code></a>
will no longer accept keyword arguments to build up elements such as the
WHERE clause, FROM list and ORDER BY.   The list of columns may now be
sent positionally, rather than as a list.  Additionally, the <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.case" title="sqlalchemy.sql.expression.case"><code class="xref py py-func docutils literal notranslate"><span class="pre">case()</span></code></a> construct
now accepts its WHEN criteria positionally, rather than as a list:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># select_from / order_by keywords no longer supported</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="n">select_from</span><span class="o">=</span><span class="n">table</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

<span class="c1"># whereclause parameter no longer supported</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">x</span><span class="p">],</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>

<span class="c1"># whereclause parameter no longer supported</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>

<span class="c1"># list emits a deprecation warning</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">y</span><span class="p">])</span>

<span class="c1"># list emits a deprecation warning</span>
<span class="n">case_clause</span> <span class="o">=</span> <span class="n">case</span><span class="p">(</span>
  <span class="p">[</span>
    <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">x</span> <span class="o">==</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;five&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">x</span> <span class="o">==</span> <span class="mi">7</span><span class="p">,</span> <span class="s2">&quot;seven&quot;</span><span class="p">)</span>
  <span class="p">],</span>
  <span class="n">else_</span><span class="o">=</span><span class="s2">&quot;neither five nor seven&quot;</span>
<span class="p">)</span></pre></div>
</div>
<p><strong>Migration to 2.0</strong></p>
<p>Only the “generative” style of <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> will be supported.  The list
of columns / tables to SELECT from should be passed positionally.  The
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> construct in SQLAlchemy 1.4 accepts both the legacy
styles and the new styles using an auto-detection scheme, so the code below
is cross-compatible with 1.4 and 2.0:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># use generative methods</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

<span class="c1"># use generative methods</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>

<span class="c1"># use generative methods</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>

<span class="c1"># pass columns clause expressions positionally</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

<span class="c1"># case conditions passed positionally</span>
<span class="n">case_clause</span> <span class="o">=</span> <span class="n">case</span><span class="p">(</span>
  <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">x</span> <span class="o">==</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;five&quot;</span><span class="p">),</span>
  <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">x</span> <span class="o">==</span> <span class="mi">7</span><span class="p">,</span> <span class="s2">&quot;seven&quot;</span><span class="p">),</span>
  <span class="n">else_</span><span class="o">=</span><span class="s2">&quot;neither five nor seven&quot;</span>
<span class="p">)</span></pre></div>
</div>
<p><strong>Discussion</strong></p>
<p>SQLAlchemy has for many years developed a convention for SQL constructs
accepting an argument either as a list or as positional arguments.   This
convention states that <strong>structural</strong> elements, those that form the structure
of a SQL statement, should be passed <strong>positionally</strong>.   Conversely,
<strong>data</strong> elements, those that form the parameterized data of a SQL statement,
should be passed <strong>as lists</strong>.   For many years, the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a>
construct could not participate in this convention smoothly because of the
very legacy calling pattern where the “WHERE” clause would be passed positionally.
SQLAlchemy 2.0 finally resolves this by changing the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> construct
to only accept the “generative” style that has for many years been the only
documented style in the Core tutorial.</p>
<p>Examples of “structural” vs. “data” elements are as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># table columns for CREATE TABLE - structural</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;table&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span> <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">))</span>

<span class="c1"># columns in a SELECT statement - structural</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

<span class="c1"># literal elements in an IN clause - data</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">in_</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]))</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="migration_14.html#change-5284"><span class="std std-ref">select(), case() now accept positional expressions</span></a></p>
<p><a class="reference internal" href="../errors.html#error-c9ae"><span class="std std-ref">select() construct created in “legacy” mode; keyword arguments, etc.</span></a></p>
</div>
</section>
<section id="insert-update-delete-dml-no-longer-accept-keyword-constructor-arguments">
<h3>insert/update/delete DML no longer accept keyword constructor arguments<a class="headerlink" href="#insert-update-delete-dml-no-longer-accept-keyword-constructor-arguments" title="Permalink to this headline">¶</a></h3>
<p><strong>Synopsis</strong></p>
<p>In a similar way as to the previous change to <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a>, the
constructor arguments to <a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.insert" title="sqlalchemy.sql.expression.insert"><code class="xref py py-func docutils literal notranslate"><span class="pre">insert()</span></code></a>, <a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.update" title="sqlalchemy.sql.expression.update"><code class="xref py py-func docutils literal notranslate"><span class="pre">update()</span></code></a> and
<a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.delete" title="sqlalchemy.sql.expression.delete"><code class="xref py py-func docutils literal notranslate"><span class="pre">delete()</span></code></a> other than the table argument are essentially removed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># no longer supported</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">insert</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">},</span> <span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># no longer supported</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">insert</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">},</span> <span class="n">returning</span><span class="o">=</span><span class="p">[</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">x</span><span class="p">])</span>

<span class="c1"># no longer supported</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span>

<span class="c1"># no longer supported</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
    <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">,</span>
    <span class="n">preserve_parameter_order</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span>
    <span class="p">[(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)]</span>
<span class="p">)</span></pre></div>
</div>
<p><strong>Migration to 2.0</strong></p>
<p>The following examples illustrate generative method use for the above
examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># use generative methods, **kwargs OK for values()</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">insert</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span><span class="o">.</span><span class="n">inline</span><span class="p">()</span>

<span class="c1"># use generative methods, dictionary also still  OK for values()</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">insert</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">({</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">})</span><span class="o">.</span><span class="n">returning</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># use generative methods</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span>

<span class="c1"># use generative methods, ordered_values() replaces preserve_parameter_order</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">update</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">ordered_values</span><span class="p">(</span>
    <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span>
<span class="p">)</span></pre></div>
</div>
<p><strong>Discussion</strong></p>
<p>The API and internals is being simplified for the DML constructs in a similar
manner as that of the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> construct.</p>
</section>
</section>
<section id="migration-orm-configuration">
<h2>2.0 Migration - ORM Configuration<a class="headerlink" href="#migration-orm-configuration" title="Permalink to this headline">¶</a></h2>
<section id="declarative-becomes-a-first-class-api">
<h3>Declarative becomes a first class API<a class="headerlink" href="#declarative-becomes-a-first-class-api" title="Permalink to this headline">¶</a></h3>
<p><strong>Synopsis</strong></p>
<p>The <code class="docutils literal notranslate"><span class="pre">sqlalchemy.ext.declarative</span></code> package is mostly, with some exceptions,
moved to the <code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm</span></code> package.  The <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.declarative_base" title="sqlalchemy.orm.declarative_base"><code class="xref py py-func docutils literal notranslate"><span class="pre">declarative_base()</span></code></a>
and <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.declared_attr" title="sqlalchemy.orm.declared_attr"><code class="xref py py-func docutils literal notranslate"><span class="pre">declared_attr()</span></code></a> functions are present without any behavioral
changes.  A new super-implementation of <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.declarative_base" title="sqlalchemy.orm.declarative_base"><code class="xref py py-func docutils literal notranslate"><span class="pre">declarative_base()</span></code></a>
known as <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.registry" title="sqlalchemy.orm.registry"><code class="xref py py-class docutils literal notranslate"><span class="pre">registry</span></code></a> now serves as the top-level ORM configurational
construct, which also provides for decorator-based declarative and new
support for classical mappings that integrate with the declarative registry.</p>
<p><strong>Migration to 2.0</strong></p>
<p>Change imports:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.ext</span> <span class="kn">import</span> <span class="n">declarative_base</span><span class="p">,</span> <span class="n">declared_attr</span></pre></div>
</div>
<p>To:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">declarative_base</span><span class="p">,</span> <span class="n">declared_attr</span></pre></div>
</div>
<p><strong>Discussion</strong></p>
<p>After ten years or so of popularity, the <code class="docutils literal notranslate"><span class="pre">sqlalchemy.ext.declarative</span></code>
package is now integrated into the <code class="docutils literal notranslate"><span class="pre">sqlalchemy.orm</span></code> namespace, with the
exception of the declarative “extension” classes which remain as Declarative
extensions.   The change is detailed further in the 1.4 migration guide
at <a class="reference internal" href="migration_14.html#change-5508"><span class="std std-ref">Declarative is now integrated into the ORM with new features</span></a>.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../orm/mapping_styles.html"><span class="std std-ref">Mapping Python Classes</span></a> - all new unified documentation for
Declarative, classical mapping, dataclasses, attrs, etc.</p>
<p><a class="reference internal" href="migration_14.html#change-5508"><span class="std std-ref">Declarative is now integrated into the ORM with new features</span></a></p>
</div>
</section>
<section id="the-original-mapper-function-now-a-core-element-of-declarative-renamed">
<h3>The original “mapper()” function now a core element of Declarative, renamed<a class="headerlink" href="#the-original-mapper-function-now-a-core-element-of-declarative-renamed" title="Permalink to this headline">¶</a></h3>
<p><strong>Synopsis</strong></p>
<p>The <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.mapper" title="sqlalchemy.orm.mapper"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapper()</span></code></a> function moves behind the scenes to be invoked
by higher level APIs.  The new version of this function is the method
<a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.registry.map_imperatively" title="sqlalchemy.orm.registry.map_imperatively"><code class="xref py py-meth docutils literal notranslate"><span class="pre">registry.map_imperatively()</span></code></a> taken from a <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.registry" title="sqlalchemy.orm.registry"><code class="xref py py-class docutils literal notranslate"><span class="pre">registry</span></code></a>
object.</p>
<p><strong>Migration to 2.0</strong></p>
<p>Code that works with classical mappings should change imports and code from:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">mapper</span>


<span class="n">mapper</span><span class="p">(</span><span class="n">SomeClass</span><span class="p">,</span> <span class="n">some_table</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
    <span class="s2">&quot;related&quot;</span><span class="p">:</span> <span class="n">relationship</span><span class="p">(</span><span class="n">SomeRelatedClass</span><span class="p">)</span>
<span class="p">})</span></pre></div>
</div>
<p>To work from a central <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.registry" title="sqlalchemy.orm.registry"><code class="xref py py-class docutils literal notranslate"><span class="pre">registry</span></code></a> object:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">registry</span>

<span class="n">mapper_reg</span> <span class="o">=</span> <span class="n">registry</span><span class="p">()</span>

<span class="n">mapper_reg</span><span class="o">.</span><span class="n">map_imperatively</span><span class="p">(</span><span class="n">SomeClass</span><span class="p">,</span> <span class="n">some_table</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
    <span class="s2">&quot;related&quot;</span><span class="p">:</span> <span class="n">relationship</span><span class="p">(</span><span class="n">SomeRelatedClass</span><span class="p">)</span>
<span class="p">})</span></pre></div>
</div>
<p>The above <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.registry" title="sqlalchemy.orm.registry"><code class="xref py py-class docutils literal notranslate"><span class="pre">registry</span></code></a> is also the source for declarative mappings,
and classical mappings now have access to this registry including string-based
configuration on <a class="reference internal" href="../orm/relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">registry</span>

<span class="n">mapper_reg</span> <span class="o">=</span> <span class="n">registry</span><span class="p">()</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">mapper_reg</span><span class="o">.</span><span class="n">generate_base</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">SomeRelatedClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;related&#39;</span>

    <span class="c1"># ...</span>


<span class="n">mapper_reg</span><span class="o">.</span><span class="n">map_imperatively</span><span class="p">(</span><span class="n">SomeClass</span><span class="p">,</span> <span class="n">some_table</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
    <span class="s2">&quot;related&quot;</span><span class="p">:</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;SomeRelatedClass&quot;</span><span class="p">,</span>
        <span class="n">primaryjoin</span><span class="o">=</span><span class="s2">&quot;SomeRelatedClass.related_id == SomeClass.id&quot;</span>
    <span class="p">)</span>
<span class="p">})</span></pre></div>
</div>
<p><strong>Discussion</strong></p>
<p>By popular demand, “classical mapping” is staying around, however the new
form of it is based off of the <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.registry" title="sqlalchemy.orm.registry"><code class="xref py py-class docutils literal notranslate"><span class="pre">registry</span></code></a> object and is available
as <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.registry.map_imperatively" title="sqlalchemy.orm.registry.map_imperatively"><code class="xref py py-meth docutils literal notranslate"><span class="pre">registry.map_imperatively()</span></code></a>.</p>
<p>In addition, the primary rationale used for “classical mapping” is that of
keeping the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> setup distinct from the class.  Declarative
has always allowed this style using so-called
<a class="reference internal" href="../orm/declarative_tables.html#orm-imperative-table-configuration"><span class="std std-ref">hybrid declarative</span></a>. However, to
remove the base class requirement, a first class <a class="reference internal" href="../orm/declarative_mapping.html"><span class="std std-ref">decorator</span></a> form has been added.</p>
<p>As yet another separate but related enhancement, support for <a class="reference internal" href="../orm/mapping_styles.html#orm-declarative-dataclasses"><span class="std std-ref">Python
dataclasses</span></a> is added as well to both
declarative decorator and classical mapping forms.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../orm/mapping_styles.html"><span class="std std-ref">Mapping Python Classes</span></a> - all new unified documentation for
Declarative, classical mapping, dataclasses, attrs, etc.</p>
</div>
</section>
</section>
<section id="migration-orm-usage">
<h2>2.0 Migration - ORM Usage<a class="headerlink" href="#migration-orm-usage" title="Permalink to this headline">¶</a></h2>
<p>The biggest visible change in SQLAlchemy 2.0 is the use of
<a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a> in conjunction with <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> to run ORM
queries, instead of using <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.query" title="sqlalchemy.orm.Session.query"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.query()</span></code></a>.  As mentioned elsewhere,
there is no plan to actually remove the <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.query" title="sqlalchemy.orm.Session.query"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.query()</span></code></a> API itself,
as it is now implemented by using the new API internally it will remain as a
legacy API, and both APIs can be used freely.</p>
<p>The table below provides an introduction to the general change in
calling form with links to documentation for each technique
presented.  The individual migration notes are in the embedded sections
following the table, and may include additional notes not summarized here.</p>
<div class="sliding-table docutils container">
<table class="docutils align-default" id="id1">
<caption><span class="caption-text"><strong>Overview of Major ORM Querying Patterns</strong></span><a class="headerlink" href="#id1" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><a class="reference internal" href="../glossary.html#term-1.x-style"><span class="xref std std-term">1.x style</span></a> form</p></th>
<th class="head"><p><a class="reference internal" href="../glossary.html#term-2.0-style"><span class="xref std std-term">2.0 style</span></a> form</p></th>
<th class="head"><p>See Also</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span></pre></div>
</div>
</td>
<td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="mi">42</span><span class="p">)</span></pre></div>
</div>
</td>
<td><p><a class="reference internal" href="#migration-20-get-to-session"><span class="std std-ref">ORM Query - get() method moves to Session</span></a></p></td>
</tr>
<tr class="row-odd"><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
</div>
</td>
<td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
</div>
</td>
<td><p><a class="reference internal" href="#migration-20-unify-select"><span class="std std-ref">ORM Query Unified with Core Select</span></a></p>
<p><a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Result.scalars" title="sqlalchemy.engine.Result.scalars"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Result.scalars()</span></code></a></p>
</td>
</tr>
<tr class="row-even"><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span>\
<span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;some user&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span></pre></div>
</div>
</td>
<td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span>
    <span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;some user&quot;</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">scalar_one</span><span class="p">()</span></pre></div>
</div>
</td>
<td><p><a class="reference internal" href="#migration-20-unify-select"><span class="std std-ref">ORM Query Unified with Core Select</span></a></p>
<p><a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Result.scalar_one" title="sqlalchemy.engine.Result.scalar_one"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Result.scalar_one()</span></code></a></p>
</td>
</tr>
<tr class="row-odd"><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span>
    <span class="n">joinedload</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
</div>
</td>
<td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span>
    <span class="n">options</span><span class="p">(</span>
      <span class="n">joinedload</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
</div>
</td>
<td><p><a class="reference internal" href="#joinedload-not-uniqued"><span class="std std-ref">ORM Rows not uniquified by default</span></a></p></td>
</tr>
<tr class="row-even"><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span>\
    <span class="n">join</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span>\
    <span class="nb">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="s1">&#39;e@sa.us&#39;</span><span class="p">)</span><span class="o">.</span>\
    <span class="nb">all</span><span class="p">()</span></pre></div>
</div>
</td>
<td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span>
    <span class="n">join</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span>
    <span class="n">where</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="s1">&#39;e@sa.us&#39;</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
</div>
</td>
<td><p><a class="reference internal" href="#migration-20-unify-select"><span class="std std-ref">ORM Query Unified with Core Select</span></a></p>
<p><a class="reference internal" href="../orm/queryguide.html#orm-queryguide-joins"><span class="std std-ref">Joins</span></a></p>
</td>
</tr>
<tr class="row-odd"><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">from_statement</span><span class="p">(</span>
    <span class="n">text</span><span class="p">(</span><span class="s2">&quot;select * from users&quot;</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
</div>
</td>
<td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span>
    <span class="n">from_statement</span><span class="p">(</span>
        <span class="n">text</span><span class="p">(</span><span class="s2">&quot;select * from users&quot;</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
</div>
</td>
<td><p><a class="reference internal" href="../orm/queryguide.html#orm-queryguide-selecting-text"><span class="std std-ref">Getting ORM Results from Textual and Core Statements</span></a></p></td>
</tr>
<tr class="row-even"><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span>\
    <span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">)</span><span class="o">.</span>\
    <span class="n">options</span><span class="p">(</span>
      <span class="n">contains_eager</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span>\
    <span class="n">populate_existing</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
</div>
</td>
<td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span>
    <span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">)</span><span class="o">.</span>
    <span class="n">options</span><span class="p">(</span><span class="n">contains_eager</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">))</span><span class="o">.</span>
    <span class="n">execution_options</span><span class="p">(</span><span class="n">populate_existing</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
</div>
</td>
<td><p><a class="reference internal" href="../orm/queryguide.html#orm-queryguide-execution-options"><span class="std std-ref">ORM Execution Options</span></a></p>
<p><a class="reference internal" href="../orm/queryguide.html#orm-queryguide-populate-existing"><span class="std std-ref">Populate Existing</span></a></p>
</td>
</tr>
<tr class="row-odd"><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span>\
    <span class="nb">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span><span class="o">.</span>\
    <span class="n">update</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;fullname&quot;</span><span class="p">:</span> <span class="s2">&quot;Foo Bar&quot;</span><span class="p">},</span>
        <span class="n">synchronize_session</span><span class="o">=</span><span class="s2">&quot;evaluate&quot;</span>
    <span class="p">)</span></pre></div>
</div>
</td>
<td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="n">update</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span>
    <span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span><span class="o">.</span>
    <span class="n">values</span><span class="p">(</span><span class="n">fullname</span><span class="o">=</span><span class="s2">&quot;Foo Bar&quot;</span><span class="p">)</span><span class="o">.</span>
    <span class="n">execution_options</span><span class="p">(</span><span class="n">synchronize_session</span><span class="o">=</span><span class="s2">&quot;evaluate&quot;</span><span class="p">)</span>
<span class="p">)</span></pre></div>
</div>
</td>
<td><p><a class="reference internal" href="../orm/session_basics.html#orm-expression-update-delete"><span class="std std-ref">UPDATE and DELETE with arbitrary WHERE clause</span></a></p></td>
</tr>
<tr class="row-even"><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span></pre></div>
</div>
</td>
<td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">())</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">User</span><span class="p">))</span>
<span class="n">session</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">)))</span></pre></div>
</div>
</td>
<td><p><a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.scalar" title="sqlalchemy.orm.Session.scalar"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.scalar()</span></code></a></p></td>
</tr>
</tbody>
</table>
</div>
<section id="orm-query-unified-with-core-select">
<span id="migration-20-unify-select"></span><h3>ORM Query Unified with Core Select<a class="headerlink" href="#orm-query-unified-with-core-select" title="Permalink to this headline">¶</a></h3>
<p><strong>Synopsis</strong></p>
<p>The <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> object (as well as the <a class="reference internal" href="../orm/extensions/baked.html#sqlalchemy.ext.baked.BakedQuery" title="sqlalchemy.ext.baked.BakedQuery"><code class="xref py py-class docutils literal notranslate"><span class="pre">BakedQuery</span></code></a> and
<a class="reference internal" href="../orm/extensions/horizontal_shard.html#sqlalchemy.ext.horizontal_shard.ShardedQuery" title="sqlalchemy.ext.horizontal_shard.ShardedQuery"><code class="xref py py-class docutils literal notranslate"><span class="pre">ShardedQuery</span></code></a> extensions) become long term legacy objects,
replaced by the direct usage of the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> construct in conjunction
with the <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a> method.  Results
that are returned from <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> in the form of lists of objects
or tuples, or as scalar ORM objects are returned from <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a>
uniformly as <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Result" title="sqlalchemy.engine.Result"><code class="xref py py-class docutils literal notranslate"><span class="pre">Result</span></code></a> objects, which feature an interface
consistent with that of Core execution.</p>
<p>Legacy code examples are illustrated below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

<span class="c1"># becomes legacy use case</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;some user&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>

<span class="c1"># becomes legacy use case</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># becomes legacy use case</span>
<span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="s1">&#39;some@email.com&#39;</span><span class="p">):</span>
    <span class="c1"># ...</span>

<span class="c1"># becomes legacy use case</span>
<span class="n">users</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">joinedload</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<span class="c1"># becomes legacy use case</span>
<span class="n">users</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">from_statement</span><span class="p">(</span>
    <span class="n">text</span><span class="p">(</span><span class="s2">&quot;select * from users&quot;</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<span class="c1"># etc</span></pre></div>
</div>
<p><strong>Migration to 2.0</strong></p>
<p>Because the vast majority of an ORM application is expected to make use of
<a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> objects as well as that the <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> interface
being available does not impact the new interface, the object will stay
around in 2.0 but will no longer be part of documentation nor will it be
supported for the most part.  The <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> construct now suits
both the Core and ORM use cases, which when invoked via the <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a>
method will return ORM-oriented results, that is, ORM objects if that’s what
was requested.</p>
<p>The <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><code class="xref py py-func docutils literal notranslate"><span class="pre">Select()</span></code></a> construct <strong>adds many new methods</strong> for
compatibility with <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a>, including <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.filter" title="sqlalchemy.sql.expression.Select.filter"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.filter()</span></code></a>
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.filter_by" title="sqlalchemy.sql.expression.Select.filter_by"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.filter_by()</span></code></a>, newly reworked <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.join" title="sqlalchemy.sql.expression.Select.join"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.join()</span></code></a>
and <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.outerjoin" title="sqlalchemy.sql.expression.Select.outerjoin"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.outerjoin()</span></code></a> methods, <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.options" title="sqlalchemy.sql.expression.Select.options"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.options()</span></code></a>,
etc.    Other more supplemental methods of <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> such as
<a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query.populate_existing" title="sqlalchemy.orm.Query.populate_existing"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.populate_existing()</span></code></a> are implemented via execution options.</p>
<p>Return results are in terms of a
<a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Result" title="sqlalchemy.engine.Result"><code class="xref py py-class docutils literal notranslate"><span class="pre">Result</span></code></a> object, the new version of the SQLAlchemy
<code class="docutils literal notranslate"><span class="pre">ResultProxy</span></code> object, which also adds many new methods for compatibility
with <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a>, including <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Result.one" title="sqlalchemy.engine.Result.one"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Result.one()</span></code></a>, <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Result.all" title="sqlalchemy.engine.Result.all"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Result.all()</span></code></a>,
<a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Result.first" title="sqlalchemy.engine.Result.first"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Result.first()</span></code></a>, <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Result.one_or_none" title="sqlalchemy.engine.Result.one_or_none"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Result.one_or_none()</span></code></a>, etc.</p>
<p>The <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Result" title="sqlalchemy.engine.Result"><code class="xref py py-class docutils literal notranslate"><span class="pre">Result</span></code></a> object however does require some different calling
patterns, in that when first returned it will <strong>always return tuples</strong>
and it will <strong>not deduplicate results in memory</strong>.    In order to return
single ORM objects the way <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> does, the <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Result.scalars" title="sqlalchemy.engine.Result.scalars"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Result.scalars()</span></code></a>
modifier must be called first.  In order to return uniqued objects, as is
necessary when using joined eager loading, the <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Result.unique" title="sqlalchemy.engine.Result.unique"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Result.unique()</span></code></a>
modifier must be called first.</p>
<p>Documentation for all new features of <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> including execution
options, etc. are at <a class="reference internal" href="../orm/queryguide.html"><span class="doc">ORM Querying Guide</span></a>.</p>
<p>Below are some examples of how to migrate to <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

<span class="n">user</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;some user&quot;</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">scalar_one</span><span class="p">()</span>


<span class="c1"># get() moves to the Session directly</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

<span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="s2">&quot;some@email.case&quot;</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">scalars</span><span class="p">():</span>
    <span class="c1"># ...</span>

<span class="c1"># when using joinedload() against collections, use unique() on the result</span>
<span class="n">users</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">joinedload</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<span class="c1"># select() has ORM-ish methods like from_statement() that only work</span>
<span class="c1"># if the statement is against ORM entities</span>
<span class="n">users</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">from_statement</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;select * from users&quot;</span><span class="p">))</span>
<span class="p">)</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
</div>
<p><strong>Discussion</strong></p>
<p>The fact that SQLAlchemy has both a <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> construct
as well as a separate <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> object that features an extremely
similar, but fundamentally incompatible interface is likely the greatest
inconsistency in SQLAlchemy, one that arose as a result of small incremental
additions over time that added up to two major APIs that are divergent.</p>
<p>In SQLAlchemy’s first releases, the <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> object didn’t exist
at all.  The original idea was that the <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.Mapper" title="sqlalchemy.orm.Mapper"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapper</span></code></a> construct itself would
be able to select rows, and that <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> objects, not classes,
would be used to create the various criteria in a Core-style approach.   The
<a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> came along some months / years into SQLAlchemy’s history
as a user proposal for a new, “buildable” querying object originally called <code class="docutils literal notranslate"><span class="pre">SelectResults</span></code>
was accepted.
Concepts like a <code class="docutils literal notranslate"><span class="pre">.where()</span></code> method, which <code class="docutils literal notranslate"><span class="pre">SelectResults</span></code> called <code class="docutils literal notranslate"><span class="pre">.filter()</span></code>,
were not present in SQLAlchemy previously, and the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> construct
used only the “all-at-once” construction style that’s now deprecated
at <a class="reference internal" href="#migration-20-5284"><span class="std std-ref">select() no longer accepts varied constructor arguments, columns are passed positionally</span></a>.</p>
<p>As the new approach took off, the object evolved into the <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a>
object as new features such as being able to select individual columns,
being able to select multiple entities at once, being able to build subqueries
from a <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> object rather than from a <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-class docutils literal notranslate"><span class="pre">select</span></code></a>
object were added.   The goal became that <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> should have the
full functionality of <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-class docutils literal notranslate"><span class="pre">select</span></code></a> in that it could be composed to
build SELECT statements fully with no explicit use of <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a>
needed.   At the same time, <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> had also evolved “generative”
methods like <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.where" title="sqlalchemy.sql.expression.Select.where"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.where()</span></code></a> and <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.order_by" title="sqlalchemy.sql.expression.Select.order_by"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.order_by()</span></code></a>.</p>
<p>In modern SQLAlchemy, this goal has been achieved and the two objects are now
completely overlapping in functionality.  The major challenge to unifying these
objects was that the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> object needed to remain <strong>completely
agnostic of the ORM</strong>.  To achieve this, the vast majority of logic from
<a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> has been moved into the SQL compile phase, where
ORM-specific compiler plugins receive the
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a> construct and interpret its contents in terms of an
ORM-style query, before passing off to the core-level compiler in order to
create a SQL string.  With the advent of the new
<cite>SQL compilation caching system &lt;change_4639&gt;</cite>,
the majority of this ORM logic is also cached.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="migration_14.html#change-5159"><span class="std std-ref">ORM Query is internally unified with select, update, delete; 2.0 style execution available</span></a></p>
</div>
</section>
<section id="orm-query-get-method-moves-to-session">
<span id="migration-20-get-to-session"></span><h3>ORM Query - get() method moves to Session<a class="headerlink" href="#orm-query-get-method-moves-to-session" title="Permalink to this headline">¶</a></h3>
<p><strong>Synopsis</strong></p>
<p>The <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query.get" title="sqlalchemy.orm.Query.get"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.get()</span></code></a> method remains for legacy purposes, but the
primary interface is now the <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.get" title="sqlalchemy.orm.Session.get"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.get()</span></code></a> method:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># legacy usage</span>
<span class="n">user_obj</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span></pre></div>
</div>
<p><strong>Migration to 2.0</strong></p>
<p>In 1.4 / 2.0, the <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> object adds a new
<a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.get" title="sqlalchemy.orm.Session.get"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.get()</span></code></a> method:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1.4 / 2.0 cross-compatible use</span>
<span class="n">user_obj</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span></pre></div>
</div>
<p><strong>Discussion</strong></p>
<p>The <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> object is to be a legacy object in 2.0, as ORM
queries are now available using the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> object.  As the
<a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query.get" title="sqlalchemy.orm.Query.get"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.get()</span></code></a> method defines a special interaction with the
<a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> and does not necessarily even emit a query, it’s more
appropriate that it be part of <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a>, where it is similar
to other “identity” methods such as <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.refresh" title="sqlalchemy.orm.Session.refresh"><code class="xref py py-class docutils literal notranslate"><span class="pre">refresh</span></code></a> and
<a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.merge" title="sqlalchemy.orm.Session.merge"><code class="xref py py-class docutils literal notranslate"><span class="pre">merge</span></code></a>.</p>
<p>SQLAlchemy originally included “get()” to resemble the Hibernate
<code class="docutils literal notranslate"><span class="pre">Session.load()</span></code> method.  As is so often the case, we got it slightly
wrong as this method is really more about the <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> than
with writing a SQL query.</p>
</section>
<section id="orm-query-joining-loading-on-relationships-uses-attributes-not-strings">
<span id="migration-20-orm-query-join-strings"></span><h3>ORM Query  - Joining / loading on relationships uses attributes, not strings<a class="headerlink" href="#orm-query-joining-loading-on-relationships-uses-attributes-not-strings" title="Permalink to this headline">¶</a></h3>
<p><strong>Synopsis</strong></p>
<p>This refers to patterns such as that of <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query.join" title="sqlalchemy.orm.Query.join"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.join()</span></code></a> as well as
query options like <a class="reference internal" href="../orm/loading_relationships.html#sqlalchemy.orm.joinedload" title="sqlalchemy.orm.joinedload"><code class="xref py py-func docutils literal notranslate"><span class="pre">joinedload()</span></code></a> which currently accept a mixture of
string attribute names or actual class attributes.   The string forms
will all be removed in 2.0:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># string use removed</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;addresses&quot;</span><span class="p">)</span>

<span class="c1"># string use removed</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">joinedload</span><span class="p">(</span><span class="s2">&quot;addresess&quot;</span><span class="p">))</span>

<span class="c1"># string use removed</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">with_parent</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="s2">&quot;addresses&quot;</span><span class="p">))</span></pre></div>
</div>
<p><strong>Migration to 2.0</strong></p>
<p>Modern SQLAlchemy 1.x versions support the recommended technique which
is to use mapped attributes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># compatible with all modern SQLAlchemy versions</span>

<span class="n">q</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">)</span>

<span class="n">q</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">joinedload</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresess</span><span class="p">))</span>

<span class="n">q</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">with_parent</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">))</span></pre></div>
</div>
<p>The same techniques apply to <a class="reference internal" href="../glossary.html#term-1"><span class="xref std std-term">2.0-style</span></a> style use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># SQLAlchemy 1.4 / 2.0 cross compatible use</span>

<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>

<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">joinedload</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresess</span><span class="p">))</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>

<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">with_parent</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">))</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span></pre></div>
</div>
<p><strong>Discussion</strong></p>
<p>The string calling form is ambiguous and requires that the internals do extra
work to determine the appropriate path and retrieve the correct mapped
property. By passing the ORM mapped attribute directly, not only is the
necessary information passed up front, the attribute is also typed and is
more potentially compatible with IDEs and pep-484 integrations.</p>
</section>
<section id="orm-query-chaining-using-lists-of-attributes-rather-than-individual-calls-removed">
<h3>ORM Query - Chaining using lists of attributes, rather than individual calls, removed<a class="headerlink" href="#orm-query-chaining-using-lists-of-attributes-rather-than-individual-calls-removed" title="Permalink to this headline">¶</a></h3>
<p><strong>Synopsis</strong></p>
<p>“Chained” forms of joining and loader options which accept multiple mapped
attributes in a list will be removed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># chaining removed</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;orders&quot;</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">,</span> <span class="s2">&quot;keywords&quot;</span><span class="p">)</span></pre></div>
</div>
<p><strong>Migration to 2.0</strong></p>
<p>Use individual calls to <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query.join" title="sqlalchemy.orm.Query.join"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.join()</span></code></a> for 1.x /2.0 cross compatible
use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">q</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">orders</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Order</span><span class="o">.</span><span class="n">items</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Item</span><span class="o">.</span><span class="n">keywords</span><span class="p">)</span></pre></div>
</div>
<p>For <a class="reference internal" href="../glossary.html#term-1"><span class="xref std std-term">2.0-style</span></a> use, <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a> has the same behavior of
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.join" title="sqlalchemy.sql.expression.Select.join"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.join()</span></code></a>, and also features a new <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.join_from" title="sqlalchemy.sql.expression.Select.join_from"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.join_from()</span></code></a>
method that allows an explicit left side:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1.4 / 2.0 cross compatible</span>

<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">orders</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Order</span><span class="o">.</span><span class="n">items</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Item</span><span class="o">.</span><span class="n">keywords</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>

<span class="c1"># join_from can also be helpful</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">join_from</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">Order</span><span class="p">)</span><span class="o">.</span><span class="n">join_from</span><span class="p">(</span><span class="n">Order</span><span class="p">,</span> <span class="n">Item</span><span class="p">,</span> <span class="n">Order</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span></pre></div>
</div>
<p><strong>Discussion</strong></p>
<p>Removing the chaining of attributes is in line with simplifying the calling
interface of methods such as <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.join" title="sqlalchemy.sql.expression.Select.join"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.join()</span></code></a>.</p>
</section>
<section id="orm-query-join-aliased-true-from-joinpoint-removed">
<span id="migration-20-query-join-options"></span><h3>ORM Query - join(…, aliased=True), from_joinpoint removed<a class="headerlink" href="#orm-query-join-aliased-true-from-joinpoint-removed" title="Permalink to this headline">¶</a></h3>
<p><strong>Synopsis</strong></p>
<p>The <code class="docutils literal notranslate"><span class="pre">aliased=True</span></code> option on <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query.join" title="sqlalchemy.orm.Query.join"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.join()</span></code></a> is removed, as is
the <code class="docutils literal notranslate"><span class="pre">from_joinpoint</span></code> flag:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># no longer supported</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Node</span><span class="p">)</span><span class="o">.</span>\
  <span class="n">join</span><span class="p">(</span><span class="s2">&quot;children&quot;</span><span class="p">,</span> <span class="n">aliased</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Node</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;some sub child&quot;</span><span class="p">)</span><span class="o">.</span>
  <span class="n">join</span><span class="p">(</span><span class="s2">&quot;children&quot;</span><span class="p">,</span> <span class="n">from_joinpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">aliased</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span>\
  <span class="nb">filter</span><span class="p">(</span><span class="n">Node</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;some sub sub child&#39;</span><span class="p">)</span></pre></div>
</div>
<p><strong>Migration to 2.0</strong></p>
<p>Use explicit aliases instead:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">n1</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">Node</span><span class="p">)</span>
<span class="n">n2</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">Node</span><span class="p">)</span>

<span class="n">q</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">Node</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Node</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">of_type</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span><span class="o">.</span>\
    <span class="n">where</span><span class="p">(</span><span class="n">n1</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;some sub child&quot;</span><span class="p">)</span><span class="o">.</span>\
    <span class="n">join</span><span class="p">(</span><span class="n">n1</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">of_type</span><span class="p">(</span><span class="n">n2</span><span class="p">))</span><span class="o">.</span>\
    <span class="n">where</span><span class="p">(</span><span class="n">n2</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;some sub child&quot;</span><span class="p">)</span></pre></div>
</div>
<p><strong>Discussion</strong></p>
<p>The <code class="docutils literal notranslate"><span class="pre">aliased=True</span></code> option on <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query.join" title="sqlalchemy.orm.Query.join"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.join()</span></code></a> is another feature that
seems to be almost never used, based on extensive code searches to find
actual use of this feature.   The internal complexity that the <code class="docutils literal notranslate"><span class="pre">aliased=True</span></code>
flag requires is <strong>enormous</strong>, and will be going away in 2.0.</p>
<p>Most users aren’t familiar with this flag, however it allows for automatic
aliasing of elements along a join, which then applies automatic aliasing
to filter conditions.  The original use case was to assist in long chains
of self-referential joins, as in the example shown above.  However,
the automatic adaption of the filter criteria is enormously
complicated internally and almost never used in real world applications.  The
pattern also leads to issues such as if filter criteria need to be added
at each link in the chain; the pattern then must use the <code class="docutils literal notranslate"><span class="pre">from_joinpoint</span></code>
flag which SQLAlchemy developers could absolutely find no occurrence of this
parameter ever being used in real world applications.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">aliased=True</span></code> and <code class="docutils literal notranslate"><span class="pre">from_joinpoint</span></code> parameters were developed at a time
when the <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> object didn’t yet have good capabilities regarding
joining along relationship attributes, functions like
<a class="reference internal" href="../orm/internals.html#sqlalchemy.orm.PropComparator.of_type" title="sqlalchemy.orm.PropComparator.of_type"><code class="xref py py-meth docutils literal notranslate"><span class="pre">PropComparator.of_type()</span></code></a> did not exist, and the <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.aliased" title="sqlalchemy.orm.aliased"><code class="xref py py-func docutils literal notranslate"><span class="pre">aliased()</span></code></a>
construct itself didn’t exist early on.</p>
</section>
<section id="using-distinct-with-additional-columns-but-only-select-the-entity">
<span id="migration-20-query-distinct"></span><h3>Using DISTINCT with additional columns, but only select the entity<a class="headerlink" href="#using-distinct-with-additional-columns-but-only-select-the-entity" title="Permalink to this headline">¶</a></h3>
<p><strong>Synopsis</strong></p>
<p><a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> will automatically add columns in the ORDER BY when
distinct is used.  The following query will select from all User columns
as well as “address.email_address” but only return User objects:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1.xx code</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">)</span><span class="o">.</span>\
    <span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">email_address</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
</div>
<p>In version 2.0, the “email_address” column will not be automatically added
to the columns clause, and the above query will fail, since relational
databases won’t allow you to ORDER BY “address.email_address” when using
DISTINCT if it isn’t also in the columns clause.</p>
<p><strong>Migration to 2.0</strong></p>
<p>In 2.0, the column must be added explicitly.  To resolve the issue of only
returning the main entity object, and not the extra column, use the
<a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Result.columns" title="sqlalchemy.engine.Result.columns"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Result.columns()</span></code></a> method:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1.4 / 2.0 code</span>

<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">Address</span><span class="o">.</span><span class="n">email_address</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">)</span><span class="o">.</span>\
    <span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">email_address</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
</div>
<p><strong>Discussion</strong></p>
<p>This case is an example of the limited flexibility of <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a>
leading to the case where implicit, “magical” behavior needed to be added;
the “email_address” column is implicitly added to the columns clause, then
additional internal logic would omit that column from the actual results
returned.</p>
<p>The new approach simplifies the interaction and makes what’s going on
explicit, while still making it possible to fulfill the original use case
without inconvenience.</p>
</section>
<section id="selecting-from-the-query-itself-as-a-subquery-e-g-from-self">
<span id="migration-20-query-from-self"></span><h3>Selecting from the query itself as a subquery, e.g. “from_self()”<a class="headerlink" href="#selecting-from-the-query-itself-as-a-subquery-e-g-from-self" title="Permalink to this headline">¶</a></h3>
<p><strong>Synopsis</strong></p>
<p>The <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query.from_self" title="sqlalchemy.orm.Query.from_self"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.from_self()</span></code></a> method will be removed from <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># from_self is removed</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">Address</span><span class="o">.</span><span class="n">email_address</span><span class="p">)</span><span class="o">.</span>\
  <span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">)</span><span class="o">.</span>\
  <span class="n">from_self</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">email_address</span><span class="p">)</span></pre></div>
</div>
<p><strong>Migration to 2.0</strong></p>
<p>The <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.aliased" title="sqlalchemy.orm.aliased"><code class="xref py py-func docutils literal notranslate"><span class="pre">aliased()</span></code></a> construct may be used to emit ORM queries against
an entity that is in terms of any arbitrary selectable.   It has been enhanced
in version 1.4 to smoothly accommodate being used multiple times against
the same subquery for different entities as well.  This can be
used in <a class="reference internal" href="../glossary.html#term-1.x-style"><span class="xref std std-term">1.x style</span></a> with <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> as below; note that
since the final query wants to query in terms of both the <code class="docutils literal notranslate"><span class="pre">User</span></code> and
<code class="docutils literal notranslate"><span class="pre">Address</span></code> entities, two separate <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.aliased" title="sqlalchemy.orm.aliased"><code class="xref py py-func docutils literal notranslate"><span class="pre">aliased()</span></code></a> constructs are created:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">aliased</span>

<span class="n">subq</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">Address</span><span class="o">.</span><span class="n">email_address</span><span class="p">)</span><span class="o">.</span>\
  <span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">)</span><span class="o">.</span><span class="n">subquery</span><span class="p">()</span>

<span class="n">ua</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">subq</span><span class="p">)</span>

<span class="n">aa</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">Address</span><span class="p">,</span> <span class="n">subq</span><span class="p">)</span>

<span class="n">q</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">ua</span><span class="p">,</span> <span class="n">aa</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">aa</span><span class="o">.</span><span class="n">email_address</span><span class="p">)</span></pre></div>
</div>
<p>The same form may be used in <a class="reference internal" href="../glossary.html#term-2.0-style"><span class="xref std std-term">2.0 style</span></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">aliased</span>

<span class="n">subq</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">Address</span><span class="o">.</span><span class="n">email_address</span><span class="p">)</span><span class="o">.</span>\
  <span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">)</span><span class="o">.</span><span class="n">subquery</span><span class="p">()</span>

<span class="n">ua</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">subq</span><span class="p">)</span>

<span class="n">aa</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">Address</span><span class="p">,</span> <span class="n">subq</span><span class="p">)</span>

<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">ua</span><span class="p">,</span> <span class="n">aa</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">aa</span><span class="o">.</span><span class="n">email_address</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span></pre></div>
</div>
<p><strong>Discussion</strong></p>
<p>The <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query.from_self" title="sqlalchemy.orm.Query.from_self"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.from_self()</span></code></a> method is a very complicated method that is rarely
used.   The purpose of this method is to convert a <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> into a
subquery, then return a new <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> which SELECTs from that subquery.
The elaborate aspect of this method is that the returned query applies
automatic translation of ORM entities and columns to be stated in the SELECT in
terms of the subquery, as well as that it allows the entities and columns to be
SELECTed from to be modified.</p>
<p>Because <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query.from_self" title="sqlalchemy.orm.Query.from_self"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.from_self()</span></code></a> packs an intense amount of implicit
translation into the SQL it produces, while it does allow a certain kind of
pattern to be executed very succinctly, real world use of this method is
infrequent as it is not simple to understand.</p>
<p>The new approach makes use of the <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.aliased" title="sqlalchemy.orm.aliased"><code class="xref py py-func docutils literal notranslate"><span class="pre">aliased()</span></code></a> construct so that the
ORM internals don’t need to guess which entities and columns should be adapted
and in what way; in the example above, the <code class="docutils literal notranslate"><span class="pre">ua</span></code> and <code class="docutils literal notranslate"><span class="pre">aa</span></code> objects, both
of which are <code class="xref py py-class docutils literal notranslate"><span class="pre">AliasedClass</span></code> instances, provide to the internals
an unambiguous marker as to where the subquery should be referred towards
as well as what entity column or relationship is being considered for a given
component of the query.</p>
<p>SQLAlchemy 1.4 also features an improved labeling style that no longer requires
the use of long labels that include the table name in order to disambiguate
columns of same names from different tables.  In the above examples, even if
our <code class="docutils literal notranslate"><span class="pre">User</span></code> and <code class="docutils literal notranslate"><span class="pre">Address</span></code> entities have overlapping column names, we can
select from both entities at once without having to specify any particular
labeling:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1.4 / 2.0 code</span>

<span class="n">subq</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">Address</span><span class="p">)</span><span class="o">.</span>\
    <span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">)</span><span class="o">.</span><span class="n">subquery</span><span class="p">()</span>

<span class="n">ua</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">subq</span><span class="p">)</span>
<span class="n">aa</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">Address</span><span class="p">,</span> <span class="n">subq</span><span class="p">)</span>

<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">ua</span><span class="p">,</span> <span class="n">aa</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">aa</span><span class="o">.</span><span class="n">email_address</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span></pre></div>
</div>
<p>The above query will disambiguate the <code class="docutils literal notranslate"><span class="pre">.id</span></code> column of <code class="docutils literal notranslate"><span class="pre">User</span></code> and
<code class="docutils literal notranslate"><span class="pre">Address</span></code>, where <code class="docutils literal notranslate"><span class="pre">Address.id</span></code> is rendered and tracked as <code class="docutils literal notranslate"><span class="pre">id_1</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">anon_1</span><span class="o">.</span><span class="n">id</span> <span class="n">AS</span> <span class="n">anon_1_id</span><span class="p">,</span> <span class="n">anon_1</span><span class="o">.</span><span class="n">id_1</span> <span class="n">AS</span> <span class="n">anon_1_id_1</span><span class="p">,</span>
       <span class="n">anon_1</span><span class="o">.</span><span class="n">user_id</span> <span class="n">AS</span> <span class="n">anon_1_user_id</span><span class="p">,</span>
       <span class="n">anon_1</span><span class="o">.</span><span class="n">email_address</span> <span class="n">AS</span> <span class="n">anon_1_email_address</span>
<span class="n">FROM</span> <span class="p">(</span>
  <span class="n">SELECT</span> <span class="s2">&quot;user&quot;</span><span class="o">.</span><span class="n">id</span> <span class="n">AS</span> <span class="nb">id</span><span class="p">,</span> <span class="n">address</span><span class="o">.</span><span class="n">id</span> <span class="n">AS</span> <span class="n">id_1</span><span class="p">,</span>
  <span class="n">address</span><span class="o">.</span><span class="n">user_id</span> <span class="n">AS</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">address</span><span class="o">.</span><span class="n">email_address</span> <span class="n">AS</span> <span class="n">email_address</span>
  <span class="n">FROM</span> <span class="s2">&quot;user&quot;</span> <span class="n">JOIN</span> <span class="n">address</span> <span class="n">ON</span> <span class="s2">&quot;user&quot;</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">address</span><span class="o">.</span><span class="n">user_id</span>
<span class="p">)</span> <span class="n">AS</span> <span class="n">anon_1</span> <span class="n">ORDER</span> <span class="n">BY</span> <span class="n">anon_1</span><span class="o">.</span><span class="n">email_address</span></pre></div>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/5221">#5221</a></p>
</section>
<section id="selecting-entities-from-alternative-selectables-query-select-entity-from">
<h3>Selecting entities from alternative selectables; Query.select_entity_from()<a class="headerlink" href="#selecting-entities-from-alternative-selectables-query-select-entity-from" title="Permalink to this headline">¶</a></h3>
<p><strong>Synopsis</strong></p>
<p>The <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query.select_entity_from" title="sqlalchemy.orm.Query.select_entity_from"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.select_entity_from()</span></code></a> method will be removed in 2.0:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">subquery</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">subquery</span><span class="p">()</span>

<span class="n">user</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">select_entity_from</span><span class="p">(</span><span class="n">subquery</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span></pre></div>
</div>
<p><strong>Migration to 2.0</strong></p>
<p>As is the case described at <a class="reference internal" href="#migration-20-query-from-self"><span class="std std-ref">Selecting from the query itself as a subquery, e.g. “from_self()”</span></a>, the
<a class="reference internal" href="../orm/query.html#sqlalchemy.orm.aliased" title="sqlalchemy.orm.aliased"><code class="xref py py-func docutils literal notranslate"><span class="pre">aliased()</span></code></a> object provides a single place that operations like
“select entity from a subquery” may be achieved.  Using <a class="reference internal" href="../glossary.html#term-1.x-style"><span class="xref std std-term">1.x style</span></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">aliased</span>

<span class="n">subquery</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">subquery</span><span class="p">()</span>

<span class="n">ua</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">subquery</span><span class="p">)</span>

<span class="n">user</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">ua</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span></pre></div>
</div>
<p>Using <a class="reference internal" href="../glossary.html#term-2.0-style"><span class="xref std std-term">2.0 style</span></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">aliased</span>

<span class="n">subquery</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">subquery</span><span class="p">()</span>

<span class="n">ua</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">subquery</span><span class="p">)</span>

<span class="n">user</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">ua</span><span class="p">))</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span><span class="o">.</span><span class="n">first</span><span class="p">()</span></pre></div>
</div>
<p><strong>Discussion</strong></p>
<p>The points here are basically the same as those discussed at
<a class="reference internal" href="#migration-20-query-from-self"><span class="std std-ref">Selecting from the query itself as a subquery, e.g. “from_self()”</span></a>.   The <code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.select_from_entity()</span></code>
method was another way to instruct the query to load rows for a particular
ORM mapped entity from an alternate selectable, which involved having the
ORM apply automatic aliasing to that entity wherever it was used in the
query later on, such as in the WHERE clause or ORDER BY.   This intensely
complex feature is seldom used in this way, where as was the case with
<a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query.from_self" title="sqlalchemy.orm.Query.from_self"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.from_self()</span></code></a>, it’s much easier to follow what’s going on
when using an explicit <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.aliased" title="sqlalchemy.orm.aliased"><code class="xref py py-func docutils literal notranslate"><span class="pre">aliased()</span></code></a> object, both from a user point
of view as well as how the internals of the SQLAlchemy ORM must handle it.</p>
</section>
<section id="orm-rows-not-uniquified-by-default">
<span id="joinedload-not-uniqued"></span><h3>ORM Rows not uniquified by default<a class="headerlink" href="#orm-rows-not-uniquified-by-default" title="Permalink to this headline">¶</a></h3>
<p><strong>Synopsis</strong></p>
<p>ORM rows returned by <code class="docutils literal notranslate"><span class="pre">session.execute(stmt)</span></code> are no longer automatically
“uniqued”.    This will normally be a welcome change, except in the case
where the “joined eager loading” loader strategy is used with collections:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># In the legacy API, many rows each have the same User primary key, but</span>
<span class="c1"># only one User per primary key is returned</span>
<span class="n">users</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">joinedload</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">))</span>

<span class="c1"># In the new API, uniquing is available but not implicitly</span>
<span class="c1"># enabled</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
    <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">joinedload</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">))</span>
<span class="p">)</span>

<span class="c1"># this actually will raise an error to let the user know that</span>
<span class="c1"># uniquing should be applied</span>
<span class="n">rows</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
</div>
<p><strong>Migrating to 2.0</strong></p>
<p>When using a joined load of a collection, it’s required that the
<a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Result.unique" title="sqlalchemy.engine.Result.unique"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Result.unique()</span></code></a> method is called.  The ORM will actually set
a default row handler that will raise an error if this is not done, to
ensure that a joined eager load collection does not return duplicate rows
while still maintaining explicitness:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1.4 / 2.0 code</span>

<span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">joinedload</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">))</span>

<span class="c1"># statement will raise if unique() is not used, due to joinedload()</span>
<span class="c1"># of a collection.  in all other cases, unique() is not needed.</span>
<span class="c1"># By stating unique() explicitly, confusion over discrepancies between</span>
<span class="c1"># number of objects/ rows returned vs. &quot;SELECT COUNT(*)&quot; is resolved</span>
<span class="n">rows</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
</div>
<p><strong>Discussion</strong></p>
<p>The situation here is a little bit unusual, in that SQLAlchemy is requiring
that a method be invoked that it is in fact entirely capable of doing
automatically.   The reason for requiring that the method be called is to
ensure the developer is “opting in” to the use of the
<a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Result.unique" title="sqlalchemy.engine.Result.unique"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Result.unique()</span></code></a> method, such that they will not be confused when
a straight count of rows does not conflict with the count of
records in the actual result set, which has been a long running source of
user confusion and bug reports for many years.    That the uniquifying is
not happening in any other case by default will improve performance and
also improve clarity in those cases where automatic uniquing was causing
confusing results.</p>
<p>To the degree that having to call <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Result.unique" title="sqlalchemy.engine.Result.unique"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Result.unique()</span></code></a> when joined
eager load collections are used is inconvenient, in modern SQLAlchemy
the <a class="reference internal" href="../orm/loading_relationships.html#sqlalchemy.orm.selectinload" title="sqlalchemy.orm.selectinload"><code class="xref py py-func docutils literal notranslate"><span class="pre">selectinload()</span></code></a> strategy presents a collection-oriented
eager loader that is superior in most respects to <a class="reference internal" href="../orm/loading_relationships.html#sqlalchemy.orm.joinedload" title="sqlalchemy.orm.joinedload"><code class="xref py py-func docutils literal notranslate"><span class="pre">joinedload()</span></code></a>
and should be preferred.</p>
</section>
<section id="autocommit-mode-removed-from-session-autobegin-support-added">
<h3>Autocommit mode removed from Session; autobegin support added<a class="headerlink" href="#autocommit-mode-removed-from-session-autobegin-support-added" title="Permalink to this headline">¶</a></h3>
<p><strong>Synopsis</strong></p>
<p>The <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> will no longer support “autocommit” mode, that
is, this pattern:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Session</span>

<span class="n">sess</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">autocommit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># no transaction begun, but emits SQL, won&#39;t be supported</span>
<span class="n">obj</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Class</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>


<span class="c1"># session flushes in a transaction that it begins and</span>
<span class="c1"># commits, won&#39;t be supported</span>
<span class="n">sess</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></pre></div>
</div>
<p><strong>Migration to 2.0</strong></p>
<p>The main reason a <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> is used in “autocommit” mode
is so that the <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.begin" title="sqlalchemy.orm.Session.begin"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.begin()</span></code></a> method is available, so that framework
integrations and event hooks can control when this event happens.  In 1.4,
the <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> now features <a class="reference internal" href="migration_14.html#change-5074"><span class="std std-ref">autobegin behavior</span></a>
which resolves this issue; the <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.begin" title="sqlalchemy.orm.Session.begin"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.begin()</span></code></a> method may now
be called:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Session</span>

<span class="n">sess</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

<span class="n">sess</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>  <span class="c1"># begin explicitly; if not called, will autobegin</span>
              <span class="c1"># when database access is needed</span>

<span class="n">sess</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

<span class="n">sess</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></pre></div>
</div>
<p><strong>Discussion</strong></p>
<p>The “autocommit” mode is another holdover from the first versions
of SQLAlchemy.  The flag has stayed around mostly in support of allowing
explicit use of <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.begin" title="sqlalchemy.orm.Session.begin"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.begin()</span></code></a>, which is now solved by 1.4,
as well as to allow the use of “subtransactions”, which are also removed in
2.0.</p>
</section>
<section id="session-subtransaction-behavior-removed">
<h3>Session “subtransaction” behavior removed<a class="headerlink" href="#session-subtransaction-behavior-removed" title="Permalink to this headline">¶</a></h3>
<p>See the section <a class="reference internal" href="../orm/session_transaction.html#session-subtransactions"><span class="std std-ref">Migrating from the “subtransaction” pattern</span></a> for background on this
change.</p>
</section>
</section>
<section id="migration-orm-extension-and-recipe-changes">
<h2>2.0 Migration - ORM Extension and Recipe Changes<a class="headerlink" href="#migration-orm-extension-and-recipe-changes" title="Permalink to this headline">¶</a></h2>
<section id="dogpile-cache-recipe-and-horizontal-sharding-uses-new-session-api">
<h3>Dogpile cache recipe and Horizontal Sharding uses new Session API<a class="headerlink" href="#dogpile-cache-recipe-and-horizontal-sharding-uses-new-session-api" title="Permalink to this headline">¶</a></h3>
<p>As the <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> object becomes legacy, these two recipes
which previously relied upon subclassing of the <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a>
object now make use of the <a class="reference internal" href="../orm/events.html#sqlalchemy.orm.SessionEvents.do_orm_execute" title="sqlalchemy.orm.SessionEvents.do_orm_execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">SessionEvents.do_orm_execute()</span></code></a>
hook.    See the section <a class="reference internal" href="../orm/session_events.html#do-orm-execute-re-executing"><span class="std std-ref">Re-Executing Statements</span></a> for
an example.</p>
</section>
<section id="baked-query-extension-superseded-by-built-in-caching">
<h3>Baked Query Extension Superseded by built-in caching<a class="headerlink" href="#baked-query-extension-superseded-by-built-in-caching" title="Permalink to this headline">¶</a></h3>
<p>The baked query extension is superseded by the built in caching system and
is no longer used by the ORM internals.</p>
<p>See <a class="reference internal" href="../core/connections.html#sql-caching"><span class="std std-ref">SQL Compilation Caching</span></a> for full background on the new caching system.</p>
</section>
</section>
<section id="asyncio-support">
<h2>Asyncio Support<a class="headerlink" href="#asyncio-support" title="Permalink to this headline">¶</a></h2>
<p>SQLAlchemy 1.4 includes asyncio support for both Core and ORM.
The new API exclusively makes use of the “future” patterns noted above.
See <a class="reference internal" href="migration_14.html#change-3414"><span class="std std-ref">Asynchronous IO Support for Core and ORM</span></a> for background.</p>
</section>
</section>

    </div>

</div>

<div id="docs-bottom-navigation" class="docs-navigation-links, withsidebar">
        Previous:
        <a href="migration_14.html" title="previous chapter">What’s New in SQLAlchemy 1.4?</a>
        Next:
        <a href="changelog_14.html" title="next chapter">1.4 Changelog</a>

    <div id="docs-copyright">
        &copy; <a href="../copyright.html">Copyright</a> 2007-2021, the SQLAlchemy authors and contributors.


    <p><b>flambé!</b> the dragon and <b><i>The Alchemist</i></b> image designs created and generously donated by <a href="https://github.com/vmalloc">Rotem Yaari</a>.</p>

        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 4.1.2.
    </div>
</div>

</div>



        
        

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
          URL_ROOT:    '../',
          VERSION:     '1.4.23',
          COLLAPSE_MODINDEX: false,
          FILE_SUFFIX: '.html'
      };
    </script>

    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>

    <!-- begin iterate through sphinx environment script_files -->
        <script type="text/javascript" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    <!-- end iterate through sphinx environment script_files -->

    <script type="text/javascript" src="../_static/detectmobile.js"></script>
    <script type="text/javascript" src="../_static/init.js"></script>


    </body>
</html>


