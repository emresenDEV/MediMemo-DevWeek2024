<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">



<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

        <title>
            
    
    Selecting Rows with Core or ORM
 &mdash;
    SQLAlchemy 1.4 Documentation

        </title>

        
            <!-- begin iterate through site-imported + sphinx environment css_files -->
                <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../_static/default.css" type="text/css" />
                <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
                <link rel="stylesheet" href="../_static/changelog.css" type="text/css" />
                <link rel="stylesheet" href="../_static/sphinx_paramlinks.css" type="text/css" />
            <!-- end iterate through site-imported + sphinx environment css_files -->
        

        

    

    <!-- begin layout.mako headers -->

    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
        <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="SQLAlchemy 1.4 Documentation" href="../index.html" />
        <link rel="up" title="Working with Data" href="data.html" />
        <link rel="next" title="Updating and Deleting Rows with Core" href="data_update.html" />
        <link rel="prev" title="Inserting Rows with Core" href="data_insert.html" />
    <!-- end layout.mako headers -->


    </head>
    <body>
        
















<div id="docs-container">





<div id="docs-top-navigation-container" class="body-background">
<div id="docs-header">
    <div id="docs-version-header">
        Release: <span class="version-num">1.4.23</span>


        | Release Date: August 18, 2021

    </div>

    <h1><a href="../index.html">SQLAlchemy 1.4 Documentation</a></h1>

</div>
</div>

<div id="docs-body-container">

    <div id="fixed-sidebar" class="withsidebar">


        <div id="docs-sidebar-popout">
            <h3><a href="../index.html">SQLAlchemy 1.4 Documentation</a></h3>
            <p id="sidebar-topnav">
                <a href="../contents.html">Contents</a> |
                <a href="../genindex.html">Index</a>
            </p>

            <div id="sidebar-search">
                <form class="search" action="../search.html" method="get">
                  <label>
                  Search terms:
                  <input type="text" placeholder="search..." name="q" size="12" />
                  </label>
                  <input type="hidden" name="check_keywords" value="yes" />
                  <input type="hidden" name="area" value="default" />
                </form>
            </div>

        </div>

        <div id="docs-sidebar">

        <div id="sidebar-banner">
            
        </div>

        <div id="docs-sidebar-inner">

        
        <h3>
            <a href="index.html" title="SQLAlchemy 1.4 / 2.0 Tutorial">SQLAlchemy 1.4 / 2.0 Tutorial</a>
        </h3>

        <ul>
<li><span class="link-container"><a class="reference external" href="engine.html">Establishing Connectivity - the Engine</a></span></li>
<li><span class="link-container"><a class="reference external" href="dbapi_transactions.html">Working with Transactions and the DBAPI</a></span></li>
<li><span class="link-container"><a class="reference external" href="metadata.html">Working with Database Metadata</a></span></li>
<li><span class="link-container"><a class="reference external" href="data.html">Working with Data</a></span><ul>
<li><span class="link-container"><a class="reference external" href="data_insert.html">Inserting Rows with Core</a></span></li>
<li class="selected"><span class="link-container"><strong>Selecting Rows with Core or ORM</strong><a class="paramlink headerlink reference internal" href="#">¶</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#the-select-sql-expression-construct">The select() SQL Expression Construct</a></span></li>
<li><span class="link-container"><a class="reference external" href="#setting-the-columns-and-from-clause">Setting the COLUMNS and FROM clause</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#selecting-orm-entities-and-columns">Selecting ORM Entities and Columns</a></span></li>
<li><span class="link-container"><a class="reference external" href="#selecting-from-labeled-sql-expressions">Selecting from Labeled SQL Expressions</a></span></li>
<li><span class="link-container"><a class="reference external" href="#selecting-with-textual-column-expressions">Selecting with Textual Column Expressions</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#the-where-clause">The WHERE clause</a></span></li>
<li><span class="link-container"><a class="reference external" href="#explicit-from-clauses-and-joins">Explicit FROM clauses and JOINs</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#setting-the-on-clause">Setting the ON Clause</a></span></li>
<li><span class="link-container"><a class="reference external" href="#outer-and-full-join">OUTER and FULL join</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#order-by-group-by-having">ORDER BY, GROUP BY, HAVING</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#order-by">ORDER BY</a></span></li>
<li><span class="link-container"><a class="reference external" href="#aggregate-functions-with-group-by-having">Aggregate functions with GROUP BY / HAVING</a></span></li>
<li><span class="link-container"><a class="reference external" href="#ordering-or-grouping-by-a-label">Ordering or Grouping by a Label</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#using-aliases">Using Aliases</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#orm-entity-aliases">ORM Entity Aliases</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#subqueries-and-ctes">Subqueries and CTEs</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#common-table-expressions-ctes">Common Table Expressions (CTEs)</a></span></li>
<li><span class="link-container"><a class="reference external" href="#orm-entity-subqueries-ctes">ORM Entity Subqueries/CTEs</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="#scalar-and-correlated-subqueries">Scalar and Correlated Subqueries</a></span></li>
<li><span class="link-container"><a class="reference external" href="#union-union-all-and-other-set-operations">UNION, UNION ALL and other set operations</a></span></li>
<li><span class="link-container"><a class="reference external" href="#exists-subqueries">EXISTS subqueries</a></span></li>
<li><span class="link-container"><a class="reference external" href="#working-with-sql-functions">Working with SQL Functions</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#functions-have-return-types">Functions Have Return Types</a></span></li>
<li><span class="link-container"><a class="reference external" href="#built-in-functions-have-pre-configured-return-types">Built-in Functions Have Pre-Configured Return Types</a></span></li>
<li><span class="link-container"><a class="reference external" href="#using-window-functions">Using Window Functions</a></span></li>
<li><span class="link-container"><a class="reference external" href="#special-modifiers-within-group-filter">Special Modifiers WITHIN GROUP, FILTER</a></span></li>
<li><span class="link-container"><a class="reference external" href="#table-valued-functions">Table-Valued Functions</a></span></li>
<li><span class="link-container"><a class="reference external" href="#column-valued-functions-table-valued-function-as-a-scalar-column">Column Valued Functions - Table Valued Function as a Scalar Column</a></span></li>
</ul>
</li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="data_update.html">Updating and Deleting Rows with Core</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="orm_data_manipulation.html">Data Manipulation with the ORM</a></span></li>
<li><span class="link-container"><a class="reference external" href="orm_related_objects.html">Working with Related Objects</a></span></li>
<li><span class="link-container"><a class="reference external" href="further_reading.html">Further Reading</a></span></li>
</ul>



        </div>

        </div>

    </div>

    

    <div id="docs-body" class="withsidebar tutorial-data_select" >
        
<div class="topic">
<p class="topic-title">SQLAlchemy 1.4 / 2.0 Tutorial</p>
<p>This page is part of the <a class="reference internal" href="index.html"><span class="doc">SQLAlchemy 1.4 / 2.0 Tutorial</span></a>.</p>
<p>Previous: <a class="reference internal" href="data_insert.html"><span class="doc">Inserting Rows with Core</span></a>   |   Next: <a class="reference internal" href="data_update.html"><span class="doc">Updating and Deleting Rows with Core</span></a></p>
</div>
<section class="core-header orm-dependency" id="selecting-rows-with-core-or-orm">
<span id="tutorial-selecting-data"></span><h1>Selecting Rows with Core or ORM<a class="headerlink" href="#selecting-rows-with-core-or-orm" title="Permalink to this headline">¶</a></h1>
<p>For both Core and ORM, the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> function generates a
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a> construct which is used for all SELECT queries.
Passed to methods like <a class="reference internal" href="../core/future.html#sqlalchemy.future.Connection.execute" title="sqlalchemy.future.Connection.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.execute()</span></code></a> in Core and
<a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a> in ORM, a SELECT statement is emitted in the
current transaction and the result rows available via the returned
<a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Result" title="sqlalchemy.engine.Result"><code class="xref py py-class docutils literal notranslate"><span class="pre">Result</span></code></a> object.</p>
<div class="orm-header docutils container">
<p><strong>ORM Readers</strong> - the content here applies equally well to both Core and ORM
use and basic ORM variant use cases are mentioned here.  However there are
a lot more ORM-specific features available as well; these are documented
at <a class="reference internal" href="../orm/queryguide.html"><span class="std std-ref">ORM Querying Guide</span></a>.</p>
</div>
<section id="the-select-sql-expression-construct">
<h2>The select() SQL Expression Construct<a class="headerlink" href="#the-select-sql-expression-construct" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> construct builds up a statement in the same way
as that of <a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.insert" title="sqlalchemy.sql.expression.insert"><code class="xref py py-func docutils literal notranslate"><span class="pre">insert()</span></code></a>, using a <a class="reference internal" href="../glossary.html#term-generative"><span class="xref std std-term">generative</span></a> approach where
each method builds more state onto the object.  Like the other SQL constructs,
it can be stringified in place:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">select</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">user_table</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;spongebob&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<div class='show_sql'><span class="k">SELECT</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">fullname</span>
<span class="k">FROM</span> <span class="n">user_account</span>
<span class="k">WHERE</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">:</span><span class="n">name_1</span>
</div></pre></div>
</div>
<p>Also in the same manner as all other statement-level SQL constructs, to
actually run the statement we pass it to an execution method.
Since a SELECT statement returns
rows we can always iterate the result object to get <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Row" title="sqlalchemy.engine.Row"><code class="xref py py-class docutils literal notranslate"><span class="pre">Row</span></code></a>
objects back:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">):</span>
<span class="gp">... </span>        <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
<div class='show_sql'><span class="k">BEGIN</span> <span class="p">(</span><span class="k">implicit</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">fullname</span>
<span class="k">FROM</span> <span class="n">user_account</span>
<span class="k">WHERE</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="o">?</span>
<span class="p">[...]</span> <span class="p">(</span><span class="s1">&#39;spongebob&#39;</span><span class="p">,)</span>
</div><span class="go">(1, &#39;spongebob&#39;, &#39;Spongebob Squarepants&#39;)</span>
<div class='show_sql'><span class="k">ROLLBACK</span>
</div></pre></div>
</div>
<p>When using the ORM, particularly with a <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> construct that’s
composed against ORM entities, we will want to execute it using the
<a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a> method on the <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a>; using
this approach, we continue to get <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Row" title="sqlalchemy.engine.Row"><code class="xref py py-class docutils literal notranslate"><span class="pre">Row</span></code></a> objects from the
result, however these rows are now capable of including
complete entities, such as instances of the <code class="docutils literal notranslate"><span class="pre">User</span></code> class, as individual
elements within each row:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;spongebob&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">):</span>
<span class="gp">... </span>        <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
<div class='show_sql'><span class="k">BEGIN</span> <span class="p">(</span><span class="k">implicit</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">fullname</span>
<span class="k">FROM</span> <span class="n">user_account</span>
<span class="k">WHERE</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="o">?</span>
<span class="p">[...]</span> <span class="p">(</span><span class="s1">&#39;spongebob&#39;</span><span class="p">,)</span>
</div><span class="go">(User(id=1, name=&#39;spongebob&#39;, fullname=&#39;Spongebob Squarepants&#39;),)</span>
<div class='show_sql'><span class="k">ROLLBACK</span>
</div></pre></div>
</div>
<div class="topic">
<p class="topic-title">select() from a Table vs. ORM class</p>
<p>While the SQL generated in these examples looks the same whether we invoke
<code class="docutils literal notranslate"><span class="pre">select(user_table)</span></code> or <code class="docutils literal notranslate"><span class="pre">select(User)</span></code>, in the more general case
they do not necessarily render the same thing, as an ORM-mapped class
may be mapped to other kinds of “selectables” besides tables.  The
<code class="docutils literal notranslate"><span class="pre">select()</span></code> that’s against an ORM entity also indicates that ORM-mapped
instances should be returned in a result, which is not the case when
SELECTing from a <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> object.</p>
</div>
<p>The following sections will discuss the SELECT construct in more detail.</p>
</section>
<section id="setting-the-columns-and-from-clause">
<h2>Setting the COLUMNS and FROM clause<a class="headerlink" href="#setting-the-columns-and-from-clause" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> function accepts positional elements representing any
number of <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> and/or <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> expressions, as
well as a wide range of compatible objects, which are resolved into a list of SQL
expressions to be SELECTed from that will be returned as columns in the result
set.  These elements also serve in simpler cases to create the FROM clause,
which is inferred from the columns and table-like expressions passed:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">user_table</span><span class="p">))</span>
<div class='show_sql'><span class="k">SELECT</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">fullname</span>
<span class="k">FROM</span> <span class="n">user_account</span>
</div></pre></div>
</div>
<p>To SELECT from individual columns using a Core approach,
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> objects are accessed from the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table.c" title="sqlalchemy.schema.Table.c"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Table.c</span></code></a>
accessor and can be sent directly; the FROM clause will be inferred as the set
of all <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> and other <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.FromClause" title="sqlalchemy.sql.expression.FromClause"><code class="xref py py-class docutils literal notranslate"><span class="pre">FromClause</span></code></a> objects that
are represented by those columns:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">fullname</span><span class="p">))</span>
<div class='show_sql'><span class="k">SELECT</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">fullname</span>
<span class="k">FROM</span> <span class="n">user_account</span>
</div></pre></div>
</div>
<section id="selecting-orm-entities-and-columns">
<span id="tutorial-selecting-orm-entities"></span><h3>Selecting ORM Entities and Columns<a class="headerlink" href="#selecting-orm-entities-and-columns" title="Permalink to this headline">¶</a></h3>
<p>ORM entities, such our <code class="docutils literal notranslate"><span class="pre">User</span></code> class as well as the column-mapped
attributes upon it such as <code class="docutils literal notranslate"><span class="pre">User.name</span></code>, also participate in the SQL Expression
Language system representing tables and columns.    Below illustrates an
example of SELECTing from the <code class="docutils literal notranslate"><span class="pre">User</span></code> entity, which ultimately renders
in the same way as if we had used <code class="docutils literal notranslate"><span class="pre">user_table</span></code> directly:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">))</span>
<div class='show_sql'><span class="k">SELECT</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">fullname</span>
<span class="k">FROM</span> <span class="n">user_account</span>
</div></pre></div>
</div>
<p>When executing a statement like the above using the ORM <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a>
method, there is an important difference when we select from a full entity
such as <code class="docutils literal notranslate"><span class="pre">User</span></code>, as opposed to <code class="docutils literal notranslate"><span class="pre">user_table</span></code>, which is that the <strong>entity
itself is returned as a single element within each row</strong>.  That is, when we fetch rows from
the above statement, as there is only the <code class="docutils literal notranslate"><span class="pre">User</span></code> entity in the list of
things to fetch, we get back <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Row" title="sqlalchemy.engine.Row"><code class="xref py py-class docutils literal notranslate"><span class="pre">Row</span></code></a> objects that have only one element, which contain
instances of the <code class="docutils literal notranslate"><span class="pre">User</span></code> class:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">row</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<div class='show_sql'><span class="k">BEGIN</span><span class="p">...</span>
<span class="k">SELECT</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">fullname</span>
<span class="k">FROM</span> <span class="n">user_account</span>
<span class="p">[...]</span> <span class="p">()</span>
</div><span class="gp">&gt;&gt;&gt; </span><span class="n">row</span>
<span class="go">(User(id=1, name=&#39;spongebob&#39;, fullname=&#39;Spongebob Squarepants&#39;),)</span></pre></div>
</div>
<p>The above <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Row" title="sqlalchemy.engine.Row"><code class="xref py py-class docutils literal notranslate"><span class="pre">Row</span></code></a> has just one element, representing the <code class="docutils literal notranslate"><span class="pre">User</span></code> entity:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="go">User(id=1, name=&#39;spongebob&#39;, fullname=&#39;Spongebob Squarepants&#39;)</span></pre></div>
</div>
<p>Alternatively, we can select individual columns of an ORM entity as distinct
elements within result rows, by using the class-bound attributes; when these
are passed to a construct such as <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a>, they are resolved into
the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> or other SQL expression represented by each
attribute:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">fullname</span><span class="p">))</span>
<div class='show_sql'><span class="k">SELECT</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">fullname</span>
<span class="k">FROM</span> <span class="n">user_account</span>
</div></pre></div>
</div>
<p>When we invoke <em>this</em> statement using <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a>, we now
receive rows that have individual elements per value, each corresponding
to a separate column or other SQL expression:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">row</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">fullname</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<div class='show_sql'><span class="k">SELECT</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">fullname</span>
<span class="k">FROM</span> <span class="n">user_account</span>
<span class="p">[...]</span> <span class="p">()</span>
</div><span class="gp">&gt;&gt;&gt; </span><span class="n">row</span>
<span class="go">(&#39;spongebob&#39;, &#39;Spongebob Squarepants&#39;)</span></pre></div>
</div>
<p>The approaches can also be mixed, as below where we SELECT the <code class="docutils literal notranslate"><span class="pre">name</span></code>
attribute of the <code class="docutils literal notranslate"><span class="pre">User</span></code> entity as the first element of the row, and combine
it with full <code class="docutils literal notranslate"><span class="pre">Address</span></code> entities in the second element:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">Address</span><span class="p">)</span><span class="o">.</span>
<span class="gp">... </span>    <span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="n">Address</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span>
<span class="gp">... </span>    <span class="n">order_by</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="gp">... </span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<div class='show_sql'><span class="k">SELECT</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">address</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">address</span><span class="p">.</span><span class="n">email_address</span><span class="p">,</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span>
<span class="k">FROM</span> <span class="n">user_account</span><span class="p">,</span> <span class="n">address</span>
<span class="k">WHERE</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">address</span><span class="p">.</span><span class="n">id</span>
<span class="p">[...]</span> <span class="p">()</span>
</div><span class="go">[(&#39;spongebob&#39;, Address(id=1, email_address=&#39;spongebob@sqlalchemy.org&#39;)),</span>
<span class="go">(&#39;sandy&#39;, Address(id=2, email_address=&#39;sandy@sqlalchemy.org&#39;)),</span>
<span class="go">(&#39;sandy&#39;, Address(id=3, email_address=&#39;sandy@squirrelpower.org&#39;))]</span></pre></div>
</div>
<p>Approaches towards selecting ORM entities and columns as well as common methods
for converting rows are discussed further at <a class="reference internal" href="../orm/queryguide.html#orm-queryguide-select-columns"><span class="std std-ref">Selecting ORM Entities and Attributes</span></a>.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../orm/queryguide.html#orm-queryguide-select-columns"><span class="std std-ref">Selecting ORM Entities and Attributes</span></a> - in the <a class="reference internal" href="../orm/queryguide.html"><span class="std std-ref">ORM Querying Guide</span></a></p>
</div>
</section>
<section id="selecting-from-labeled-sql-expressions">
<h3>Selecting from Labeled SQL Expressions<a class="headerlink" href="#selecting-from-labeled-sql-expressions" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.ColumnElement.label" title="sqlalchemy.sql.expression.ColumnElement.label"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ColumnElement.label()</span></code></a> method as well as the same-named method
available on ORM attributes provides a SQL label of a column or expression,
allowing it to have a specific name in a result set.  This can be helpful
when referring to arbitrary SQL expressions in a result row by name:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">func</span><span class="p">,</span> <span class="n">cast</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
<span class="gp">... </span>    <span class="n">select</span><span class="p">(</span>
<span class="gp">... </span>        <span class="p">(</span><span class="s2">&quot;Username: &quot;</span> <span class="o">+</span> <span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">),</span>
<span class="gp">... </span>    <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">):</span>
<span class="gp">... </span>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<div class='show_sql'><span class="k">BEGIN</span> <span class="p">(</span><span class="k">implicit</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="o">?</span> <span class="o">||</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span> <span class="k">AS</span> <span class="n">username</span>
<span class="k">FROM</span> <span class="n">user_account</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span>
<span class="p">[...]</span> <span class="p">(</span><span class="s1">&#39;Username: &#39;</span><span class="p">,)</span>
</div><span class="go">Username: patrick</span>
<span class="go">Username: sandy</span>
<span class="go">Username: spongebob</span>
<div class='show_sql'><span class="k">ROLLBACK</span>
</div></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="#tutorial-order-by-label"><span class="std std-ref">Ordering or Grouping by a Label</span></a> - the label names we create may also be
referred towards in the ORDER BY or GROUP BY clause of the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a>.</p>
</div>
</section>
<section id="selecting-with-textual-column-expressions">
<span id="tutorial-select-arbtrary-text"></span><h3>Selecting with Textual Column Expressions<a class="headerlink" href="#selecting-with-textual-column-expressions" title="Permalink to this headline">¶</a></h3>
<p>When we construct a <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a> object using the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a>
function, we are normally passing to it a series of <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>
and <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> objects that were defined using
<a class="reference internal" href="metadata.html#tutorial-working-with-metadata"><span class="std std-ref">table metadata</span></a>, or when using the ORM we may be
sending ORM-mapped attributes that represent table columns.   However,
sometimes there is also the need to manufacture arbitrary SQL blocks inside
of statements, such as constant string expressions, or just some arbitrary
SQL that’s quicker to write literally.</p>
<p>The <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.text" title="sqlalchemy.sql.expression.text"><code class="xref py py-func docutils literal notranslate"><span class="pre">text()</span></code></a> construct introduced at
<a class="reference internal" href="dbapi_transactions.html#tutorial-working-with-transactions"><span class="std std-ref">Working with Transactions and the DBAPI</span></a> can in fact be embedded into a
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a> construct directly, such as below where we manufacture
a hardcoded string literal <code class="docutils literal notranslate"><span class="pre">'some</span> <span class="pre">label'</span></code> and embed it within the
SELECT statement:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">text</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
<span class="gp">... </span>    <span class="n">select</span><span class="p">(</span>
<span class="gp">... </span>        <span class="n">text</span><span class="p">(</span><span class="s2">&quot;&#39;some phrase&#39;&quot;</span><span class="p">),</span> <span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span>
<span class="gp">... </span>    <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
<div class='show_sql'><span class="k">BEGIN</span> <span class="p">(</span><span class="k">implicit</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="s1">&#39;some phrase&#39;</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span>
<span class="k">FROM</span> <span class="n">user_account</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span>
<span class="p">[</span><span class="k">generated</span> <span class="k">in</span> <span class="p">...]</span> <span class="p">()</span>
</div><span class="go">[(&#39;some phrase&#39;, &#39;patrick&#39;), (&#39;some phrase&#39;, &#39;sandy&#39;), (&#39;some phrase&#39;, &#39;spongebob&#39;)]</span>
<div class='show_sql'><span class="k">ROLLBACK</span>
</div></pre></div>
</div>
<p>While the <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.text" title="sqlalchemy.sql.expression.text"><code class="xref py py-func docutils literal notranslate"><span class="pre">text()</span></code></a> construct can be used in most places to inject
literal SQL phrases, more often than not we are actually dealing with textual
units that each represent an individual
column expression.  In this common case we can get more functionality out of
our textual fragment using the <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.literal_column" title="sqlalchemy.sql.expression.literal_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">literal_column()</span></code></a>
construct instead.  This object is similar to <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.text" title="sqlalchemy.sql.expression.text"><code class="xref py py-func docutils literal notranslate"><span class="pre">text()</span></code></a> except that
instead of representing arbitrary SQL of any form,
it explicitly represents a single “column” and can then be labeled and referred
towards in subqueries and other expressions:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">literal_column</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
<span class="gp">... </span>    <span class="n">select</span><span class="p">(</span>
<span class="gp">... </span>        <span class="n">literal_column</span><span class="p">(</span><span class="s2">&quot;&#39;some phrase&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">),</span> <span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span>
<span class="gp">... </span>    <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">):</span>
<span class="gp">... </span>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row</span><span class="o">.</span><span class="n">p</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<div class='show_sql'><span class="k">BEGIN</span> <span class="p">(</span><span class="k">implicit</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="s1">&#39;some phrase&#39;</span> <span class="k">AS</span> <span class="n">p</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span>
<span class="k">FROM</span> <span class="n">user_account</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span>
<span class="p">[</span><span class="k">generated</span> <span class="k">in</span> <span class="p">...]</span> <span class="p">()</span>
</div><span class="go">some phrase, patrick</span>
<span class="go">some phrase, sandy</span>
<span class="go">some phrase, spongebob</span>
<div class='show_sql'><span class="k">ROLLBACK</span>
</div></pre></div>
</div>
<p>Note that in both cases, when using <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.text" title="sqlalchemy.sql.expression.text"><code class="xref py py-func docutils literal notranslate"><span class="pre">text()</span></code></a> or
<a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.literal_column" title="sqlalchemy.sql.expression.literal_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">literal_column()</span></code></a>, we are writing a syntactical SQL expression, and
not a literal value. We therefore have to include whatever quoting or syntaxes
are necessary for the SQL we want to see rendered.</p>
</section>
</section>
<section id="the-where-clause">
<span id="tutorial-select-where-clause"></span><h2>The WHERE clause<a class="headerlink" href="#the-where-clause" title="Permalink to this headline">¶</a></h2>
<p>SQLAlchemy allows us to compose SQL expressions, such as <code class="docutils literal notranslate"><span class="pre">name</span> <span class="pre">=</span> <span class="pre">'squidward'</span></code>
or <code class="docutils literal notranslate"><span class="pre">user_id</span> <span class="pre">&gt;</span> <span class="pre">10</span></code>, by making use of standard Python operators in
conjunction with
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> and similar objects.   For boolean expressions, most
Python operators such as <code class="docutils literal notranslate"><span class="pre">==</span></code>, <code class="docutils literal notranslate"><span class="pre">!=</span></code>, <code class="docutils literal notranslate"><span class="pre">&lt;</span></code>, <code class="docutils literal notranslate"><span class="pre">&gt;=</span></code> etc. generate new
SQL Expression objects, rather than plain boolean <code class="docutils literal notranslate"><span class="pre">True</span></code>/<code class="docutils literal notranslate"><span class="pre">False</span></code> values:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;squidward&#39;</span><span class="p">)</span>
<span class="go">user_account.name = :name_1</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_id</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>
<span class="go">address.user_id &gt; :user_id_1</span></pre></div>
</div>
<p>We can use expressions like these to generate the WHERE clause by passing
the resulting objects to the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.where" title="sqlalchemy.sql.expression.Select.where"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.where()</span></code></a> method:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">user_table</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;squidward&#39;</span><span class="p">))</span>
<div class='show_sql'><span class="k">SELECT</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">fullname</span>
<span class="k">FROM</span> <span class="n">user_account</span>
<span class="k">WHERE</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">:</span><span class="n">name_1</span>
</div></pre></div>
</div>
<p>To produce multiple expressions joined by AND, the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.where" title="sqlalchemy.sql.expression.Select.where"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.where()</span></code></a>
method may be invoked any number of times:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">select</span><span class="p">(</span><span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">email_address</span><span class="p">)</span><span class="o">.</span>
<span class="gp">... </span>    <span class="n">where</span><span class="p">(</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;squidward&#39;</span><span class="p">)</span><span class="o">.</span>
<span class="gp">... </span>    <span class="n">where</span><span class="p">(</span><span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="gp">... </span><span class="p">)</span>
<div class='show_sql'><span class="k">SELECT</span> <span class="n">address</span><span class="p">.</span><span class="n">email_address</span>
<span class="k">FROM</span> <span class="n">address</span><span class="p">,</span> <span class="n">user_account</span>
<span class="k">WHERE</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">:</span><span class="n">name_1</span> <span class="k">AND</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span>
</div></pre></div>
</div>
<p>A single call to <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.where" title="sqlalchemy.sql.expression.Select.where"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.where()</span></code></a> also accepts multiple expressions
with the same effect:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">select</span><span class="p">(</span><span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">email_address</span><span class="p">)</span><span class="o">.</span>
<span class="gp">... </span>    <span class="n">where</span><span class="p">(</span>
<span class="gp">... </span>         <span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;squidward&#39;</span><span class="p">,</span>
<span class="gp">... </span>         <span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span>
<span class="gp">... </span>    <span class="p">)</span>
<span class="gp">... </span><span class="p">)</span>
<div class='show_sql'><span class="k">SELECT</span> <span class="n">address</span><span class="p">.</span><span class="n">email_address</span>
<span class="k">FROM</span> <span class="n">address</span><span class="p">,</span> <span class="n">user_account</span>
<span class="k">WHERE</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">:</span><span class="n">name_1</span> <span class="k">AND</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span>
</div></pre></div>
</div>
<p>“AND” and “OR” conjunctions are both available directly using the
<a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.and_" title="sqlalchemy.sql.expression.and_"><code class="xref py py-func docutils literal notranslate"><span class="pre">and_()</span></code></a> and <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.or_" title="sqlalchemy.sql.expression.or_"><code class="xref py py-func docutils literal notranslate"><span class="pre">or_()</span></code></a> functions, illustrated below in terms
of ORM entities:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">and_</span><span class="p">,</span> <span class="n">or_</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">select</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">email_address</span><span class="p">)</span><span class="o">.</span>
<span class="gp">... </span>    <span class="n">where</span><span class="p">(</span>
<span class="gp">... </span>        <span class="n">and_</span><span class="p">(</span>
<span class="gp">... </span>            <span class="n">or_</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;squidward&#39;</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;sandy&#39;</span><span class="p">),</span>
<span class="gp">... </span>            <span class="n">Address</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">User</span><span class="o">.</span><span class="n">id</span>
<span class="gp">... </span>        <span class="p">)</span>
<span class="gp">... </span>    <span class="p">)</span>
<span class="gp">... </span><span class="p">)</span>
<div class='show_sql'><span class="k">SELECT</span> <span class="n">address</span><span class="p">.</span><span class="n">email_address</span>
<span class="k">FROM</span> <span class="n">address</span><span class="p">,</span> <span class="n">user_account</span>
<span class="k">WHERE</span> <span class="p">(</span><span class="n">user_account</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">:</span><span class="n">name_1</span> <span class="k">OR</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">:</span><span class="n">name_2</span><span class="p">)</span>
<span class="k">AND</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span>
</div></pre></div>
</div>
<p>For simple “equality” comparisons against a single entity, there’s also a
popular method known as <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.filter_by" title="sqlalchemy.sql.expression.Select.filter_by"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.filter_by()</span></code></a> which accepts keyword
arguments that match to column keys or ORM attribute names.  It will filter
against the leftmost FROM clause or the last entity joined:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;spongebob&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Spongebob Squarepants&#39;</span><span class="p">)</span>
<span class="gp">... </span><span class="p">)</span>
<div class='show_sql'><span class="k">SELECT</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">fullname</span>
<span class="k">FROM</span> <span class="n">user_account</span>
<span class="k">WHERE</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">:</span><span class="n">name_1</span> <span class="k">AND</span> <span class="n">user_account</span><span class="p">.</span><span class="n">fullname</span> <span class="o">=</span> <span class="p">:</span><span class="n">fullname_1</span>
</div></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../core/operators.html"><span class="doc">Operator Reference</span></a> - descriptions of most SQL operator functions in SQLAlchemy</p>
</div>
</section>
<section id="explicit-from-clauses-and-joins">
<span id="tutorial-select-join"></span><h2>Explicit FROM clauses and JOINs<a class="headerlink" href="#explicit-from-clauses-and-joins" title="Permalink to this headline">¶</a></h2>
<p>As mentioned previously, the FROM clause is usually <strong>inferred</strong>
based on the expressions that we are setting in the columns
clause as well as other elements of the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a>.</p>
<p>If we set a single column from a particular <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>
in the COLUMNS clause, it puts that <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> in the FROM
clause as well:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
<div class='show_sql'><span class="k">SELECT</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span>
<span class="k">FROM</span> <span class="n">user_account</span>
</div></pre></div>
</div>
<p>If we were to put columns from two tables, then we get a comma-separated FROM
clause:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">email_address</span><span class="p">))</span>
<div class='show_sql'><span class="k">SELECT</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">address</span><span class="p">.</span><span class="n">email_address</span>
<span class="k">FROM</span> <span class="n">user_account</span><span class="p">,</span> <span class="n">address</span>
</div></pre></div>
</div>
<p>In order to JOIN these two tables together, we typically use one of two methods
on <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a>.  The first is the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.join_from" title="sqlalchemy.sql.expression.Select.join_from"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.join_from()</span></code></a>
method, which allows us to indicate the left and right side of the JOIN
explicitly:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">select</span><span class="p">(</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">email_address</span><span class="p">)</span><span class="o">.</span>
<span class="gp">... </span>    <span class="n">join_from</span><span class="p">(</span><span class="n">user_table</span><span class="p">,</span> <span class="n">address_table</span><span class="p">)</span>
<span class="gp">... </span><span class="p">)</span>
<div class='show_sql'><span class="k">SELECT</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">address</span><span class="p">.</span><span class="n">email_address</span>
<span class="k">FROM</span> <span class="n">user_account</span> <span class="k">JOIN</span> <span class="n">address</span> <span class="k">ON</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span>
</div></pre></div>
</div>
<p>The other is the the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.join" title="sqlalchemy.sql.expression.Select.join"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.join()</span></code></a> method, which indicates only the
right side of the JOIN, the left hand-side is inferred:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">select</span><span class="p">(</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">email_address</span><span class="p">)</span><span class="o">.</span>
<span class="gp">... </span>    <span class="n">join</span><span class="p">(</span><span class="n">address_table</span><span class="p">)</span>
<span class="gp">... </span><span class="p">)</span>
<div class='show_sql'><span class="k">SELECT</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">address</span><span class="p">.</span><span class="n">email_address</span>
<span class="k">FROM</span> <span class="n">user_account</span> <span class="k">JOIN</span> <span class="n">address</span> <span class="k">ON</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span>
</div></pre></div>
</div>
<aside class="sidebar">
<p class="sidebar-title">The ON Clause is inferred</p>
<p>When using <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.join_from" title="sqlalchemy.sql.expression.Select.join_from"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.join_from()</span></code></a> or <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.join" title="sqlalchemy.sql.expression.Select.join"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.join()</span></code></a>, we may
observe that the ON clause of the join is also inferred for us in simple
foreign key cases. More on that in the next section.</p>
</aside>
<p>We also have the option to add elements to the FROM clause explicitly, if it is not
inferred the way we want from the columns clause.  We use the
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.select_from" title="sqlalchemy.sql.expression.Select.select_from"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.select_from()</span></code></a> method to achieve this, as below
where we establish <code class="docutils literal notranslate"><span class="pre">user_table</span></code> as the first element in the FROM
clause and <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.join" title="sqlalchemy.sql.expression.Select.join"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.join()</span></code></a> to establish <code class="docutils literal notranslate"><span class="pre">address_table</span></code> as
the second:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">select</span><span class="p">(</span><span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">email_address</span><span class="p">)</span><span class="o">.</span>
<span class="gp">... </span>    <span class="n">select_from</span><span class="p">(</span><span class="n">user_table</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">address_table</span><span class="p">)</span>
<span class="gp">... </span><span class="p">)</span>
<div class='show_sql'><span class="k">SELECT</span> <span class="n">address</span><span class="p">.</span><span class="n">email_address</span>
<span class="k">FROM</span> <span class="n">user_account</span> <span class="k">JOIN</span> <span class="n">address</span> <span class="k">ON</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span>
</div></pre></div>
</div>
<p>Another example where we might want to use <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.select_from" title="sqlalchemy.sql.expression.Select.select_from"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.select_from()</span></code></a>
is if our columns clause doesn’t have enough information to provide for a
FROM clause.  For example, to SELECT from the common SQL expression
<code class="docutils literal notranslate"><span class="pre">count(*)</span></code>, we use a SQLAlchemy element known as <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.func" title="sqlalchemy.sql.expression.func"><code class="xref py py-attr docutils literal notranslate"><span class="pre">sqlalchemy.sql.expression.func</span></code></a> to
produce the SQL <code class="docutils literal notranslate"><span class="pre">count()</span></code> function:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">func</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span> <span class="p">(</span>
<span class="gp">... </span>    <span class="n">select</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">user_table</span><span class="p">)</span>
<span class="gp">... </span><span class="p">)</span>
<div class='show_sql'><span class="k">SELECT</span> <span class="k">count</span><span class="p">(:</span><span class="n">count_2</span><span class="p">)</span> <span class="k">AS</span> <span class="n">count_1</span>
<span class="k">FROM</span> <span class="n">user_account</span>
</div></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../orm/queryguide.html#orm-queryguide-select-from"><span class="std std-ref">Controlling what to Join From</span></a> - in the <a class="reference internal" href="../orm/queryguide.html"><span class="std std-ref">ORM Querying Guide</span></a> -
contains additional examples and notes
regarding the interaction of <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.select_from" title="sqlalchemy.sql.expression.Select.select_from"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.select_from()</span></code></a> and
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.join" title="sqlalchemy.sql.expression.Select.join"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.join()</span></code></a>.</p>
</div>
<section id="setting-the-on-clause">
<span id="tutorial-select-join-onclause"></span><h3>Setting the ON Clause<a class="headerlink" href="#setting-the-on-clause" title="Permalink to this headline">¶</a></h3>
<p>The previous examples of JOIN illustrated that the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a> construct
can join between two tables and produce the ON clause automatically.  This
occurs in those examples because the <code class="docutils literal notranslate"><span class="pre">user_table</span></code> and <code class="docutils literal notranslate"><span class="pre">address_table</span></code>
<code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code> objects include a single <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.ForeignKeyConstraint" title="sqlalchemy.schema.ForeignKeyConstraint"><code class="xref py py-class docutils literal notranslate"><span class="pre">ForeignKeyConstraint</span></code></a>
definition which is used to form this ON clause.</p>
<p>If the left and right targets of the join do not have such a constraint, or
there are multiple constraints in place, we need to specify the ON clause
directly.   Both <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.join" title="sqlalchemy.sql.expression.Select.join"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.join()</span></code></a> and <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.join_from" title="sqlalchemy.sql.expression.Select.join_from"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.join_from()</span></code></a>
accept an additional argument for the ON clause, which is stated using the
same SQL Expression mechanics as we saw about in <a class="reference internal" href="#tutorial-select-where-clause"><span class="std std-ref">The WHERE clause</span></a>:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">select</span><span class="p">(</span><span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">email_address</span><span class="p">)</span><span class="o">.</span>
<span class="gp">... </span>    <span class="n">select_from</span><span class="p">(</span><span class="n">user_table</span><span class="p">)</span><span class="o">.</span>
<span class="gp">... </span>    <span class="n">join</span><span class="p">(</span><span class="n">address_table</span><span class="p">,</span> <span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
<span class="gp">... </span><span class="p">)</span>
<div class='show_sql'><span class="k">SELECT</span> <span class="n">address</span><span class="p">.</span><span class="n">email_address</span>
<span class="k">FROM</span> <span class="n">user_account</span> <span class="k">JOIN</span> <span class="n">address</span> <span class="k">ON</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span>
</div></pre></div>
</div>
<div class="orm-header docutils container">
<p><strong>ORM Tip</strong> - there’s another way to generate the ON clause when using
ORM entities that make use of the <a class="reference internal" href="../orm/relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> construct,
like the mapping set up in the previous section at
<a class="reference internal" href="metadata.html#tutorial-declaring-mapped-classes"><span class="std std-ref">Declaring Mapped Classes</span></a>.
This is a whole subject onto itself, which is introduced at length
at <a class="reference internal" href="orm_related_objects.html#tutorial-joining-relationships"><span class="std std-ref">Using Relationships to Join</span></a>.</p>
</div>
</section>
<section id="outer-and-full-join">
<h3>OUTER and FULL join<a class="headerlink" href="#outer-and-full-join" title="Permalink to this headline">¶</a></h3>
<p>Both the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.join" title="sqlalchemy.sql.expression.Select.join"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.join()</span></code></a> and <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.join_from" title="sqlalchemy.sql.expression.Select.join_from"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.join_from()</span></code></a> methods
accept keyword arguments <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.join.params.isouter" title="sqlalchemy.sql.expression.Select.join"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Select.join.isouter</span></code></a> and
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.join.params.full" title="sqlalchemy.sql.expression.Select.join"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Select.join.full</span></code></a> which will render LEFT OUTER JOIN
and FULL OUTER JOIN, respectively:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">select</span><span class="p">(</span><span class="n">user_table</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">address_table</span><span class="p">,</span> <span class="n">isouter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">... </span><span class="p">)</span>
<div class='show_sql'><span class="k">SELECT</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">fullname</span>
<span class="k">FROM</span> <span class="n">user_account</span> <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="n">address</span> <span class="k">ON</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span>
</div><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">select</span><span class="p">(</span><span class="n">user_table</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">address_table</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">... </span><span class="p">)</span>
<div class='show_sql'><span class="k">SELECT</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">fullname</span>
<span class="k">FROM</span> <span class="n">user_account</span> <span class="k">FULL</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="n">address</span> <span class="k">ON</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span>
</div></pre></div>
</div>
<p>There is also a method <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.outerjoin" title="sqlalchemy.sql.expression.Select.outerjoin"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.outerjoin()</span></code></a> that is equivalent to
using <code class="docutils literal notranslate"><span class="pre">.join(...,</span> <span class="pre">isouter=True)</span></code>.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>SQL also has a “RIGHT OUTER JOIN”.  SQLAlchemy doesn’t render this directly;
instead, reverse the order of the tables and use “LEFT OUTER JOIN”.</p>
</div>
</section>
</section>
<section id="order-by-group-by-having">
<span id="tutorial-order-by-group-by-having"></span><h2>ORDER BY, GROUP BY, HAVING<a class="headerlink" href="#order-by-group-by-having" title="Permalink to this headline">¶</a></h2>
<p>The SELECT SQL statement includes a clause called ORDER BY which is used to
return the selected rows within a given ordering.</p>
<p>The GROUP BY clause is constructed similarly to the ORDER BY clause, and has
the purpose of sub-dividing the selected rows into specific groups upon which
aggregate functions may be invoked. The HAVING clause is usually used with
GROUP BY and is of a similar form to the WHERE clause, except that it’s applied
to the aggregated functions used within groups.</p>
<section id="order-by">
<span id="tutorial-order-by"></span><h3>ORDER BY<a class="headerlink" href="#order-by" title="Permalink to this headline">¶</a></h3>
<p>The ORDER BY clause is constructed in terms
of SQL Expression constructs typically based on <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> or
similar objects.  The <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.order_by" title="sqlalchemy.sql.expression.Select.order_by"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.order_by()</span></code></a> method accepts one or
more of these expressions positionally:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">user_table</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
<div class='show_sql'><span class="k">SELECT</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">fullname</span>
<span class="k">FROM</span> <span class="n">user_account</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span>
</div></pre></div>
</div>
<p>Ascending / descending is available from the <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.ColumnElement.asc" title="sqlalchemy.sql.expression.ColumnElement.asc"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ColumnElement.asc()</span></code></a>
and <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.ColumnElement.desc" title="sqlalchemy.sql.expression.ColumnElement.desc"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ColumnElement.desc()</span></code></a> modifiers, which are present
from ORM-bound attributes as well:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">fullname</span><span class="o">.</span><span class="n">desc</span><span class="p">()))</span>
<div class='show_sql'><span class="k">SELECT</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">fullname</span>
<span class="k">FROM</span> <span class="n">user_account</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">user_account</span><span class="p">.</span><span class="n">fullname</span> <span class="k">DESC</span>
</div></pre></div>
</div>
<p>The above statement will yield rows that are sorted by the
<code class="docutils literal notranslate"><span class="pre">user_account.fullname</span></code> column in descending order.</p>
</section>
<section id="aggregate-functions-with-group-by-having">
<span id="tutorial-group-by-w-aggregates"></span><h3>Aggregate functions with GROUP BY / HAVING<a class="headerlink" href="#aggregate-functions-with-group-by-having" title="Permalink to this headline">¶</a></h3>
<p>In SQL, aggregate functions allow column expressions across multiple rows
to be aggregated together to produce a single result.  Examples include
counting, computing averages, as well as locating the maximum or minimum
value in a set of values.</p>
<p>SQLAlchemy provides for SQL functions in an open-ended way using a namespace
known as <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.func" title="sqlalchemy.sql.expression.func"><code class="xref py py-data docutils literal notranslate"><span class="pre">func</span></code></a>.  This is a special constructor object which
will create new instances of <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.Function" title="sqlalchemy.sql.functions.Function"><code class="xref py py-class docutils literal notranslate"><span class="pre">Function</span></code></a> when given the name
of a particular SQL function, which can have any name, as well as zero or
more arguments to pass to the function, which are, like in all other cases,
SQL Expression constructs.   For example, to
render the SQL COUNT() function against the <code class="docutils literal notranslate"><span class="pre">user_account.id</span></code> column,
we call upon the <code class="docutils literal notranslate"><span class="pre">count()</span></code> name:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">func</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">count_fn</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">count_fn</span><span class="p">)</span>
<div class='show_sql'><span class="k">count</span><span class="p">(</span><span class="n">user_account</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
</div></pre></div>
</div>
<p>SQL functions are described in more detail later in this tutorial at
<a class="reference internal" href="#tutorial-functions"><span class="std std-ref">Working with SQL Functions</span></a>.</p>
<p>When using aggregate functions in SQL, the GROUP BY clause is essential in that
it allows rows to be partitioned into groups where aggregate functions will
be applied to each group individually.  When requesting non-aggregated columns
in the COLUMNS clause of a SELECT statement, SQL requires that these columns
all be subject to a GROUP BY clause, either directly or indirectly based on
a primary key association.    The HAVING clause is then used in a similar
manner as the WHERE clause, except that it filters out rows based on aggregated
values rather than direct row contents.</p>
<p>SQLAlchemy provides for these two clauses using the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.group_by" title="sqlalchemy.sql.expression.Select.group_by"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.group_by()</span></code></a>
and <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.having" title="sqlalchemy.sql.expression.Select.having"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.having()</span></code></a> methods.   Below we illustrate selecting
user name fields as well as count of addresses, for those users that have more
than one address:</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<span class="o">...</span>     <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="o">...</span>         <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">))</span><span class="o">.</span>
<span class="o">...</span>         <span class="n">join</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span>
<span class="o">...</span>         <span class="n">group_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span>
<span class="o">...</span>         <span class="n">having</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
<span class="o">...</span>     <span class="p">)</span>
<span class="o">...</span>     <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
<div class='show_sql'><span class="k">BEGIN</span> <span class="p">(</span><span class="k">implicit</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="n">address</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="k">AS</span> <span class="k">count</span>
<span class="k">FROM</span> <span class="n">user_account</span> <span class="k">JOIN</span> <span class="n">address</span> <span class="k">ON</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span>
<span class="k">HAVING</span> <span class="k">count</span><span class="p">(</span><span class="n">address</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">?</span>
<span class="p">[...]</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
</div><span class="p">[(</span><span class="s1">&#39;sandy&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span>
<div class='show_sql'><span class="k">ROLLBACK</span>
</div></pre></div>
</div>
</section>
<section id="ordering-or-grouping-by-a-label">
<span id="tutorial-order-by-label"></span><h3>Ordering or Grouping by a Label<a class="headerlink" href="#ordering-or-grouping-by-a-label" title="Permalink to this headline">¶</a></h3>
<p>An important technique, in particular on some database backends, is the ability
to ORDER BY or GROUP BY an expression that is already stated in the columns
clause, without re-stating the expression in the ORDER BY or GROUP BY clause
and instead using the column name or labeled name from the COLUMNS clause.
This form is available by passing the string text of the name to the
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.order_by" title="sqlalchemy.sql.expression.Select.order_by"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.order_by()</span></code></a> or <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.group_by" title="sqlalchemy.sql.expression.Select.group_by"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.group_by()</span></code></a> method.  The text
passed is <strong>not rendered directly</strong>; instead, the name given to an expression
in the columns clause and rendered as that expression name in context, raising an
error if no match is found.   The unary modifiers
<a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.asc" title="sqlalchemy.sql.expression.asc"><code class="xref py py-func docutils literal notranslate"><span class="pre">asc()</span></code></a> and <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.desc" title="sqlalchemy.sql.expression.desc"><code class="xref py py-func docutils literal notranslate"><span class="pre">desc()</span></code></a> may also be used in this form:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">func</span><span class="p">,</span> <span class="n">desc</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span>
<span class="gp">... </span>        <span class="n">Address</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
<span class="gp">... </span>        <span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;num_addresses&#39;</span><span class="p">))</span><span class="o">.</span>\
<span class="gp">... </span>        <span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="n">desc</span><span class="p">(</span><span class="s2">&quot;num_addresses&quot;</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<div class='show_sql'><span class="k">SELECT</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="n">address</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">num_addresses</span>
<span class="k">FROM</span> <span class="n">address</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">num_addresses</span> <span class="k">DESC</span>
</div></pre></div>
</div>
</section>
</section>
<section id="using-aliases">
<span id="tutorial-using-aliases"></span><h2>Using Aliases<a class="headerlink" href="#using-aliases" title="Permalink to this headline">¶</a></h2>
<p>Now that we are selecting from multiple tables and using joins, we quickly
run into the case where we need to refer to the same table mutiple times
in the FROM clause of a statement.  We accomplish this using SQL <strong>aliases</strong>,
which are a syntax that supplies an alternative name to a table or subquery
from which it can be referred towards in the statement.</p>
<p>In the SQLAlchemy Expression Language, these “names” are instead represented by
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.FromClause" title="sqlalchemy.sql.expression.FromClause"><code class="xref py py-class docutils literal notranslate"><span class="pre">FromClause</span></code></a> objects known as the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Alias" title="sqlalchemy.sql.expression.Alias"><code class="xref py py-class docutils literal notranslate"><span class="pre">Alias</span></code></a> construct,
which is constructed in Core using the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.FromClause.alias" title="sqlalchemy.sql.expression.FromClause.alias"><code class="xref py py-meth docutils literal notranslate"><span class="pre">FromClause.alias()</span></code></a>
method. An <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Alias" title="sqlalchemy.sql.expression.Alias"><code class="xref py py-class docutils literal notranslate"><span class="pre">Alias</span></code></a> construct is just like a <code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code>
construct in that it also has a namespace of <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a>
objects within the <code class="xref py py-attr docutils literal notranslate"><span class="pre">Alias.c</span></code> collection.  The SELECT statement
below for example returns all unique pairs of user names:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">user_alias_1</span> <span class="o">=</span> <span class="n">user_table</span><span class="o">.</span><span class="n">alias</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user_alias_2</span> <span class="o">=</span> <span class="n">user_table</span><span class="o">.</span><span class="n">alias</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">select</span><span class="p">(</span><span class="n">user_alias_1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user_alias_2</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span>
<span class="gp">... </span>    <span class="n">join_from</span><span class="p">(</span><span class="n">user_alias_1</span><span class="p">,</span> <span class="n">user_alias_2</span><span class="p">,</span> <span class="n">user_alias_1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="n">user_alias_2</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="gp">... </span><span class="p">)</span>
<div class='show_sql'><span class="k">SELECT</span> <span class="n">user_account_1</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user_account_2</span><span class="p">.</span><span class="n">name</span> <span class="k">AS</span> <span class="n">name_1</span>
<span class="k">FROM</span> <span class="n">user_account</span> <span class="k">AS</span> <span class="n">user_account_1</span>
<span class="k">JOIN</span> <span class="n">user_account</span> <span class="k">AS</span> <span class="n">user_account_2</span> <span class="k">ON</span> <span class="n">user_account_1</span><span class="p">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="n">user_account_2</span><span class="p">.</span><span class="n">id</span>
</div></pre></div>
</div>
<section id="orm-entity-aliases">
<span id="tutorial-orm-entity-aliases"></span><h3>ORM Entity Aliases<a class="headerlink" href="#orm-entity-aliases" title="Permalink to this headline">¶</a></h3>
<p>The ORM equivalent of the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.FromClause.alias" title="sqlalchemy.sql.expression.FromClause.alias"><code class="xref py py-meth docutils literal notranslate"><span class="pre">FromClause.alias()</span></code></a> method is the
ORM <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.aliased" title="sqlalchemy.orm.aliased"><code class="xref py py-func docutils literal notranslate"><span class="pre">aliased()</span></code></a> function, which may be applied to an entity
such as <code class="docutils literal notranslate"><span class="pre">User</span></code> and <code class="docutils literal notranslate"><span class="pre">Address</span></code>.  This produces a <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Alias" title="sqlalchemy.sql.expression.Alias"><code class="xref py py-class docutils literal notranslate"><span class="pre">Alias</span></code></a> object
internally that’s against the original mapped <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> object,
while maintaining ORM functionality.  The SELECT below selects from the
<code class="docutils literal notranslate"><span class="pre">User</span></code> entity all objects that include two particular email addresses:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">aliased</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">address_alias_1</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">address_alias_2</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span>
<span class="gp">... </span>    <span class="n">join_from</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">address_alias_1</span><span class="p">)</span><span class="o">.</span>
<span class="gp">... </span>    <span class="n">where</span><span class="p">(</span><span class="n">address_alias_1</span><span class="o">.</span><span class="n">email_address</span> <span class="o">==</span> <span class="s1">&#39;patrick@aol.com&#39;</span><span class="p">)</span><span class="o">.</span>
<span class="gp">... </span>    <span class="n">join_from</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">address_alias_2</span><span class="p">)</span><span class="o">.</span>
<span class="gp">... </span>    <span class="n">where</span><span class="p">(</span><span class="n">address_alias_2</span><span class="o">.</span><span class="n">email_address</span> <span class="o">==</span> <span class="s1">&#39;patrick@gmail.com&#39;</span><span class="p">)</span>
<span class="gp">... </span><span class="p">)</span>
<div class='show_sql'><span class="k">SELECT</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">fullname</span>
<span class="k">FROM</span> <span class="n">user_account</span>
<span class="k">JOIN</span> <span class="n">address</span> <span class="k">AS</span> <span class="n">address_1</span> <span class="k">ON</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">address_1</span><span class="p">.</span><span class="n">user_id</span>
<span class="k">JOIN</span> <span class="n">address</span> <span class="k">AS</span> <span class="n">address_2</span> <span class="k">ON</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">address_2</span><span class="p">.</span><span class="n">user_id</span>
<span class="k">WHERE</span> <span class="n">address_1</span><span class="p">.</span><span class="n">email_address</span> <span class="o">=</span> <span class="p">:</span><span class="n">email_address_1</span>
<span class="k">AND</span> <span class="n">address_2</span><span class="p">.</span><span class="n">email_address</span> <span class="o">=</span> <span class="p">:</span><span class="n">email_address_2</span>
</div></pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>As mentioned in <a class="reference internal" href="#tutorial-select-join-onclause"><span class="std std-ref">Setting the ON Clause</span></a>, the ORM provides
for another way to join using the <a class="reference internal" href="../orm/relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> construct.
The above example using aliases is demonstrated using <a class="reference internal" href="../orm/relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a>
at <a class="reference internal" href="orm_related_objects.html#tutorial-joining-relationships-aliased"><span class="std std-ref">Joining between Aliased targets</span></a>.</p>
</div>
</section>
</section>
<section id="subqueries-and-ctes">
<span id="tutorial-subqueries-ctes"></span><h2>Subqueries and CTEs<a class="headerlink" href="#subqueries-and-ctes" title="Permalink to this headline">¶</a></h2>
<p>A subquery in SQL is a SELECT statement that is rendered within parenthesis and
placed within the context of an enclosing statement, typically a SELECT
statement but not necessarily.</p>
<p>This section will cover a so-called “non-scalar” subquery, which is typically
placed in the FROM clause of an enclosing SELECT.   We will also cover the
Common Table Expression or CTE, which is used in a similar way as a subquery,
but includes additional features.</p>
<p>SQLAlchemy uses the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Subquery" title="sqlalchemy.sql.expression.Subquery"><code class="xref py py-class docutils literal notranslate"><span class="pre">Subquery</span></code></a> object to represent a subquery and
the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.CTE" title="sqlalchemy.sql.expression.CTE"><code class="xref py py-class docutils literal notranslate"><span class="pre">CTE</span></code></a> to represent a CTE, usually obtained from the
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.subquery" title="sqlalchemy.sql.expression.Select.subquery"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.subquery()</span></code></a> and <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.cte" title="sqlalchemy.sql.expression.Select.cte"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.cte()</span></code></a> methods, respectively.
Either object can be used as a FROM element inside of a larger
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> construct.</p>
<p>We can construct a <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Subquery" title="sqlalchemy.sql.expression.Subquery"><code class="xref py py-class docutils literal notranslate"><span class="pre">Subquery</span></code></a> that will select an aggregate count
of rows from the <code class="docutils literal notranslate"><span class="pre">address</span></code> table (aggregate functions and GROUP BY were
introduced previously at <a class="reference internal" href="#tutorial-group-by-w-aggregates"><span class="std std-ref">Aggregate functions with GROUP BY / HAVING</span></a>):</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">subq</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">),</span>
<span class="gp">... </span>    <span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_id</span>
<span class="gp">... </span><span class="p">)</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">subquery</span><span class="p">()</span></pre></div>
</div>
<p>Stringifying the subquery by itself without it being embedded inside of another
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a> or other statement produces the plain SELECT statement
without any enclosing parenthesis:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">subq</span><span class="p">)</span>
<div class='show_sql'><span class="k">SELECT</span> <span class="k">count</span><span class="p">(</span><span class="n">address</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="k">AS</span> <span class="k">count</span><span class="p">,</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span>
<span class="k">FROM</span> <span class="n">address</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span>
</div></pre></div>
</div>
<p>The <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Subquery" title="sqlalchemy.sql.expression.Subquery"><code class="xref py py-class docutils literal notranslate"><span class="pre">Subquery</span></code></a> object behaves like any other FROM object such
as a <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>, notably that it includes a <code class="xref py py-attr docutils literal notranslate"><span class="pre">Subquery.c</span></code>
namespace of the columns which it selects.  We can use this namespace to
refer to both the <code class="docutils literal notranslate"><span class="pre">user_id</span></code> column as well as our custom labeled
<code class="docutils literal notranslate"><span class="pre">count</span></code> expression:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">subq</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">subq</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">count</span><span class="p">))</span>
<div class='show_sql'><span class="k">SELECT</span> <span class="n">anon_1</span><span class="p">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">anon_1</span><span class="p">.</span><span class="k">count</span>
<span class="k">FROM</span> <span class="p">(</span><span class="k">SELECT</span> <span class="k">count</span><span class="p">(</span><span class="n">address</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="k">AS</span> <span class="k">count</span><span class="p">,</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span> <span class="k">AS</span> <span class="n">user_id</span>
<span class="k">FROM</span> <span class="n">address</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">anon_1</span>
</div></pre></div>
</div>
<p>With a selection of rows contained within the <code class="docutils literal notranslate"><span class="pre">subq</span></code> object, we can apply
the object to a larger <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a> that will join the data to
the <code class="docutils literal notranslate"><span class="pre">user_account</span></code> table:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span>
<span class="gp">... </span>   <span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<span class="gp">... </span>   <span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">fullname</span><span class="p">,</span>
<span class="gp">... </span>   <span class="n">subq</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">count</span>
<span class="gp">... </span><span class="p">)</span><span class="o">.</span><span class="n">join_from</span><span class="p">(</span><span class="n">user_table</span><span class="p">,</span> <span class="n">subq</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<div class='show_sql'><span class="k">SELECT</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">fullname</span><span class="p">,</span> <span class="n">anon_1</span><span class="p">.</span><span class="k">count</span>
<span class="k">FROM</span> <span class="n">user_account</span> <span class="k">JOIN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="k">count</span><span class="p">(</span><span class="n">address</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="k">AS</span> <span class="k">count</span><span class="p">,</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span> <span class="k">AS</span> <span class="n">user_id</span>
<span class="k">FROM</span> <span class="n">address</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">anon_1</span> <span class="k">ON</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">anon_1</span><span class="p">.</span><span class="n">user_id</span>
</div></pre></div>
</div>
<p>In order to join from <code class="docutils literal notranslate"><span class="pre">user_account</span></code> to <code class="docutils literal notranslate"><span class="pre">address</span></code>, we made use of the
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.join_from" title="sqlalchemy.sql.expression.Select.join_from"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.join_from()</span></code></a> method.   As has been illustrated previously, the
ON clause of this join was again <strong>inferred</strong> based on foreign key constraints.
Even though a SQL subquery does not itself have any constraints, SQLAlchemy can
act upon constraints represented on the columns by determining that the
<code class="docutils literal notranslate"><span class="pre">subq.c.user_id</span></code> column is <strong>derived</strong> from the <code class="docutils literal notranslate"><span class="pre">address_table.c.user_id</span></code>
column, which does express a foreign key relationship back to the
<code class="docutils literal notranslate"><span class="pre">user_table.c.id</span></code> column which is then used to generate the ON clause.</p>
<section id="common-table-expressions-ctes">
<h3>Common Table Expressions (CTEs)<a class="headerlink" href="#common-table-expressions-ctes" title="Permalink to this headline">¶</a></h3>
<p>Usage of the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.CTE" title="sqlalchemy.sql.expression.CTE"><code class="xref py py-class docutils literal notranslate"><span class="pre">CTE</span></code></a> construct in SQLAlchemy is virtually
the same as how the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Subquery" title="sqlalchemy.sql.expression.Subquery"><code class="xref py py-class docutils literal notranslate"><span class="pre">Subquery</span></code></a> construct is used.  By changing
the invocation of the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.subquery" title="sqlalchemy.sql.expression.Select.subquery"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.subquery()</span></code></a> method to use
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.cte" title="sqlalchemy.sql.expression.Select.cte"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.cte()</span></code></a> instead, we can use the resulting object as a FROM
element in the same way, but the SQL rendered is the very different common
table expression syntax:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">subq</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">),</span>
<span class="gp">... </span>    <span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_id</span>
<span class="gp">... </span><span class="p">)</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">cte</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span>
<span class="gp">... </span>   <span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<span class="gp">... </span>   <span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">fullname</span><span class="p">,</span>
<span class="gp">... </span>   <span class="n">subq</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">count</span>
<span class="gp">... </span><span class="p">)</span><span class="o">.</span><span class="n">join_from</span><span class="p">(</span><span class="n">user_table</span><span class="p">,</span> <span class="n">subq</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<div class='show_sql'><span class="k">WITH</span> <span class="n">anon_1</span> <span class="k">AS</span>
<span class="p">(</span><span class="k">SELECT</span> <span class="k">count</span><span class="p">(</span><span class="n">address</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="k">AS</span> <span class="k">count</span><span class="p">,</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span> <span class="k">AS</span> <span class="n">user_id</span>
<span class="k">FROM</span> <span class="n">address</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span><span class="p">)</span>
 <span class="k">SELECT</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">fullname</span><span class="p">,</span> <span class="n">anon_1</span><span class="p">.</span><span class="k">count</span>
<span class="k">FROM</span> <span class="n">user_account</span> <span class="k">JOIN</span> <span class="n">anon_1</span> <span class="k">ON</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">anon_1</span><span class="p">.</span><span class="n">user_id</span>
</div></pre></div>
</div>
<p>The <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.CTE" title="sqlalchemy.sql.expression.CTE"><code class="xref py py-class docutils literal notranslate"><span class="pre">CTE</span></code></a> construct also features the ability to be used
in a “recursive” style, and may in more elaborate cases be composed from the
RETURNING clause of an INSERT, UPDATE or DELETE statement.  The docstring
for <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.CTE" title="sqlalchemy.sql.expression.CTE"><code class="xref py py-class docutils literal notranslate"><span class="pre">CTE</span></code></a> includes details on these additional patterns.</p>
<p>In both cases, the subquery and CTE were named at the SQL level using an
“anonymous” name.  In the Python code, we don’t need to provide these names
at all.  The object identity of the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Subquery" title="sqlalchemy.sql.expression.Subquery"><code class="xref py py-class docutils literal notranslate"><span class="pre">Subquery</span></code></a> or <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.CTE" title="sqlalchemy.sql.expression.CTE"><code class="xref py py-class docutils literal notranslate"><span class="pre">CTE</span></code></a>
instances serves as the syntactical identity of the object when rendered.
A name that will be rendered in the SQL can be provided by passing it as the
first argument of the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.subquery" title="sqlalchemy.sql.expression.Select.subquery"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.subquery()</span></code></a> or <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.cte" title="sqlalchemy.sql.expression.Select.cte"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.cte()</span></code></a> methods.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.subquery" title="sqlalchemy.sql.expression.Select.subquery"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.subquery()</span></code></a> - further detail on subqueries</p>
<p><a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.cte" title="sqlalchemy.sql.expression.Select.cte"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.cte()</span></code></a> - examples for CTE including how to use
RECURSIVE as well as DML-oriented CTEs</p>
</div>
</section>
<section id="orm-entity-subqueries-ctes">
<h3>ORM Entity Subqueries/CTEs<a class="headerlink" href="#orm-entity-subqueries-ctes" title="Permalink to this headline">¶</a></h3>
<p>In the ORM, the <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.aliased" title="sqlalchemy.orm.aliased"><code class="xref py py-func docutils literal notranslate"><span class="pre">aliased()</span></code></a> construct may be used to associate an ORM
entity, such as our <code class="docutils literal notranslate"><span class="pre">User</span></code> or <code class="docutils literal notranslate"><span class="pre">Address</span></code> class, with any <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.FromClause" title="sqlalchemy.sql.expression.FromClause"><code class="xref py py-class docutils literal notranslate"><span class="pre">FromClause</span></code></a>
concept that represents a source of rows.  The preceding section
<a class="reference internal" href="#tutorial-orm-entity-aliases"><span class="std std-ref">ORM Entity Aliases</span></a> illustrates using <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.aliased" title="sqlalchemy.orm.aliased"><code class="xref py py-func docutils literal notranslate"><span class="pre">aliased()</span></code></a>
to associate the mapped class with an <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Alias" title="sqlalchemy.sql.expression.Alias"><code class="xref py py-class docutils literal notranslate"><span class="pre">Alias</span></code></a> of its
mapped <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>.   Here we illustrate <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.aliased" title="sqlalchemy.orm.aliased"><code class="xref py py-func docutils literal notranslate"><span class="pre">aliased()</span></code></a> doing the same
thing against both a <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Subquery" title="sqlalchemy.sql.expression.Subquery"><code class="xref py py-class docutils literal notranslate"><span class="pre">Subquery</span></code></a> as well as a <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.CTE" title="sqlalchemy.sql.expression.CTE"><code class="xref py py-class docutils literal notranslate"><span class="pre">CTE</span></code></a>
generated against a <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a> construct, that ultimately derives
from that same mapped <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>.</p>
<p>Below is an example of applying <a class="reference internal" href="../orm/query.html#sqlalchemy.orm.aliased" title="sqlalchemy.orm.aliased"><code class="xref py py-func docutils literal notranslate"><span class="pre">aliased()</span></code></a> to the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Subquery" title="sqlalchemy.sql.expression.Subquery"><code class="xref py py-class docutils literal notranslate"><span class="pre">Subquery</span></code></a>
construct, so that ORM entities can be extracted from its rows.  The result
shows a series of <code class="docutils literal notranslate"><span class="pre">User</span></code> and <code class="docutils literal notranslate"><span class="pre">Address</span></code> objects, where the data for
each <code class="docutils literal notranslate"><span class="pre">Address</span></code> object ultimately came from a subquery against the
<code class="docutils literal notranslate"><span class="pre">address</span></code> table rather than that table directly:</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">subq</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">Address</span><span class="o">.</span><span class="n">email_address</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s1">&#39;%@aol.com&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">subquery</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">address_subq</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">Address</span><span class="p">,</span> <span class="n">subq</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">address_subq</span><span class="p">)</span><span class="o">.</span><span class="n">join_from</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">address_subq</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">address_subq</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">user</span><span class="p">,</span> <span class="n">address</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">):</span>
<span class="o">...</span>         <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<div class='show_sql'><span class="k">BEGIN</span> <span class="p">(</span><span class="k">implicit</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">fullname</span><span class="p">,</span>
<span class="n">anon_1</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">id_1</span><span class="p">,</span> <span class="n">anon_1</span><span class="p">.</span><span class="n">email_address</span><span class="p">,</span> <span class="n">anon_1</span><span class="p">.</span><span class="n">user_id</span>
<span class="k">FROM</span> <span class="n">user_account</span> <span class="k">JOIN</span>
<span class="p">(</span><span class="k">SELECT</span> <span class="n">address</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">id</span><span class="p">,</span> <span class="n">address</span><span class="p">.</span><span class="n">email_address</span> <span class="k">AS</span> <span class="n">email_address</span><span class="p">,</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span> <span class="k">AS</span> <span class="n">user_id</span>
<span class="k">FROM</span> <span class="n">address</span>
<span class="k">WHERE</span> <span class="n">address</span><span class="p">.</span><span class="n">email_address</span> <span class="k">NOT</span> <span class="k">LIKE</span> <span class="o">?</span><span class="p">)</span> <span class="k">AS</span> <span class="n">anon_1</span> <span class="k">ON</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">anon_1</span><span class="p">.</span><span class="n">user_id</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">anon_1</span><span class="p">.</span><span class="n">id</span>
<span class="p">[...]</span> <span class="p">(</span><span class="s1">&#39;%@aol.com&#39;</span><span class="p">,)</span>
</div><span class="n">User</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;spongebob&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Spongebob Squarepants&#39;</span><span class="p">)</span> <span class="n">Address</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">email_address</span><span class="o">=</span><span class="s1">&#39;spongebob@sqlalchemy.org&#39;</span><span class="p">)</span>
<span class="n">User</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;sandy&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Sandy Cheeks&#39;</span><span class="p">)</span> <span class="n">Address</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">email_address</span><span class="o">=</span><span class="s1">&#39;sandy@sqlalchemy.org&#39;</span><span class="p">)</span>
<span class="n">User</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;sandy&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Sandy Cheeks&#39;</span><span class="p">)</span> <span class="n">Address</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">email_address</span><span class="o">=</span><span class="s1">&#39;sandy@squirrelpower.org&#39;</span><span class="p">)</span>
<div class='show_sql'><span class="k">ROLLBACK</span>
</div></pre></div>
</div>
<p>Another example follows, which is exactly the same except it makes use of the
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.CTE" title="sqlalchemy.sql.expression.CTE"><code class="xref py py-class docutils literal notranslate"><span class="pre">CTE</span></code></a> construct instead:</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">cte</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">Address</span><span class="o">.</span><span class="n">email_address</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s1">&#39;%@aol.com&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">cte</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">address_cte</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">Address</span><span class="p">,</span> <span class="n">cte</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">address_cte</span><span class="p">)</span><span class="o">.</span><span class="n">join_from</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">address_cte</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">address_cte</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">user</span><span class="p">,</span> <span class="n">address</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">):</span>
<span class="o">...</span>         <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<div class='show_sql'><span class="k">BEGIN</span> <span class="p">(</span><span class="k">implicit</span><span class="p">)</span>
<span class="k">WITH</span> <span class="n">anon_1</span> <span class="k">AS</span>
<span class="p">(</span><span class="k">SELECT</span> <span class="n">address</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">id</span><span class="p">,</span> <span class="n">address</span><span class="p">.</span><span class="n">email_address</span> <span class="k">AS</span> <span class="n">email_address</span><span class="p">,</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span> <span class="k">AS</span> <span class="n">user_id</span>
<span class="k">FROM</span> <span class="n">address</span>
<span class="k">WHERE</span> <span class="n">address</span><span class="p">.</span><span class="n">email_address</span> <span class="k">NOT</span> <span class="k">LIKE</span> <span class="o">?</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">fullname</span><span class="p">,</span>
<span class="n">anon_1</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">id_1</span><span class="p">,</span> <span class="n">anon_1</span><span class="p">.</span><span class="n">email_address</span><span class="p">,</span> <span class="n">anon_1</span><span class="p">.</span><span class="n">user_id</span>
<span class="k">FROM</span> <span class="n">user_account</span>
<span class="k">JOIN</span> <span class="n">anon_1</span> <span class="k">ON</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">anon_1</span><span class="p">.</span><span class="n">user_id</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">anon_1</span><span class="p">.</span><span class="n">id</span>
<span class="p">[...]</span> <span class="p">(</span><span class="s1">&#39;%@aol.com&#39;</span><span class="p">,)</span>
</div><span class="n">User</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;spongebob&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Spongebob Squarepants&#39;</span><span class="p">)</span> <span class="n">Address</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">email_address</span><span class="o">=</span><span class="s1">&#39;spongebob@sqlalchemy.org&#39;</span><span class="p">)</span>
<span class="n">User</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;sandy&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Sandy Cheeks&#39;</span><span class="p">)</span> <span class="n">Address</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">email_address</span><span class="o">=</span><span class="s1">&#39;sandy@sqlalchemy.org&#39;</span><span class="p">)</span>
<span class="n">User</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;sandy&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Sandy Cheeks&#39;</span><span class="p">)</span> <span class="n">Address</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">email_address</span><span class="o">=</span><span class="s1">&#39;sandy@squirrelpower.org&#39;</span><span class="p">)</span>
<div class='show_sql'><span class="k">ROLLBACK</span>
</div></pre></div>
</div>
</section>
</section>
<section id="scalar-and-correlated-subqueries">
<span id="tutorial-scalar-subquery"></span><h2>Scalar and Correlated Subqueries<a class="headerlink" href="#scalar-and-correlated-subqueries" title="Permalink to this headline">¶</a></h2>
<p>A scalar subquery is a subquery that returns exactly zero or one row and
exactly one column.  The subquery is then used in the COLUMNS or WHERE clause
of an enclosing SELECT statement and is different than a regular subquery in
that it is not used in the FROM clause.   A <a class="reference internal" href="../glossary.html#term-correlated-subquery"><span class="xref std std-term">correlated subquery</span></a> is a
scalar subquery that refers to a table in the enclosing SELECT statement.</p>
<p>SQLAlchemy represents the scalar subquery using the
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.ScalarSelect" title="sqlalchemy.sql.expression.ScalarSelect"><code class="xref py py-class docutils literal notranslate"><span class="pre">ScalarSelect</span></code></a> construct, which is part of the
<a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.ColumnElement" title="sqlalchemy.sql.expression.ColumnElement"><code class="xref py py-class docutils literal notranslate"><span class="pre">ColumnElement</span></code></a> expression hierarchy, in contrast to the regular
subquery which is represented by the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Subquery" title="sqlalchemy.sql.expression.Subquery"><code class="xref py py-class docutils literal notranslate"><span class="pre">Subquery</span></code></a> construct, which is
in the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.FromClause" title="sqlalchemy.sql.expression.FromClause"><code class="xref py py-class docutils literal notranslate"><span class="pre">FromClause</span></code></a> hierarchy.</p>
<p>Scalar subqueries are often, but not necessarily, used with aggregate functions,
introduced previously at <a class="reference internal" href="#tutorial-group-by-w-aggregates"><span class="std std-ref">Aggregate functions with GROUP BY / HAVING</span></a>.   A scalar
subquery is indicated explicitly by making use of the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.scalar_subquery" title="sqlalchemy.sql.expression.Select.scalar_subquery"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.scalar_subquery()</span></code></a>
method as below.  It’s default string form when stringified by itself
renders as an ordinary SELECT statement that is selecting from two tables:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">subq</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">))</span><span class="o">.</span>\
<span class="gp">... </span>            <span class="n">where</span><span class="p">(</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span>\
<span class="gp">... </span>            <span class="n">scalar_subquery</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">subq</span><span class="p">)</span>
<div class='show_sql'><span class="p">(</span><span class="k">SELECT</span> <span class="k">count</span><span class="p">(</span><span class="n">address</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">count_1</span>
<span class="k">FROM</span> <span class="n">address</span><span class="p">,</span> <span class="n">user_account</span>
<span class="k">WHERE</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span><span class="p">)</span>
</div></pre></div>
</div>
<p>The above <code class="docutils literal notranslate"><span class="pre">subq</span></code> object now falls within the <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.ColumnElement" title="sqlalchemy.sql.expression.ColumnElement"><code class="xref py py-class docutils literal notranslate"><span class="pre">ColumnElement</span></code></a>
SQL expression hierarchy, in that it may be used like any other column
expression:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">subq</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
<div class='show_sql'><span class="p">(</span><span class="k">SELECT</span> <span class="k">count</span><span class="p">(</span><span class="n">address</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">count_1</span>
<span class="k">FROM</span> <span class="n">address</span><span class="p">,</span> <span class="n">user_account</span>
<span class="k">WHERE</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span><span class="p">)</span> <span class="o">=</span> <span class="p">:</span><span class="n">param_1</span>
</div></pre></div>
</div>
<p>Although the scalar subquery by itself renders both <code class="docutils literal notranslate"><span class="pre">user_account</span></code> and
<code class="docutils literal notranslate"><span class="pre">address</span></code> in its FROM clause when stringified by itself, when embedding it
into an enclosing <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> construct that deals with the
<code class="docutils literal notranslate"><span class="pre">user_account</span></code> table, the <code class="docutils literal notranslate"><span class="pre">user_account</span></code> table is automatically
<strong>correlated</strong>, meaning it does not render in the FROM clause of the subquery:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">subq</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;address_count&quot;</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<div class='show_sql'><span class="k">SELECT</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="k">SELECT</span> <span class="k">count</span><span class="p">(</span><span class="n">address</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">count_1</span>
<span class="k">FROM</span> <span class="n">address</span>
<span class="k">WHERE</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">address_count</span>
<span class="k">FROM</span> <span class="n">user_account</span>
</div></pre></div>
</div>
<p>Simple correlated subqueries will usually do the right thing that’s desired.
However, in the case where the correlation is ambiguous, SQLAlchemy will let
us know that more clarity is needed:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">email_address</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">subq</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;address_count&quot;</span><span class="p">)</span>
<span class="gp">... </span><span class="p">)</span><span class="o">.</span>\
<span class="gp">... </span><span class="n">join_from</span><span class="p">(</span><span class="n">user_table</span><span class="p">,</span> <span class="n">address_table</span><span class="p">)</span><span class="o">.</span>\
<span class="gp">... </span><span class="n">order_by</span><span class="p">(</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="gp">...</span>
<span class="go">InvalidRequestError: Select statement &#39;&lt;... Select object at ...&gt;&#39; returned</span>
<span class="go">no FROM clauses due to auto-correlation; specify correlate(&lt;tables&gt;) to</span>
<span class="go">control correlation manually.</span></pre></div>
</div>
<p>To specify that the <code class="docutils literal notranslate"><span class="pre">user_table</span></code> is the one we seek to correlate we specify
this using the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.ScalarSelect.correlate" title="sqlalchemy.sql.expression.ScalarSelect.correlate"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ScalarSelect.correlate()</span></code></a> or
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.ScalarSelect.correlate_except" title="sqlalchemy.sql.expression.ScalarSelect.correlate_except"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ScalarSelect.correlate_except()</span></code></a> methods:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">subq</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">))</span><span class="o">.</span>\
<span class="gp">... </span>            <span class="n">where</span><span class="p">(</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span>\
<span class="gp">... </span>            <span class="n">scalar_subquery</span><span class="p">()</span><span class="o">.</span><span class="n">correlate</span><span class="p">(</span><span class="n">user_table</span><span class="p">)</span></pre></div>
</div>
<p>The statement then can return the data for this column like any other:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="gp">... </span>        <span class="n">select</span><span class="p">(</span>
<span class="gp">... </span>            <span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<span class="gp">... </span>            <span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">email_address</span><span class="p">,</span>
<span class="gp">... </span>            <span class="n">subq</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;address_count&quot;</span><span class="p">)</span>
<span class="gp">... </span>        <span class="p">)</span><span class="o">.</span>
<span class="gp">... </span>        <span class="n">join_from</span><span class="p">(</span><span class="n">user_table</span><span class="p">,</span> <span class="n">address_table</span><span class="p">)</span><span class="o">.</span>
<span class="gp">... </span>        <span class="n">order_by</span><span class="p">(</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="gp">... </span>    <span class="p">)</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
<div class='show_sql'><span class="k">BEGIN</span> <span class="p">(</span><span class="k">implicit</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">address</span><span class="p">.</span><span class="n">email_address</span><span class="p">,</span> <span class="p">(</span><span class="k">SELECT</span> <span class="k">count</span><span class="p">(</span><span class="n">address</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">count_1</span>
<span class="k">FROM</span> <span class="n">address</span>
<span class="k">WHERE</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">address_count</span>
<span class="k">FROM</span> <span class="n">user_account</span> <span class="k">JOIN</span> <span class="n">address</span> <span class="k">ON</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">address</span><span class="p">.</span><span class="n">id</span>
<span class="p">[...]</span> <span class="p">()</span>
</div><span class="go">[(&#39;spongebob&#39;, &#39;spongebob@sqlalchemy.org&#39;, 1), (&#39;sandy&#39;, &#39;sandy@sqlalchemy.org&#39;, 2),</span>
<span class="go"> (&#39;sandy&#39;, &#39;sandy@squirrelpower.org&#39;, 2)]</span>
<div class='show_sql'><span class="k">ROLLBACK</span>
</div></pre></div>
</div>
</section>
<section id="union-union-all-and-other-set-operations">
<span id="tutorial-union"></span><h2>UNION, UNION ALL and other set operations<a class="headerlink" href="#union-union-all-and-other-set-operations" title="Permalink to this headline">¶</a></h2>
<p>In SQL,SELECT statements can be merged together using the UNION or UNION ALL
SQL operation, which produces the set of all rows produced by one or more
statements together.  Other set operations such as INTERSECT [ALL] and
EXCEPT [ALL] are also possible.</p>
<p>SQLAlchemy’s <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a> construct supports compositions of this
nature using functions like <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.union" title="sqlalchemy.sql.expression.union"><code class="xref py py-func docutils literal notranslate"><span class="pre">union()</span></code></a>, <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.intersect" title="sqlalchemy.sql.expression.intersect"><code class="xref py py-func docutils literal notranslate"><span class="pre">intersect()</span></code></a> and
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.except_" title="sqlalchemy.sql.expression.except_"><code class="xref py py-func docutils literal notranslate"><span class="pre">except_()</span></code></a>, and the “all” counterparts <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.union_all" title="sqlalchemy.sql.expression.union_all"><code class="xref py py-func docutils literal notranslate"><span class="pre">union_all()</span></code></a>,
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.intersect_all" title="sqlalchemy.sql.expression.intersect_all"><code class="xref py py-func docutils literal notranslate"><span class="pre">intersect_all()</span></code></a> and <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.except_all" title="sqlalchemy.sql.expression.except_all"><code class="xref py py-func docutils literal notranslate"><span class="pre">except_all()</span></code></a>. These functions all
accept an arbitrary number of sub-selectables, which are typically
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a> constructs but may also be an existing composition.</p>
<p>The construct produced by these functions is the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.CompoundSelect" title="sqlalchemy.sql.expression.CompoundSelect"><code class="xref py py-class docutils literal notranslate"><span class="pre">CompoundSelect</span></code></a>,
which is used in the same manner as the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a> construct, except
that it has fewer methods.   The <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.CompoundSelect" title="sqlalchemy.sql.expression.CompoundSelect"><code class="xref py py-class docutils literal notranslate"><span class="pre">CompoundSelect</span></code></a> produced by
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.union_all" title="sqlalchemy.sql.expression.union_all"><code class="xref py py-func docutils literal notranslate"><span class="pre">union_all()</span></code></a> for example may be invoked directly using
<a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Connection.execute" title="sqlalchemy.engine.Connection.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.execute()</span></code></a>:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">union_all</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt1</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">user_table</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;sandy&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt2</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">user_table</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;spongebob&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u</span> <span class="o">=</span> <span class="n">union_all</span><span class="p">(</span><span class="n">stmt1</span><span class="p">,</span> <span class="n">stmt2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
<div class='show_sql'><span class="k">BEGIN</span> <span class="p">(</span><span class="k">implicit</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">fullname</span>
<span class="k">FROM</span> <span class="n">user_account</span>
<span class="k">WHERE</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="o">?</span>
<span class="k">UNION</span> <span class="k">ALL</span> <span class="k">SELECT</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">fullname</span>
<span class="k">FROM</span> <span class="n">user_account</span>
<span class="k">WHERE</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="o">?</span>
<span class="p">[</span><span class="k">generated</span> <span class="k">in</span> <span class="p">...]</span> <span class="p">(</span><span class="s1">&#39;sandy&#39;</span><span class="p">,</span> <span class="s1">&#39;spongebob&#39;</span><span class="p">)</span>
</div><span class="go">[(2, &#39;sandy&#39;, &#39;Sandy Cheeks&#39;), (1, &#39;spongebob&#39;, &#39;Spongebob Squarepants&#39;)]</span>
<div class='show_sql'><span class="k">ROLLBACK</span>
</div></pre></div>
</div>
<p>To use a <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.CompoundSelect" title="sqlalchemy.sql.expression.CompoundSelect"><code class="xref py py-class docutils literal notranslate"><span class="pre">CompoundSelect</span></code></a> as a subquery, just like <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a>
it provides a <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.SelectBase.subquery" title="sqlalchemy.sql.expression.SelectBase.subquery"><code class="xref py py-meth docutils literal notranslate"><span class="pre">SelectBase.subquery()</span></code></a> method which will produce a
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Subquery" title="sqlalchemy.sql.expression.Subquery"><code class="xref py py-class docutils literal notranslate"><span class="pre">Subquery</span></code></a> object with a <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.FromClause.c" title="sqlalchemy.sql.expression.FromClause.c"><code class="xref py py-attr docutils literal notranslate"><span class="pre">FromClause.c</span></code></a>
collection that may be referred towards in an enclosing <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a>:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">u_subq</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">subquery</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
<span class="gp">... </span>    <span class="n">select</span><span class="p">(</span><span class="n">u_subq</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">email_address</span><span class="p">)</span><span class="o">.</span>
<span class="gp">... </span>    <span class="n">join_from</span><span class="p">(</span><span class="n">address_table</span><span class="p">,</span> <span class="n">u_subq</span><span class="p">)</span><span class="o">.</span>
<span class="gp">... </span>    <span class="n">order_by</span><span class="p">(</span><span class="n">u_subq</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">email_address</span><span class="p">)</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
<div class='show_sql'><span class="k">BEGIN</span> <span class="p">(</span><span class="k">implicit</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">anon_1</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">address</span><span class="p">.</span><span class="n">email_address</span>
<span class="k">FROM</span> <span class="n">address</span> <span class="k">JOIN</span>
  <span class="p">(</span><span class="k">SELECT</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">id</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span> <span class="k">AS</span> <span class="n">name</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">fullname</span> <span class="k">AS</span> <span class="n">fullname</span>
  <span class="k">FROM</span> <span class="n">user_account</span>
  <span class="k">WHERE</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="o">?</span>
<span class="k">UNION</span> <span class="k">ALL</span>
  <span class="k">SELECT</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">id</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span> <span class="k">AS</span> <span class="n">name</span><span class="p">,</span> <span class="n">user_account</span><span class="p">.</span><span class="n">fullname</span> <span class="k">AS</span> <span class="n">fullname</span>
  <span class="k">FROM</span> <span class="n">user_account</span>
  <span class="k">WHERE</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="o">?</span><span class="p">)</span>
<span class="k">AS</span> <span class="n">anon_1</span> <span class="k">ON</span> <span class="n">anon_1</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">anon_1</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">address</span><span class="p">.</span><span class="n">email_address</span>
<span class="p">[</span><span class="k">generated</span> <span class="k">in</span> <span class="p">...]</span> <span class="p">(</span><span class="s1">&#39;sandy&#39;</span><span class="p">,</span> <span class="s1">&#39;spongebob&#39;</span><span class="p">)</span>
</div><span class="go">[(&#39;sandy&#39;, &#39;sandy@sqlalchemy.org&#39;), (&#39;sandy&#39;, &#39;sandy@squirrelpower.org&#39;), (&#39;spongebob&#39;, &#39;spongebob@sqlalchemy.org&#39;)]</span>
<div class='show_sql'><span class="k">ROLLBACK</span>
</div></pre></div>
</div>
</section>
<section id="exists-subqueries">
<span id="tutorial-exists"></span><h2>EXISTS subqueries<a class="headerlink" href="#exists-subqueries" title="Permalink to this headline">¶</a></h2>
<p>The SQL EXISTS keyword is an operator that is used with <a class="reference internal" href="#tutorial-scalar-subquery"><span class="std std-ref">scalar subqueries</span></a> to return a boolean true or false depending on if
the SELECT statement would return a row.  SQLAlchemy includes a variant of the
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.ScalarSelect" title="sqlalchemy.sql.expression.ScalarSelect"><code class="xref py py-class docutils literal notranslate"><span class="pre">ScalarSelect</span></code></a> object called <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Exists" title="sqlalchemy.sql.expression.Exists"><code class="xref py py-class docutils literal notranslate"><span class="pre">Exists</span></code></a>, which will
generate an EXISTS subquery and is most conveniently generated using the
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.SelectBase.exists" title="sqlalchemy.sql.expression.SelectBase.exists"><code class="xref py py-meth docutils literal notranslate"><span class="pre">SelectBase.exists()</span></code></a> method.  Below we produce an EXISTS so that we
can return <code class="docutils literal notranslate"><span class="pre">user_account</span></code> rows that have more than one related row in
<code class="docutils literal notranslate"><span class="pre">address</span></code>:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">subq</span> <span class="o">=</span> <span class="p">(</span>
<span class="gp">... </span>    <span class="n">select</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">))</span><span class="o">.</span>
<span class="gp">... </span>    <span class="n">where</span><span class="p">(</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span>
<span class="gp">... </span>    <span class="n">group_by</span><span class="p">(</span><span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span>
<span class="gp">... </span>    <span class="n">having</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
<span class="gp">... </span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="gp">... </span>        <span class="n">select</span><span class="p">(</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">subq</span><span class="p">)</span>
<span class="gp">... </span>    <span class="p">)</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
<div class='show_sql'><span class="k">BEGIN</span> <span class="p">(</span><span class="k">implicit</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span>
<span class="k">FROM</span> <span class="n">user_account</span>
<span class="k">WHERE</span> <span class="k">EXISTS</span> <span class="p">(</span><span class="k">SELECT</span> <span class="k">count</span><span class="p">(</span><span class="n">address</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">count_1</span>
<span class="k">FROM</span> <span class="n">address</span>
<span class="k">WHERE</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span>
<span class="k">HAVING</span> <span class="k">count</span><span class="p">(</span><span class="n">address</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">?</span><span class="p">)</span>
<span class="p">[...]</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
</div><span class="go">[(&#39;sandy&#39;,)]</span>
<div class='show_sql'><span class="k">ROLLBACK</span>
</div></pre></div>
</div>
<p>The EXISTS construct is more often than not used as a negation, e.g. NOT EXISTS,
as it provides a SQL-efficient form of locating rows for which a related
table has no rows.  Below we select user names that have no email addresses;
note the binary negation operator (<code class="docutils literal notranslate"><span class="pre">~</span></code>) used inside the second WHERE
clause:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">subq</span> <span class="o">=</span> <span class="p">(</span>
<span class="gp">... </span>    <span class="n">select</span><span class="p">(</span><span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span>
<span class="gp">... </span>    <span class="n">where</span><span class="p">(</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
<span class="gp">... </span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="gp">... </span>        <span class="n">select</span><span class="p">(</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">subq</span><span class="p">)</span>
<span class="gp">... </span>    <span class="p">)</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
<div class='show_sql'><span class="k">BEGIN</span> <span class="p">(</span><span class="k">implicit</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span>
<span class="k">FROM</span> <span class="n">user_account</span>
<span class="k">WHERE</span> <span class="k">NOT</span> <span class="p">(</span><span class="k">EXISTS</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">address</span><span class="p">.</span><span class="n">id</span>
<span class="k">FROM</span> <span class="n">address</span>
<span class="k">WHERE</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span><span class="p">))</span>
<span class="p">[...]</span> <span class="p">()</span>
</div><span class="go">[(&#39;patrick&#39;,)]</span>
<div class='show_sql'><span class="k">ROLLBACK</span>
</div></pre></div>
</div>
</section>
<section id="working-with-sql-functions">
<span id="tutorial-functions"></span><h2>Working with SQL Functions<a class="headerlink" href="#working-with-sql-functions" title="Permalink to this headline">¶</a></h2>
<p>First introduced earlier in this section at
<a class="reference internal" href="#tutorial-group-by-w-aggregates"><span class="std std-ref">Aggregate functions with GROUP BY / HAVING</span></a>, the <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.func" title="sqlalchemy.sql.expression.func"><code class="xref py py-data docutils literal notranslate"><span class="pre">func</span></code></a> object serves as a
factory for creating new <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.Function" title="sqlalchemy.sql.functions.Function"><code class="xref py py-class docutils literal notranslate"><span class="pre">Function</span></code></a> objects, which when used
in a construct like <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a>, produce a SQL function display,
typically consisting of a name, some parenthesis (although not always), and
possibly some arguments. Examples of typical SQL functions include:</p>
<ul>
<li><p>the <code class="docutils literal notranslate"><span class="pre">count()</span></code> function, an aggregate function which counts how many
rows are returned:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">())</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">user_table</span><span class="p">))</span>
<span class="go">SELECT count(*) AS count_1</span>
<span class="go">FROM user_account</span></pre></div>
</div>
</li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">lower()</span></code> function, a string function that converts a string to lower
case:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="s2">&quot;A String With Much UPPERCASE&quot;</span><span class="p">)))</span>
<span class="go">SELECT lower(:lower_2) AS lower_1</span></pre></div>
</div>
</li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">now()</span></code> function, which provides for the current date and time; as this
is a common function, SQLAlchemy knows how to render this differently for each
backend, in the case of SQLite using the CURRENT_TIMESTAMP function:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
<div class='show_sql'><span class="k">BEGIN</span> <span class="p">(</span><span class="k">implicit</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="k">CURRENT_TIMESTAMP</span> <span class="k">AS</span> <span class="n">now_1</span>
<span class="p">[...]</span> <span class="p">()</span>
<span class="p">[(</span><span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">(...),)]</span>
<span class="k">ROLLBACK</span>
</div></pre></div>
</div>
</li>
</ul>
<p>As most database backends feature dozens if not hundreds of different SQL
functions, <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.func" title="sqlalchemy.sql.expression.func"><code class="xref py py-data docutils literal notranslate"><span class="pre">func</span></code></a> tries to be as liberal as possible in what it
accepts. Any name that is accessed from this namespace is automatically
considered to be a SQL function that will render in a generic way:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">some_crazy_function</span><span class="p">(</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="mi">17</span><span class="p">)))</span>
<span class="go">SELECT some_crazy_function(user_account.name, :some_crazy_function_2) AS some_crazy_function_1</span>
<span class="go">FROM user_account</span></pre></div>
</div>
<p>At the same time, a relatively small set of extremely common SQL functions such
as <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.count" title="sqlalchemy.sql.functions.count"><code class="xref py py-class docutils literal notranslate"><span class="pre">count</span></code></a>, <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.now" title="sqlalchemy.sql.functions.now"><code class="xref py py-class docutils literal notranslate"><span class="pre">now</span></code></a>, <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.max" title="sqlalchemy.sql.functions.max"><code class="xref py py-class docutils literal notranslate"><span class="pre">max</span></code></a>,
<a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.concat" title="sqlalchemy.sql.functions.concat"><code class="xref py py-class docutils literal notranslate"><span class="pre">concat</span></code></a> include pre-packaged versions of themselves which
provide for proper typing information as well as backend-specific SQL
generation in some cases.  The example below contrasts the SQL generation
that occurs for the PostgreSQL dialect compared to the Oracle dialect for
the <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.now" title="sqlalchemy.sql.functions.now"><code class="xref py py-class docutils literal notranslate"><span class="pre">now</span></code></a> function:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.dialects</span> <span class="kn">import</span> <span class="n">postgresql</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">())</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">dialect</span><span class="o">=</span><span class="n">postgresql</span><span class="o">.</span><span class="n">dialect</span><span class="p">()))</span>
<span class="go">SELECT now() AS now_1</span>

<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.dialects</span> <span class="kn">import</span> <span class="n">oracle</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">())</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">dialect</span><span class="o">=</span><span class="n">oracle</span><span class="o">.</span><span class="n">dialect</span><span class="p">()))</span>
<span class="go">SELECT CURRENT_TIMESTAMP AS now_1 FROM DUAL</span></pre></div>
</div>
<section id="functions-have-return-types">
<h3>Functions Have Return Types<a class="headerlink" href="#functions-have-return-types" title="Permalink to this headline">¶</a></h3>
<p>As functions are column expressions, they also have
SQL <a class="reference internal" href="../core/types.html"><span class="std std-ref">datatypes</span></a> that describe the data type of
a generated SQL expression.  We refer to these types here as “SQL return types”,
in reference to the type of SQL value that is returned by the function
in the context of a database-side SQL expression,
as opposed to the “return type” of a Python function.</p>
<p>The SQL return type of any SQL function may be accessed, typically for
debugging purposes, by referring to the <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.Function.type" title="sqlalchemy.sql.functions.Function.type"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Function.type</span></code></a>
attribute:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">type</span>
<span class="go">DateTime()</span></pre></div>
</div>
<p>These SQL return types are significant when making
use of the function expression in the context of a larger expression; that is,
math operators will work better when the datatype of the expression is
something like <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Integer" title="sqlalchemy.types.Integer"><code class="xref py py-class docutils literal notranslate"><span class="pre">Integer</span></code></a> or <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Numeric" title="sqlalchemy.types.Numeric"><code class="xref py py-class docutils literal notranslate"><span class="pre">Numeric</span></code></a>, JSON
accessors in order to work need to be using a type such as
<a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.JSON" title="sqlalchemy.types.JSON"><code class="xref py py-class docutils literal notranslate"><span class="pre">JSON</span></code></a>.  Certain classes of functions return entire rows
instead of column values, where there is a need to refer to specific columns;
such functions are referred towards
as <a class="reference internal" href="#tutorial-functions-table-valued"><span class="std std-ref">table valued functions</span></a>.</p>
<p>The SQL return type of the function may also be significant when executing a
statement and getting rows back, for those cases where SQLAlchemy has to apply
result-set processing. A prime example of this are date-related functions on
SQLite, where SQLAlchemy’s <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.DateTime" title="sqlalchemy.types.DateTime"><code class="xref py py-class docutils literal notranslate"><span class="pre">DateTime</span></code></a> and related datatypes take
on the role of converting from string values to Python <code class="docutils literal notranslate"><span class="pre">datetime()</span></code> objects
as result rows are received.</p>
<p>To apply a specific type to a function we’re creating, we pass it using the
<a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.Function.params.type_" title="sqlalchemy.sql.functions.Function"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Function.type_</span></code></a> parameter; the type argument may be
either a <a class="reference internal" href="../core/type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeEngine</span></code></a> class or an instance.  In the example
below we pass the <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.JSON" title="sqlalchemy.types.JSON"><code class="xref py py-class docutils literal notranslate"><span class="pre">JSON</span></code></a> class to generate the PostgreSQL
<code class="docutils literal notranslate"><span class="pre">json_object()</span></code> function, noting that the SQL return type will be of
type JSON:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">JSON</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">function_expr</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">json_object</span><span class="p">(</span><span class="s1">&#39;{a, 1, b, &quot;def&quot;, c, 3.5}&#39;</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="n">JSON</span><span class="p">)</span></pre></div>
</div>
<p>By creating our JSON function with the <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.JSON" title="sqlalchemy.types.JSON"><code class="xref py py-class docutils literal notranslate"><span class="pre">JSON</span></code></a> datatype, the
SQL expression object takes on JSON-related features, such as that of accessing
elements:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">function_expr</span><span class="p">[</span><span class="s2">&quot;def&quot;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<span class="go">SELECT json_object(:json_object_1)[:json_object_2] AS anon_1</span></pre></div>
</div>
</section>
<section id="built-in-functions-have-pre-configured-return-types">
<h3>Built-in Functions Have Pre-Configured Return Types<a class="headerlink" href="#built-in-functions-have-pre-configured-return-types" title="Permalink to this headline">¶</a></h3>
<p>For common aggregate functions like <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.count" title="sqlalchemy.sql.functions.count"><code class="xref py py-class docutils literal notranslate"><span class="pre">count</span></code></a>,
<a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.max" title="sqlalchemy.sql.functions.max"><code class="xref py py-class docutils literal notranslate"><span class="pre">max</span></code></a>, <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.min" title="sqlalchemy.sql.functions.min"><code class="xref py py-class docutils literal notranslate"><span class="pre">min</span></code></a> as well as a very small number
of date functions like <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.now" title="sqlalchemy.sql.functions.now"><code class="xref py py-class docutils literal notranslate"><span class="pre">now</span></code></a> and string functions like
<a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.concat" title="sqlalchemy.sql.functions.concat"><code class="xref py py-class docutils literal notranslate"><span class="pre">concat</span></code></a>, the SQL return type is set up appropriately,
sometimes based on usage. The <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.max" title="sqlalchemy.sql.functions.max"><code class="xref py py-class docutils literal notranslate"><span class="pre">max</span></code></a> function and similar
aggregate filtering functions will set up the SQL return type based on the
argument given:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">m1</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Column</span><span class="p">(</span><span class="s2">&quot;some_int&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m1</span><span class="o">.</span><span class="n">type</span>
<span class="go">Integer()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">m2</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Column</span><span class="p">(</span><span class="s2">&quot;some_str&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m2</span><span class="o">.</span><span class="n">type</span>
<span class="go">String()</span></pre></div>
</div>
<p>Date and time functions typically correspond to SQL expressions described by
<a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.DateTime" title="sqlalchemy.types.DateTime"><code class="xref py py-class docutils literal notranslate"><span class="pre">DateTime</span></code></a>, <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Date" title="sqlalchemy.types.Date"><code class="xref py py-class docutils literal notranslate"><span class="pre">Date</span></code></a> or <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Time" title="sqlalchemy.types.Time"><code class="xref py py-class docutils literal notranslate"><span class="pre">Time</span></code></a>:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">type</span>
<span class="go">DateTime()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">func</span><span class="o">.</span><span class="n">current_date</span><span class="p">()</span><span class="o">.</span><span class="n">type</span>
<span class="go">Date()</span></pre></div>
</div>
<p>A known string function such as <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.concat" title="sqlalchemy.sql.functions.concat"><code class="xref py py-class docutils literal notranslate"><span class="pre">concat</span></code></a>
will know that a SQL expression would be of type <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.String" title="sqlalchemy.types.String"><code class="xref py py-class docutils literal notranslate"><span class="pre">String</span></code></a>:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">func</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">type</span>
<span class="go">String()</span></pre></div>
</div>
<p>However, for the vast majority of SQL functions, SQLAlchemy does not have them
explicitly present in its very small list of known functions.  For example,
while there is typically no issue using SQL functions <code class="docutils literal notranslate"><span class="pre">func.lower()</span></code>
and <code class="docutils literal notranslate"><span class="pre">func.upper()</span></code> to convert the casing of strings, SQLAlchemy doesn’t
actually know about these functions, so they have a “null” SQL return type:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">func</span><span class="o">.</span><span class="n">upper</span><span class="p">(</span><span class="s2">&quot;lowercase&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">type</span>
<span class="go">NullType()</span></pre></div>
</div>
<p>For simple functions like <code class="docutils literal notranslate"><span class="pre">upper</span></code> and <code class="docutils literal notranslate"><span class="pre">lower</span></code>, the issue is not usually
significant, as string values may be received from the database without any
special type handling on the SQLAlchemy side, and SQLAlchemy’s type
coercion rules can often correctly guess intent as well; the Python <code class="docutils literal notranslate"><span class="pre">+</span></code>
operator for example will be correctly interpreted as the string concatenation
operator based on looking at both sides of the expression:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">upper</span><span class="p">(</span><span class="s2">&quot;lowercase&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; suffix&quot;</span><span class="p">))</span>
<span class="go">SELECT upper(:upper_1) || :upper_2 AS anon_1</span></pre></div>
</div>
<p>Overall, the scenario where the
<a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.Function.params.type_" title="sqlalchemy.sql.functions.Function"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Function.type_</span></code></a> parameter is likely necessary is:</p>
<ol class="arabic">
<li><p>the function is not already a SQLAlchemy built-in function; this can be
evidenced by creating the function and observing the <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.Function.type" title="sqlalchemy.sql.functions.Function.type"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Function.type</span></code></a>
attribute, that is:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">type</span>
<span class="go">Integer()</span></pre></div>
</div>
<p>vs.:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">func</span><span class="o">.</span><span class="n">json_object</span><span class="p">(</span><span class="s1">&#39;{&quot;a&quot;, &quot;b&quot;}&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">type</span>
<span class="go">NullType()</span></pre></div>
</div>
</li>
<li><p>Function-aware expression support is needed; this most typically refers to
special operators related to datatypes such as <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.JSON" title="sqlalchemy.types.JSON"><code class="xref py py-class docutils literal notranslate"><span class="pre">JSON</span></code></a> or
<a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.ARRAY" title="sqlalchemy.types.ARRAY"><code class="xref py py-class docutils literal notranslate"><span class="pre">ARRAY</span></code></a></p></li>
<li><p>Result value processing is needed, which may include types such as
<code class="xref py py-class docutils literal notranslate"><span class="pre">DateTime</span></code>, <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Boolean" title="sqlalchemy.types.Boolean"><code class="xref py py-class docutils literal notranslate"><span class="pre">Boolean</span></code></a>, <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum" title="sqlalchemy.types.Enum"><code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code></a>,
or again special datatypes such as <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.JSON" title="sqlalchemy.types.JSON"><code class="xref py py-class docutils literal notranslate"><span class="pre">JSON</span></code></a>,
<a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.ARRAY" title="sqlalchemy.types.ARRAY"><code class="xref py py-class docutils literal notranslate"><span class="pre">ARRAY</span></code></a>.</p></li>
</ol>
</section>
<section id="using-window-functions">
<span id="tutorial-window-functions"></span><h3>Using Window Functions<a class="headerlink" href="#using-window-functions" title="Permalink to this headline">¶</a></h3>
<p>A window function is a special use of a SQL aggregate function which calculates
the aggregate value over the rows being returned in a group as the individual
result rows are processed.  Whereas a function like <code class="docutils literal notranslate"><span class="pre">MAX()</span></code> will give you
the highest value of a column within a set of rows, using the same function
as a “window function” will given you the highest value for each row,
<em>as of that row</em>.</p>
<p>In SQL, window functions allow one to specify the rows over which the
function should be applied, a “partition” value which considers the window
over different sub-sets of rows, and an “order by” expression which importantly
indicates the order in which rows should be applied to the aggregate function.</p>
<p>In SQLAlchemy, all SQL functions generated by the <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.func" title="sqlalchemy.sql.expression.func"><code class="xref py py-data docutils literal notranslate"><span class="pre">func</span></code></a> namespace
include a method <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.FunctionElement.over" title="sqlalchemy.sql.functions.FunctionElement.over"><code class="xref py py-meth docutils literal notranslate"><span class="pre">FunctionElement.over()</span></code></a> which
grants the window function, or “OVER”, syntax; the construct produced
is the <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.Over" title="sqlalchemy.sql.expression.Over"><code class="xref py py-class docutils literal notranslate"><span class="pre">Over</span></code></a> construct.</p>
<p>A common function used with window functions is the <code class="docutils literal notranslate"><span class="pre">row_number()</span></code> function
which simply counts rows. We may partition this row count against user name to
number the email addresses of individual users:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">func</span><span class="o">.</span><span class="n">row_number</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">partition_by</span><span class="o">=</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
<span class="gp">... </span>    <span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">email_address</span>
<span class="gp">... </span><span class="p">)</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">user_table</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">address_table</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>  
<span class="gp">... </span>    <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
<div class='show_sql'><span class="k">BEGIN</span> <span class="p">(</span><span class="k">implicit</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">row_number</span><span class="p">()</span> <span class="n">OVER</span> <span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="k">AS</span> <span class="n">anon_1</span><span class="p">,</span>
<span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">address</span><span class="p">.</span><span class="n">email_address</span>
<span class="k">FROM</span> <span class="n">user_account</span> <span class="k">JOIN</span> <span class="n">address</span> <span class="k">ON</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span>
<span class="p">[...]</span> <span class="p">()</span>
<span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;sandy&#39;</span><span class="p">,</span> <span class="s1">&#39;sandy@sqlalchemy.org&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;sandy&#39;</span><span class="p">,</span> <span class="s1">&#39;sandy@squirrelpower.org&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;spongebob&#39;</span><span class="p">,</span> <span class="s1">&#39;spongebob@sqlalchemy.org&#39;</span><span class="p">)]</span>
<span class="k">ROLLBACK</span>
</div></pre></div>
</div>
<p>Above, the <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.FunctionElement.over.params.partition_by" title="sqlalchemy.sql.functions.FunctionElement.over"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">FunctionElement.over.partition_by</span></code></a> parameter
is used so that the <code class="docutils literal notranslate"><span class="pre">PARTITION</span> <span class="pre">BY</span></code> clause is rendered within the OVER clause.
We also may make use of the <code class="docutils literal notranslate"><span class="pre">ORDER</span> <span class="pre">BY</span></code> clause using <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.FunctionElement.over.params.order_by" title="sqlalchemy.sql.functions.FunctionElement.over"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">FunctionElement.over.order_by</span></code></a>:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">order_by</span><span class="o">=</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
<span class="gp">... </span>    <span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">email_address</span><span class="p">)</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">user_table</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">address_table</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>  
<span class="gp">... </span>    <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
<div class='show_sql'><span class="k">BEGIN</span> <span class="p">(</span><span class="k">implicit</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="n">OVER</span> <span class="p">(</span><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="k">AS</span> <span class="n">anon_1</span><span class="p">,</span>
<span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">address</span><span class="p">.</span><span class="n">email_address</span>
<span class="k">FROM</span> <span class="n">user_account</span> <span class="k">JOIN</span> <span class="n">address</span> <span class="k">ON</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span>
<span class="p">[...]</span> <span class="p">()</span>
<span class="p">[(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;sandy&#39;</span><span class="p">,</span> <span class="s1">&#39;sandy@sqlalchemy.org&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;sandy&#39;</span><span class="p">,</span> <span class="s1">&#39;sandy@squirrelpower.org&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;spongebob&#39;</span><span class="p">,</span> <span class="s1">&#39;spongebob@sqlalchemy.org&#39;</span><span class="p">)]</span>
<span class="k">ROLLBACK</span>
</div></pre></div>
</div>
<p>Further options for window functions include usage of ranges; see
<a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.over" title="sqlalchemy.sql.expression.over"><code class="xref py py-func docutils literal notranslate"><span class="pre">over()</span></code></a> for more examples.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>It’s important to note that the <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.FunctionElement.over" title="sqlalchemy.sql.functions.FunctionElement.over"><code class="xref py py-meth docutils literal notranslate"><span class="pre">FunctionElement.over()</span></code></a>
method only applies to those SQL functions which are in fact aggregate
functions; while the <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.Over" title="sqlalchemy.sql.expression.Over"><code class="xref py py-class docutils literal notranslate"><span class="pre">Over</span></code></a> construct will happily render itself
for any SQL function given, the database will reject the expression if the
function itself is not a SQL aggregate function.</p>
</div>
</section>
<section id="special-modifiers-within-group-filter">
<span id="tutorial-functions-within-group"></span><h3>Special Modifiers WITHIN GROUP, FILTER<a class="headerlink" href="#special-modifiers-within-group-filter" title="Permalink to this headline">¶</a></h3>
<p>The “WITHIN GROUP” SQL syntax is used in conjunction with an “ordered set”
or a “hypothetical set” aggregate
function.  Common “ordered set” functions include <code class="docutils literal notranslate"><span class="pre">percentile_cont()</span></code>
and <code class="docutils literal notranslate"><span class="pre">rank()</span></code>.  SQLAlchemy includes built in implementations
<a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.rank" title="sqlalchemy.sql.functions.rank"><code class="xref py py-class docutils literal notranslate"><span class="pre">rank</span></code></a>, <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.dense_rank" title="sqlalchemy.sql.functions.dense_rank"><code class="xref py py-class docutils literal notranslate"><span class="pre">dense_rank</span></code></a>,
<a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.mode" title="sqlalchemy.sql.functions.mode"><code class="xref py py-class docutils literal notranslate"><span class="pre">mode</span></code></a>, <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.percentile_cont" title="sqlalchemy.sql.functions.percentile_cont"><code class="xref py py-class docutils literal notranslate"><span class="pre">percentile_cont</span></code></a> and
<a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.percentile_disc" title="sqlalchemy.sql.functions.percentile_disc"><code class="xref py py-class docutils literal notranslate"><span class="pre">percentile_disc</span></code></a> which include a <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.FunctionElement.within_group" title="sqlalchemy.sql.functions.FunctionElement.within_group"><code class="xref py py-meth docutils literal notranslate"><span class="pre">FunctionElement.within_group()</span></code></a>
method:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">func</span><span class="o">.</span><span class="n">unnest</span><span class="p">(</span>
<span class="gp">... </span>        <span class="n">func</span><span class="o">.</span><span class="n">percentile_disc</span><span class="p">([</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.75</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">within_group</span><span class="p">(</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">... </span>    <span class="p">)</span>
<span class="gp">... </span><span class="p">)</span>
<span class="go">unnest(percentile_disc(:percentile_disc_1) WITHIN GROUP (ORDER BY user_account.name))</span></pre></div>
</div>
<p>“FILTER” is supported by some backends to limit the range of an aggregate function to a
particular subset of rows compared to the total range of rows returned, available
using the <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.FunctionElement.filter" title="sqlalchemy.sql.functions.FunctionElement.filter"><code class="xref py py-meth docutils literal notranslate"><span class="pre">FunctionElement.filter()</span></code></a> method:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">email_address</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;sandy&#39;</span><span class="p">),</span>
<span class="gp">... </span>    <span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">address_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">email_address</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;spongebob&#39;</span><span class="p">)</span>
<span class="gp">... </span><span class="p">)</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">user_table</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">address_table</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>  
<span class="gp">... </span>    <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
<div class='show_sql'><span class="k">BEGIN</span> <span class="p">(</span><span class="k">implicit</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="k">count</span><span class="p">(</span><span class="n">address</span><span class="p">.</span><span class="n">email_address</span><span class="p">)</span> <span class="n">FILTER</span> <span class="p">(</span><span class="k">WHERE</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="o">?</span><span class="p">)</span> <span class="k">AS</span> <span class="n">anon_1</span><span class="p">,</span>
<span class="k">count</span><span class="p">(</span><span class="n">address</span><span class="p">.</span><span class="n">email_address</span><span class="p">)</span> <span class="n">FILTER</span> <span class="p">(</span><span class="k">WHERE</span> <span class="n">user_account</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="o">?</span><span class="p">)</span> <span class="k">AS</span> <span class="n">anon_2</span>
<span class="k">FROM</span> <span class="n">user_account</span> <span class="k">JOIN</span> <span class="n">address</span> <span class="k">ON</span> <span class="n">user_account</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">address</span><span class="p">.</span><span class="n">user_id</span>
<span class="p">[...]</span> <span class="p">(</span><span class="s1">&#39;sandy&#39;</span><span class="p">,</span> <span class="s1">&#39;spongebob&#39;</span><span class="p">)</span>
<span class="p">[(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
<span class="k">ROLLBACK</span>
</div></pre></div>
</div>
</section>
<section id="table-valued-functions">
<span id="tutorial-functions-table-valued"></span><h3>Table-Valued Functions<a class="headerlink" href="#table-valued-functions" title="Permalink to this headline">¶</a></h3>
<p>Table-valued SQL functions support a scalar representation that contains named
sub-elements. Often used for JSON and ARRAY-oriented functions as well as
functions like <code class="docutils literal notranslate"><span class="pre">generate_series()</span></code>, the table-valued function is specified in
the FROM clause, and is then referred towards as a table, or sometimes even as
a column. Functions of this form are prominent within the PostgreSQL database,
however some forms of table valued functions are also supported by SQLite,
Oracle, and SQL Server.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../dialects/postgresql.html#postgresql-table-valued-overview"><span class="std std-ref">Table values, Table and Column valued functions, Row and Tuple objects</span></a> - in the <a class="reference internal" href="../dialects/postgresql.html"><span class="std std-ref">PostgreSQL</span></a> documentation.</p>
<p>While many databases support table valued and other special
forms, PostgreSQL tends to be where there is the most demand for these
features.   See this section for additional examples of PostgreSQL
syntaxes as well as additional features.</p>
</div>
<p>SQLAlchemy provides the <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.FunctionElement.table_valued" title="sqlalchemy.sql.functions.FunctionElement.table_valued"><code class="xref py py-meth docutils literal notranslate"><span class="pre">FunctionElement.table_valued()</span></code></a> method
as the basic “table valued function” construct, which will convert a
<a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.func" title="sqlalchemy.sql.expression.func"><code class="xref py py-data docutils literal notranslate"><span class="pre">func</span></code></a> object into a FROM clause containing a series of named
columns, based on string names passed positionally. This returns a
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.TableValuedAlias" title="sqlalchemy.sql.expression.TableValuedAlias"><code class="xref py py-class docutils literal notranslate"><span class="pre">TableValuedAlias</span></code></a> object, which is a function-enabled
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Alias" title="sqlalchemy.sql.expression.Alias"><code class="xref py py-class docutils literal notranslate"><span class="pre">Alias</span></code></a> construct that may be used as any other FROM clause as
introduced at <a class="reference internal" href="#tutorial-using-aliases"><span class="std std-ref">Using Aliases</span></a>. Below we illustrate the
<code class="docutils literal notranslate"><span class="pre">json_each()</span></code> function, which while common on PostgreSQL is also supported by
modern versions of SQLite:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">onetwothree</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">json_each</span><span class="p">(</span><span class="s1">&#39;[&quot;one&quot;, &quot;two&quot;, &quot;three&quot;]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">table_valued</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">onetwothree</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">onetwothree</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">in_</span><span class="p">([</span><span class="s2">&quot;two&quot;</span><span class="p">,</span> <span class="s2">&quot;three&quot;</span><span class="p">]))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>  
<span class="gp">... </span>    <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
<div class='show_sql'><span class="k">BEGIN</span> <span class="p">(</span><span class="k">implicit</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">anon_1</span><span class="p">.</span><span class="n">value</span>
<span class="k">FROM</span> <span class="n">json_each</span><span class="p">(</span><span class="o">?</span><span class="p">)</span> <span class="k">AS</span> <span class="n">anon_1</span>
<span class="k">WHERE</span> <span class="n">anon_1</span><span class="p">.</span><span class="n">value</span> <span class="k">IN</span> <span class="p">(</span><span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">)</span>
<span class="p">[...]</span> <span class="p">(</span><span class="s1">&#39;[&quot;one&quot;, &quot;two&quot;, &quot;three&quot;]&#39;</span><span class="p">,</span> <span class="s1">&#39;two&#39;</span><span class="p">,</span> <span class="s1">&#39;three&#39;</span><span class="p">)</span>
<span class="p">[(</span><span class="s1">&#39;two&#39;</span><span class="p">,),</span> <span class="p">(</span><span class="s1">&#39;three&#39;</span><span class="p">,)]</span>
<span class="k">ROLLBACK</span>
</div></pre></div>
</div>
<p>Above, we used the <code class="docutils literal notranslate"><span class="pre">json_each()</span></code> JSON function supported by SQLite and
PostgreSQL to generate a table valued expression with a single column referred
towards as <code class="docutils literal notranslate"><span class="pre">value</span></code>, and then selected two of its three rows.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../dialects/postgresql.html#postgresql-table-valued"><span class="std std-ref">Table-Valued Functions</span></a> - in the <a class="reference internal" href="../dialects/postgresql.html"><span class="std std-ref">PostgreSQL</span></a> documentation -
this section will detail additional syntaxes such as special column derivations
and “WITH ORDINALITY” that are known to work with PostgreSQL.</p>
</div>
</section>
<section id="column-valued-functions-table-valued-function-as-a-scalar-column">
<span id="tutorial-functions-column-valued"></span><h3>Column Valued Functions - Table Valued Function as a Scalar Column<a class="headerlink" href="#column-valued-functions-table-valued-function-as-a-scalar-column" title="Permalink to this headline">¶</a></h3>
<p>A special syntax supported by PostgreSQL and Oracle is that of referring
towards a function in the FROM clause, which then delivers itself as a
single column in the columns clause of a SELECT statement or other column
expression context.  PostgreSQL makes great use of this syntax for such
functions as <code class="docutils literal notranslate"><span class="pre">json_array_elements()</span></code>, <code class="docutils literal notranslate"><span class="pre">json_object_keys()</span></code>,
<code class="docutils literal notranslate"><span class="pre">json_each_text()</span></code>, <code class="docutils literal notranslate"><span class="pre">json_each()</span></code>, etc.</p>
<p>SQLAlchemy refers to this as a “column valued” function and is available
by applying the <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.FunctionElement.column_valued" title="sqlalchemy.sql.functions.FunctionElement.column_valued"><code class="xref py py-meth docutils literal notranslate"><span class="pre">FunctionElement.column_valued()</span></code></a> modifier
to a <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.Function" title="sqlalchemy.sql.functions.Function"><code class="xref py py-class docutils literal notranslate"><span class="pre">Function</span></code></a> construct:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">select</span><span class="p">,</span> <span class="n">func</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">json_array_elements</span><span class="p">(</span><span class="s1">&#39;[&quot;one&quot;, &quot;two&quot;]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">column_valued</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<span class="go">SELECT x</span>
<span class="go">FROM json_array_elements(:json_array_elements_1) AS x</span></pre></div>
</div>
<p>The “column valued” form is also supported by the Oracle dialect, where
it is usable for custom SQL functions:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.dialects</span> <span class="kn">import</span> <span class="n">oracle</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">scalar_strings</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">column_valued</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">stmt</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">dialect</span><span class="o">=</span><span class="n">oracle</span><span class="o">.</span><span class="n">dialect</span><span class="p">()))</span>
<span class="go">SELECT COLUMN_VALUE s</span>
<span class="go">FROM TABLE (scalar_strings(:scalar_strings_1)) s</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../dialects/postgresql.html#postgresql-column-valued"><span class="std std-ref">Column Valued Functions</span></a> - in the <a class="reference internal" href="../dialects/postgresql.html"><span class="std std-ref">PostgreSQL</span></a> documentation.</p>
</div>
</section>
</section>
</section>
<div class="topic">
<p class="topic-title">SQLAlchemy 1.4 / 2.0 Tutorial</p>
<p>Next Tutorial Section: <a class="reference internal" href="data_update.html"><span class="doc">Updating and Deleting Rows with Core</span></a></p>
</div>

    </div>

</div>

<div id="docs-bottom-navigation" class="docs-navigation-links, withsidebar">
        Previous:
        <a href="data_insert.html" title="previous chapter">Inserting Rows with Core</a>
        Next:
        <a href="data_update.html" title="next chapter">Updating and Deleting Rows with Core</a>

    <div id="docs-copyright">
        &copy; <a href="../copyright.html">Copyright</a> 2007-2021, the SQLAlchemy authors and contributors.


    <p><b>flambé!</b> the dragon and <b><i>The Alchemist</i></b> image designs created and generously donated by <a href="https://github.com/vmalloc">Rotem Yaari</a>.</p>

        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 4.1.2.
    </div>
</div>

</div>



        
        

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
          URL_ROOT:    '../',
          VERSION:     '1.4.23',
          COLLAPSE_MODINDEX: false,
          FILE_SUFFIX: '.html'
      };
    </script>

    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>

    <!-- begin iterate through sphinx environment script_files -->
        <script type="text/javascript" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    <!-- end iterate through sphinx environment script_files -->

    <script type="text/javascript" src="../_static/detectmobile.js"></script>
    <script type="text/javascript" src="../_static/init.js"></script>


    </body>
</html>


